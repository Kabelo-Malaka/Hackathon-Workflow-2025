# Story 4.1: Task Checklist Data Model

## Status
**Approved**

## Story

**As a** developer,
**I want** database schema to store checklist items for each task instance,
**so that** tech support and other users can verify every provisioned item with mandatory checkboxes.

## Acceptance Criteria

1. task_checklist_items table is created with columns: id (UUID), task_instance_id (FK), item_description, category (HARDWARE/SOFTWARE/ACCESS/OTHER), item_identifier (e.g., laptop serial, software license key), is_checked (boolean), checked_at, checked_by (FK users), created_at, updated_at
2. provisioned_items table is created for offboarding mirror: id (UUID), workflow_instance_id (FK), task_instance_id (FK), item_description, category, item_identifier, provisioned_at, provisioned_by (FK users)
3. Foreign key relationships properly defined with cascading deletes where appropriate
4. Indexes created on task_instance_id, workflow_instance_id, category
5. Default value for is_checked is false
6. Liquibase changelog with rollback support

## Tasks / Subtasks

- [ ] **Task 1: Create task_checklist_items table Liquibase changeset** (AC: 1, 5, 6)
  - [ ] Create new Liquibase changeset file: `backend/src/main/resources/db/changelog/changes/004-create-task-checklist-items-table.yaml`
  - [ ] Define table with UUID primary key column `id`
  - [ ] Add foreign key column `task_instance_id` (UUID, NOT NULL, references task_instances.id)
  - [ ] Add column `item_description` (VARCHAR(500), NOT NULL)
  - [ ] Add column `category` (item_category ENUM: HARDWARE, SOFTWARE, ACCESS, OTHER, NOT NULL)
  - [ ] Add column `item_identifier` (VARCHAR(255), nullable) - for serial numbers, license keys, etc.
  - [ ] Add column `is_checked` (BOOLEAN, NOT NULL, DEFAULT false)
  - [ ] Add column `checked_at` (TIMESTAMP, nullable)
  - [ ] Add foreign key column `checked_by` (UUID, nullable, references users.id)
  - [ ] Add audit columns: `created_at` (TIMESTAMP, NOT NULL, DEFAULT CURRENT_TIMESTAMP), `updated_at` (TIMESTAMP, NOT NULL, DEFAULT CURRENT_TIMESTAMP)
  - [ ] Define foreign key constraint with ON DELETE CASCADE for task_instance_id (if task deleted, checklist items deleted)
  - [ ] Define foreign key constraint with ON DELETE SET NULL for checked_by (if user deleted, preserve checklist record)
  - [ ] Add rollback section: DROP TABLE IF EXISTS task_checklist_items
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Liquibase changesets]

- [ ] **Task 2: Create provisioned_items table Liquibase changeset** (AC: 2, 6)
  - [ ] Create new Liquibase changeset file: `backend/src/main/resources/db/changelog/changes/005-create-provisioned-items-table.yaml`
  - [ ] Define table with UUID primary key column `id`
  - [ ] Add foreign key column `workflow_instance_id` (UUID, NOT NULL, references workflow_instances.id)
  - [ ] Add foreign key column `task_instance_id` (UUID, NOT NULL, references task_instances.id)
  - [ ] Add column `item_description` (VARCHAR(500), NOT NULL)
  - [ ] Add column `category` (item_category ENUM, NOT NULL)
  - [ ] Add column `item_identifier` (VARCHAR(255), nullable)
  - [ ] Add column `provisioned_at` (TIMESTAMP, NOT NULL)
  - [ ] Add foreign key column `provisioned_by` (UUID, NOT NULL, references users.id)
  - [ ] Define foreign key constraint with ON DELETE CASCADE for workflow_instance_id (if workflow deleted, provisioned items deleted)
  - [ ] Define foreign key constraint with ON DELETE CASCADE for task_instance_id
  - [ ] Define foreign key constraint with ON DELETE SET NULL for provisioned_by (preserve history even if user deleted)
  - [ ] Add rollback section: DROP TABLE IF EXISTS provisioned_items
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Offboarding mirror table]

- [ ] **Task 3: Create item_category ENUM type** (AC: 1, 2)
  - [ ] Create new Liquibase changeset file: `backend/src/main/resources/db/changelog/changes/003-create-item-category-enum.yaml`
  - [ ] Define PostgreSQL ENUM type `item_category` with values: 'HARDWARE', 'SOFTWARE', 'ACCESS', 'OTHER'
  - [ ] Use CREATE TYPE SQL statement
  - [ ] Add rollback section: DROP TYPE IF EXISTS item_category
  - [ ] Reference: [Source: docs/architecture/database-schema.md - PostgreSQL ENUMs]

- [ ] **Task 4: Create indexes for task_checklist_items** (AC: 4)
  - [ ] In changeset 004, add index on task_instance_id: `CREATE INDEX idx_task_checklist_items_task_instance_id ON task_checklist_items(task_instance_id)`
  - [ ] Add index on category for filtering: `CREATE INDEX idx_task_checklist_items_category ON task_checklist_items(category)`
  - [ ] Add composite index for common query pattern: `CREATE INDEX idx_task_checklist_items_task_checked ON task_checklist_items(task_instance_id, is_checked)`
  - [ ] Indexes improve query performance when fetching checklist items for a task or filtering by completion status
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Strategic indexes]

- [ ] **Task 5: Create indexes for provisioned_items** (AC: 4)
  - [ ] In changeset 005, add index on workflow_instance_id: `CREATE INDEX idx_provisioned_items_workflow_instance_id ON provisioned_items(workflow_instance_id)`
  - [ ] Add index on task_instance_id: `CREATE INDEX idx_provisioned_items_task_instance_id ON provisioned_items(task_instance_id)`
  - [ ] Add index on category: `CREATE INDEX idx_provisioned_items_category ON provisioned_items(category)`
  - [ ] Add composite index for offboarding mirror lookup: `CREATE INDEX idx_provisioned_items_workflow_category ON provisioned_items(workflow_instance_id, category)`
  - [ ] These indexes are critical for offboarding mirror feature (Story 4.7) to efficiently retrieve items provisioned during onboarding
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Strategic indexes for offboarding mirror]

- [ ] **Task 6: Update db.changelog-master.yaml to include new changesets** (AC: 6)
  - [ ] Open `backend/src/main/resources/db/changelog/db.changelog-master.yaml`
  - [ ] Add include statements for new changesets in correct order:
    - `- include: { file: changes/003-create-item-category-enum.yaml }`
    - `- include: { file: changes/004-create-task-checklist-items-table.yaml }`
    - `- include: { file: changes/005-create-provisioned-items-table.yaml }`
  - [ ] Ensure changesets are ordered after existing task_instances table creation (dependencies must be created first)
  - [ ] Liquibase will apply changesets in order on next application startup
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Liquibase changelog master file]

- [ ] **Task 7: Create TaskChecklistItem JPA entity** (AC: 1)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/entity/TaskChecklistItem.java`
  - [ ] Use `@Entity` annotation with `@Table(name = "task_checklist_items")`
  - [ ] Add `@Data` and `@NoArgsConstructor` and `@AllArgsConstructor` Lombok annotations (entities only per coding standards)
  - [ ] Define fields matching database columns:
    - `@Id @GeneratedValue private UUID id`
    - `@Column(name = "task_instance_id") private UUID taskInstanceId`
    - `@Column(name = "item_description", nullable = false) private String itemDescription`
    - `@Enumerated(EnumType.STRING) @Column(nullable = false) private ItemCategory category`
    - `@Column(name = "item_identifier") private String itemIdentifier`
    - `@Column(name = "is_checked", nullable = false) private Boolean isChecked = false`
    - `@Column(name = "checked_at") private LocalDateTime checkedAt`
    - `@Column(name = "checked_by") private UUID checkedBy`
    - `@Column(name = "created_at", nullable = false, updatable = false) private LocalDateTime createdAt`
    - `@Column(name = "updated_at", nullable = false) private LocalDateTime updatedAt`
  - [ ] Add `@PrePersist` method to set createdAt and updatedAt on insert
  - [ ] Add `@PreUpdate` method to update updatedAt on modification
  - [ ] Reference: [Source: docs/architecture/coding-standards.md - Lombok for entities only]

- [ ] **Task 8: Create ProvisionedItem JPA entity** (AC: 2)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/entity/ProvisionedItem.java`
  - [ ] Use `@Entity` annotation with `@Table(name = "provisioned_items")`
  - [ ] Add Lombok annotations: `@Data`, `@NoArgsConstructor`, `@AllArgsConstructor`
  - [ ] Define fields matching database columns:
    - `@Id @GeneratedValue private UUID id`
    - `@Column(name = "workflow_instance_id", nullable = false) private UUID workflowInstanceId`
    - `@Column(name = "task_instance_id", nullable = false) private UUID taskInstanceId`
    - `@Column(name = "item_description", nullable = false) private String itemDescription`
    - `@Enumerated(EnumType.STRING) @Column(nullable = false) private ItemCategory category`
    - `@Column(name = "item_identifier") private String itemIdentifier`
    - `@Column(name = "provisioned_at", nullable = false) private LocalDateTime provisionedAt`
    - `@Column(name = "provisioned_by", nullable = false) private UUID provisionedBy`
  - [ ] Add `@PrePersist` method to set provisionedAt to current timestamp if not already set
  - [ ] This entity is critical for the offboarding mirror feature (Story 4.7)
  - [ ] Reference: [Source: docs/architecture/data-models.md#ProvisionedItem - Offboarding mirror entity]

- [ ] **Task 9: Create ItemCategory enum** (AC: 1, 2)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/enums/ItemCategory.java`
  - [ ] Define enum with values: HARDWARE, SOFTWARE, ACCESS, OTHER
  - [ ] Enum values must match database ENUM type exactly (case-sensitive)
  - [ ] Add Javadoc comments explaining each category:
    - HARDWARE: Physical items (laptops, monitors, badges)
    - SOFTWARE: Software licenses and subscriptions
    - ACCESS: System accounts and access permissions
    - OTHER: Miscellaneous items not fitting other categories
  - [ ] Reference: [Source: docs/architecture/database-schema.md - PostgreSQL ENUM types]

- [ ] **Task 10: Create TaskChecklistItemRepository interface** (AC: 1)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/repository/TaskChecklistItemRepository.java`
  - [ ] Extend `JpaRepository<TaskChecklistItem, UUID>`
  - [ ] Add custom query method: `List<TaskChecklistItem> findByTaskInstanceId(UUID taskInstanceId)`
  - [ ] Add custom query method: `Long countByTaskInstanceIdAndIsChecked(UUID taskInstanceId, Boolean isChecked)`
  - [ ] Add custom query method: `List<TaskChecklistItem> findByTaskInstanceIdAndCategory(UUID taskInstanceId, ItemCategory category)`
  - [ ] Spring Data JPA will automatically implement these methods based on naming convention
  - [ ] Reference: [Source: docs/architecture/coding-standards.md - All database queries via repositories]

- [ ] **Task 11: Create ProvisionedItemRepository interface** (AC: 2)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/repository/ProvisionedItemRepository.java`
  - [ ] Extend `JpaRepository<ProvisionedItem, UUID>`
  - [ ] Add custom query method: `List<ProvisionedItem> findByWorkflowInstanceId(UUID workflowInstanceId)`
  - [ ] Add custom query method: `List<ProvisionedItem> findByWorkflowInstanceIdAndCategory(UUID workflowInstanceId, ItemCategory category)`
  - [ ] Add custom query method: `List<ProvisionedItem> findByTaskInstanceId(UUID taskInstanceId)`
  - [ ] These queries are essential for the offboarding mirror feature to retrieve items by workflow and category
  - [ ] Reference: [Source: docs/architecture/source-tree.md - repository/ package]

- [ ] **Task 12: Write unit tests for TaskChecklistItemRepository** (AC: 1, 6)
  - [ ] Create test file: `backend/src/test/java/com/magnab/employeelifecycle/repository/TaskChecklistItemRepositoryTest.java`
  - [ ] Use `@DataJpaTest` annotation for repository testing
  - [ ] Use `@Testcontainers` with PostgreSQL container for real database testing
  - [ ] Test: `findByTaskInstanceId_ReturnsChecklistItems()` - Create task and checklist items, verify query returns correct items
  - [ ] Test: `countByTaskInstanceIdAndIsChecked_ReturnsCorrectCount()` - Verify count of checked vs unchecked items
  - [ ] Test: `findByTaskInstanceIdAndCategory_FiltersCorrectly()` - Verify category filtering works
  - [ ] Test: `save_SetsDefaultValues()` - Verify is_checked defaults to false, timestamps are set
  - [ ] Verify foreign key constraints are enforced (cascade delete when task deleted)
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - TestContainers integration tests]

- [ ] **Task 13: Write unit tests for ProvisionedItemRepository** (AC: 2, 6)
  - [ ] Create test file: `backend/src/test/java/com/magnab/employeelifecycle/repository/ProvisionedItemRepositoryTest.java`
  - [ ] Use `@DataJpaTest` annotation
  - [ ] Use `@Testcontainers` with PostgreSQL 17-alpine container
  - [ ] Test: `findByWorkflowInstanceId_ReturnsProvisionedItems()` - Verify query retrieves all items for workflow
  - [ ] Test: `findByWorkflowInstanceIdAndCategory_FiltersCorrectly()` - Verify category filtering for offboarding mirror
  - [ ] Test: `findByTaskInstanceId_ReturnsProvisionedItems()` - Verify retrieval by task
  - [ ] Test: `save_SetsProvisionedAt()` - Verify timestamp is set automatically
  - [ ] Verify foreign key constraints with workflow and task
  - [ ] These tests ensure the offboarding mirror data model works correctly
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Repository tests]

- [ ] **Task 14: Verify Liquibase migrations apply successfully** (AC: 6)
  - [ ] Start Spring Boot application locally: `mvn spring-boot:run` or run from IDE
  - [ ] Check application logs for Liquibase migration messages
  - [ ] Verify no errors during changeset application
  - [ ] Connect to PostgreSQL database and verify tables exist:
    - `SELECT * FROM databasechangelog WHERE id LIKE '%task-checklist%' OR id LIKE '%provisioned-items%'`
    - `\d task_checklist_items` (describe table structure)
    - `\d provisioned_items` (describe table structure)
  - [ ] Verify ENUM type created: `SELECT enum_range(NULL::item_category)`
  - [ ] Verify indexes created: `\di task_checklist_items*` and `\di provisioned_items*`
  - [ ] Verify foreign key constraints exist
  - [ ] Test rollback: `mvn liquibase:rollback -Dliquibase.rollbackCount=3` (rolls back the 3 new changesets)
  - [ ] Verify tables and ENUM type are dropped
  - [ ] Re-apply migrations: `mvn spring-boot:run` (or restart app)
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Migration workflow]

## Dev Notes

### Previous Story Context

**Epic 3 Stories Completed:**
- Story 3.1: Workflow Instance Data Model created workflow_instances and task_instances tables
- Story 3.2: Workflow Instantiation Service creates workflow instances from templates
- Story 3.3: Task Assignment & Routing Logic assigns tasks to users based on roles
- Story 3.4: Workflow State Management manages workflow and task state transitions

**Key Dependencies:**
- `task_instances` table exists (from Story 3.1) - required foreign key for task_checklist_items
- `workflow_instances` table exists (from Story 3.1) - required foreign key for provisioned_items
- `users` table exists (from Story 1.3) - required foreign key for checked_by and provisioned_by

**Integration Points:**
- Story 4.2 (Task Completion Service) will use TaskChecklistItem entity to validate all items are checked before completion
- Story 4.7 (Offboarding Mirror) will use ProvisionedItem entity to automatically populate offboarding checklists

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Backend Framework:**
- Spring Boot 3.2.2
- Java 17 LTS
- Hibernate 6.4.2 (via Spring Data JPA)
- Maven 3.9.6

**Database:**
- PostgreSQL 17.2
- Liquibase 4.25.1 for schema migrations
- HikariCP 5.1.0 for connection pooling

**Testing:**
- JUnit 5 (5.10.1) for unit tests
- TestContainers 1.19.3 for integration tests with real PostgreSQL
- `@DataJpaTest` for repository testing with test database

**Key Dependencies:**
- Lombok 1.18.30 (entities only per coding standards)
- Jakarta Bean Validation 3.0.2

### Data Models
[Source: docs/architecture/data-models.md]

**TaskChecklistItem Entity:**
- Primary key: UUID id
- Foreign keys: taskInstanceId (TaskInstance), checkedBy (User, nullable)
- Core fields: itemDescription, category (ENUM), itemIdentifier (optional)
- Verification fields: isChecked (Boolean, default false), checkedAt (Timestamp)
- Audit: createdAt, updatedAt

**ProvisionedItem Entity (Critical for Offboarding Mirror):**
- Primary key: UUID id
- Foreign keys: workflowInstanceId (WorkflowInstance), taskInstanceId (TaskInstance), provisionedBy (User)
- Core fields: itemDescription, category (ENUM), itemIdentifier (optional)
- Provisioning tracking: provisionedAt (Timestamp)
- Purpose: Records all items provisioned during onboarding for automatic inclusion in offboarding checklists

**ItemCategory Enum:**
- Values: HARDWARE, SOFTWARE, ACCESS, OTHER
- Used by both TaskChecklistItem and ProvisionedItem
- Enables filtering and categorization for offboarding mirror feature

**Relationships:**
- TaskChecklistItem → TaskInstance (Many-to-One)
- ProvisionedItem → WorkflowInstance (Many-to-One)
- ProvisionedItem → TaskInstance (Many-to-One)
- Both entities → User (Many-to-One for audit fields)

### Database Schema Design
[Source: docs/architecture/database-schema.md]

**Key Design Principles:**
- **UUID Primary Keys:** Globally unique, prevents ID guessing, distributed-safe
- **PostgreSQL ENUMs:** Type safety at database level for item_category
- **Audit Columns:** created_at, updated_at on task_checklist_items
- **Foreign Key Constraints:** All relationships enforced at database level
- **Cascade Deletes:** ON DELETE CASCADE for task_instance_id (if task deleted, checklist items deleted)
- **Strategic Indexes:** On task_instance_id, workflow_instance_id, category for query performance

**Liquibase Changeset Ordering:**
1. Existing changesets create users, workflow_instances, task_instances tables
2. New changeset 003: Create item_category ENUM type
3. New changeset 004: Create task_checklist_items table (depends on task_instances and item_category)
4. New changeset 005: Create provisioned_items table (depends on workflow_instances, task_instances, item_category)

**Rollback Support:**
- Each changeset includes rollback section (DROP TABLE IF EXISTS)
- Rollback command: `mvn liquibase:rollback -Dliquibase.rollbackCount=N`
- Safe to rollback during development; production requires careful planning

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Entity Development Rules:**
- Use `@Entity` annotation with `@Table(name = "...")` to map to database table
- Use Lombok `@Data`, `@NoArgsConstructor`, `@AllArgsConstructor` for entities (entities only, not DTOs)
- Use `@PrePersist` and `@PreUpdate` lifecycle callbacks for audit field management
- Use `@Enumerated(EnumType.STRING)` for enum fields (never use ordinal)
- Use `@Column` annotations to explicitly map fields to database columns
- UUID fields use `@GeneratedValue` with default UUID strategy

**Repository Development Rules:**
- Extend `JpaRepository<Entity, UUID>`
- Use Spring Data JPA naming conventions for query methods (findBy..., countBy...)
- No direct EntityManager use (use repository abstractions)
- All database queries via repositories (no native SQL unless absolutely necessary)

**Naming Conventions:**
- Entities: Singular nouns (TaskChecklistItem, ProvisionedItem)
- Repositories: EntityRepository pattern (TaskChecklistItemRepository, ProvisionedItemRepository)
- Tables: Snake_case plural (task_checklist_items, provisioned_items)
- Columns: Snake_case (item_description, is_checked, checked_at)

### File Locations
[Source: docs/architecture/source-tree.md]

**New Files to Create:**
```
backend/src/
├── main/
│   ├── java/com/magnab/employeelifecycle/
│   │   ├── entity/
│   │   │   ├── TaskChecklistItem.java           # CREATE - JPA entity
│   │   │   └── ProvisionedItem.java              # CREATE - JPA entity
│   │   ├── enums/
│   │   │   └── ItemCategory.java                 # CREATE - Enum definition
│   │   └── repository/
│   │       ├── TaskChecklistItemRepository.java  # CREATE - Repository interface
│   │       └── ProvisionedItemRepository.java    # CREATE - Repository interface
│   └── resources/
│       └── db/changelog/changes/
│           ├── 003-create-item-category-enum.yaml        # CREATE - Liquibase changeset
│           ├── 004-create-task-checklist-items-table.yaml # CREATE - Liquibase changeset
│           └── 005-create-provisioned-items-table.yaml   # CREATE - Liquibase changeset
└── test/java/com/magnab/employeelifecycle/
    └── repository/
        ├── TaskChecklistItemRepositoryTest.java  # CREATE - Repository tests
        └── ProvisionedItemRepositoryTest.java    # CREATE - Repository tests
```

**Files to Modify:**
- `backend/src/main/resources/db/changelog/db.changelog-master.yaml` - Add include statements for new changesets

**Existing Files to Reference (DO NOT MODIFY):**
- Entity classes: TaskInstance, WorkflowInstance, User (from previous stories)
- Repository interfaces: TaskInstanceRepository, WorkflowInstanceRepository, UserRepository

### Liquibase Best Practices
[Source: docs/architecture/database-schema.md]

**Changeset Structure:**
```yaml
databaseChangeLog:
  - changeSet:
      id: 004-create-task-checklist-items-table
      author: dev-agent
      changes:
        - createTable:
            tableName: task_checklist_items
            columns:
              - column:
                  name: id
                  type: uuid
                  constraints:
                    primaryKey: true
                    nullable: false
              # ... other columns
        - createIndex:
            indexName: idx_task_checklist_items_task_instance_id
            tableName: task_checklist_items
            columns:
              - column:
                  name: task_instance_id
      rollback:
        - dropTable:
            tableName: task_checklist_items
```

**ENUM Type Creation:**
```yaml
- changeSet:
    id: 003-create-item-category-enum
    author: dev-agent
    changes:
      - sql:
          sql: CREATE TYPE item_category AS ENUM ('HARDWARE', 'SOFTWARE', 'ACCESS', 'OTHER')
    rollback:
      - sql:
          sql: DROP TYPE IF EXISTS item_category
```

**Foreign Key Constraints:**
```yaml
- addForeignKeyConstraint:
    baseTableName: task_checklist_items
    baseColumnNames: task_instance_id
    referencedTableName: task_instances
    referencedColumnNames: id
    constraintName: fk_checklist_task_instance
    onDelete: CASCADE
```

### Offboarding Mirror Feature Context
[Source: PRD Story 4.7]

**Critical Security Feature:**
The provisioned_items table is the foundation for the "offboarding mirror" feature, a key differentiator of this system. When a task is completed during onboarding, all checked items are copied from task_checklist_items to provisioned_items. During offboarding, the system retrieves these provisioned items by workflow_instance_id and pre-populates offboarding task checklists, ensuring perfect symmetry and eliminating orphaned accounts/equipment.

**Why This Matters:**
- Current manual process results in forgotten accounts (MS 365, GitHub, SharePoint, Teams) and uncollected equipment
- Automated mirror ensures 100% coverage of all provisioned items during offboarding
- Category field enables smart routing (ACCESS items → account deprovisioning task, HARDWARE items → equipment collection task)

**Implementation in Future Stories:**
- Story 4.2: TaskService.completeTask() will copy checked items to provisioned_items
- Story 4.7: Offboarding workflow initiation will query provisioned_items and pre-populate checklists

### Project Structure Alignment
[Source: docs/architecture/source-tree.md]

All file paths align with the defined source tree structure:
- Entities in `backend/src/main/java/com/magnab/employeelifecycle/entity/`
- Repositories in `backend/src/main/java/com/magnab/employeelifecycle/repository/`
- Enums in `backend/src/main/java/com/magnab/employeelifecycle/enums/`
- Liquibase changesets in `backend/src/main/resources/db/changelog/changes/`
- Repository tests in `backend/src/test/java/com/magnab/employeelifecycle/repository/`

No structural conflicts or deviations from architecture guidelines.

## Testing

### Testing Approach for This Story
[Source: docs/architecture/test-strategy.md]

**Repository Integration Tests (TestContainers):**
- Test file location: `backend/src/test/java/com/magnab/employeelifecycle/repository/`
- Use `@DataJpaTest` for repository-focused testing
- Use `@Testcontainers` with PostgreSQL 17-alpine container
- Use `@Container static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:17.2-alpine")`

**Test Coverage Goals:**
- Repository query methods: 100% (all findBy... and countBy... methods tested)
- Entity creation and persistence: 100% (verify default values, timestamps, foreign keys)
- Foreign key constraints: 100% (verify CASCADE and SET NULL behavior)
- Liquibase migrations: Manual verification (startup logs, database inspection)

**Example Repository Test Structure:**
```java
@DataJpaTest
@Testcontainers
class TaskChecklistItemRepositoryTest {
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:17.2-alpine");

    @Autowired
    private TaskChecklistItemRepository checklistRepo;
    @Autowired
    private TaskInstanceRepository taskRepo;

    @Test
    void findByTaskInstanceId_ReturnsChecklistItems() {
        // Arrange: Create task instance and checklist items
        TaskInstance task = createTestTaskInstance();
        taskRepo.save(task);

        TaskChecklistItem item1 = new TaskChecklistItem();
        item1.setTaskInstanceId(task.getId());
        item1.setItemDescription("Laptop serial ABC123");
        item1.setCategory(ItemCategory.HARDWARE);
        item1.setIsChecked(false);
        checklistRepo.save(item1);

        // Act: Query by task instance ID
        List<TaskChecklistItem> items = checklistRepo.findByTaskInstanceId(task.getId());

        // Assert: Verify results
        assertThat(items).hasSize(1);
        assertThat(items.get(0).getItemDescription()).isEqualTo("Laptop serial ABC123");
        assertThat(items.get(0).getCategory()).isEqualTo(ItemCategory.HARDWARE);
        assertThat(items.get(0).getIsChecked()).isFalse();
    }

    @Test
    void countByTaskInstanceIdAndIsChecked_ReturnsCorrectCount() {
        // Test counting checked vs unchecked items
    }

    @Test
    void save_SetsDefaultValues() {
        // Verify is_checked defaults to false, timestamps are set
    }
}
```

**Manual Testing Steps:**
1. Run `mvn spring-boot:run` to start application
2. Check logs for Liquibase migration messages (no errors)
3. Connect to PostgreSQL: `docker exec -it <container> psql -U <user> -d <database>`
4. Verify tables: `\dt` (should show task_checklist_items and provisioned_items)
5. Verify ENUM: `SELECT enum_range(NULL::item_category)` (should show HARDWARE, SOFTWARE, ACCESS, OTHER)
6. Verify indexes: `\di task_checklist_items*` and `\di provisioned_items*`
7. Test rollback: `mvn liquibase:rollback -Dliquibase.rollbackCount=3`
8. Verify tables dropped: `\dt` (should NOT show task_checklist_items or provisioned_items)
9. Re-apply: `mvn spring-boot:run` (migrations re-applied)

**Coverage Verification:**
- Run: `mvn test jacoco:report`
- Check: `backend/target/site/jacoco/index.html`
- Goal: 80% coverage for repository layer (this story focuses on data model, not service logic)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.1 | Story validated and approved. Comprehensive validation completed: template compliance verified, all 6 ACs covered with 100% task mapping, anti-hallucination verification passed (40+ source references validated), implementation readiness confirmed (10/10 score). Zero critical issues found. Status updated from Draft to Approved. | Sarah (Product Owner) |
| 2025-10-31 | 1.0 | Story created from Epic 4 with complete data model specification for task checklist and offboarding mirror. Includes Liquibase changesets, JPA entities, repositories, comprehensive testing requirements. Foundation for mandatory checklist verification (Story 4.2) and automated offboarding mirror (Story 4.7). | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
