# Story 1.6: Frontend Authentication UI & Routing

## Status
**Approved**

## Story

**As a** user (any role),
**I want** a login page and protected routing in the frontend,
**so that** I can authenticate and access role-appropriate pages while being redirected to login if not authenticated.

## Acceptance Criteria

1. Login page is created with form fields for username and password
2. Login form submits credentials to backend /api/auth/login endpoint
3. Successful login stores authentication state in Redux and redirects to dashboard
4. Failed login displays error message to user
5. React Router is configured with protected routes that require authentication
6. Unauthenticated users attempting to access protected routes are redirected to login page
7. Logout button exists in navigation header and calls /api/auth/logout endpoint
8. Frontend includes basic navigation structure (header with app name and logout button)
9. Authentication state persists across page refreshes (check session with backend on app load)
10. Material-UI components are used for login form and layout

## Tasks / Subtasks

- [ ] **Task 1: Setup React Router with protected routes** (AC: 5, 6)
  - [ ] Install react-router-dom v6.21.3 via npm
  - [ ] Create App.tsx with BrowserRouter and route configuration
  - [ ] Define routes: /login (public), /dashboard (protected), /users (protected), /tasks (protected)
  - [ ] Create ProtectedRoute component that checks auth state and redirects to /login if unauthenticated
  - [ ] Implement route guard logic using authSlice state

- [ ] **Task 2: Create Redux auth slice and API** (AC: 3, 9)
  - [ ] Create frontend/src/features/auth/authSlice.ts with Redux Toolkit
  - [ ] Define auth state: { user: UserResponse | null, isAuthenticated: boolean, isLoading: boolean }
  - [ ] Create frontend/src/features/auth/authApi.ts using RTK Query
  - [ ] Define login mutation: POST /api/auth/login with LoginRequest body
  - [ ] Define logout mutation: POST /api/auth/logout
  - [ ] Define checkSession query: GET /api/auth/me to verify active session
  - [ ] Implement authSlice reducers for setUser, clearUser, setLoading

- [ ] **Task 3: Create Login page component** (AC: 1, 2, 4, 10)
  - [ ] Create frontend/src/components/auth/LoginPage.tsx
  - [ ] Use MUI Container, Paper, TextField, Button components
  - [ ] Add username and password input fields with controlled state
  - [ ] Implement form validation (required fields)
  - [ ] Add "Login" button that dispatches login mutation
  - [ ] Display error message using MUI Alert component on failed login
  - [ ] Show loading spinner during login request
  - [ ] Redirect to /dashboard on successful login

- [ ] **Task 4: Create AppLayout with navigation header** (AC: 7, 8)
  - [ ] Create frontend/src/components/common/AppLayout.tsx
  - [ ] Use MUI AppBar, Toolbar, Typography, Button components
  - [ ] Display app name "Employee Lifecycle Management" in header
  - [ ] Add Logout button in top-right that calls logout mutation
  - [ ] Implement logout handler that clears auth state and redirects to /login
  - [ ] Wrap protected routes with AppLayout component

- [ ] **Task 5: Implement session persistence** (AC: 9)
  - [ ] In App.tsx, dispatch checkSession query on component mount
  - [ ] If checkSession succeeds, populate auth state with user data
  - [ ] If checkSession fails (401), clear auth state and redirect to login
  - [ ] Show loading screen while checking session on initial page load

- [ ] **Task 6: Manual testing of authentication flow** (AC: 1-10)
  - [ ] Start frontend with npm run dev and backend with docker-compose up
  - [ ] Test: Navigate to /login, verify login form displays
  - [ ] Test: Submit login with valid credentials, verify redirect to /dashboard
  - [ ] Test: Submit login with invalid credentials, verify error message displays
  - [ ] Test: Navigate to /dashboard while authenticated, verify access granted
  - [ ] Test: Navigate to /dashboard while unauthenticated, verify redirect to /login
  - [ ] Test: Click Logout button, verify redirect to /login and session cleared
  - [ ] Test: Refresh page while authenticated, verify session persists
  - [ ] Test: Refresh page after logout, verify still on /login page
  - [ ] Verify all Material-UI components render correctly

## Dev Notes

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Frontend Technologies for Story 1.6:**
- **Framework:** React 18.2.0 with TypeScript 5.3.3
- **State Management:** Redux Toolkit 2.1.0 for global auth state
- **API Client:** RTK Query 2.1.0 for data fetching
- **UI Components:** Material-UI (MUI) 5.15.7
- **Routing:** React Router v6 (install react-router-dom v6.21.3)
- **Build Tool:** Vite 5.0.12

### Source Tree Structure
[Source: docs/architecture/source-tree.md]

**File Locations for Story 1.6:**
```
frontend/src/
├── components/
│   ├── auth/
│   │   └── LoginPage.tsx           # CREATE - Login form component
│   ├── common/
│   │   ├── AppLayout.tsx           # CREATE - Navigation header layout
│   │   └── ProtectedRoute.tsx      # CREATE - Route guard component
├── features/
│   └── auth/
│       ├── authSlice.ts            # CREATE - Redux auth state
│       └── authApi.ts              # CREATE - RTK Query auth API
├── App.tsx                         # MODIFY - Add router configuration
├── main.tsx                        # EXISTS - Entry point
└── store.ts                        # MODIFY - Register authSlice
```

### Backend API Endpoints
[Source: docs/architecture/rest-api-spec.md, docs/stories/1.4.story.md]

**Authentication Endpoints (already implemented in Story 1.4):**

**POST /api/auth/login**
- Request: `{"username": "string", "password": "string"}`
- Response 200: `{"token": "string", "user": {"id": "uuid", "username": "string", "email": "string", "role": "string"}}`
- Response 401: `{"timestamp": "ISO8601", "status": 401, "error": "Unauthorized", "message": "Invalid credentials"}`
- Creates HTTP session with JSESSIONID cookie (15-minute timeout)

**POST /api/auth/logout**
- Response 200: `{"message": "Logout successful"}`
- Invalidates HTTP session

**GET /api/auth/me** (for session check)
- Response 200: `{"id": "uuid", "username": "string", "email": "string", "role": "string"}`
- Response 401: `{"timestamp": "ISO8601", "status": 401, "error": "Unauthorized", "message": "No active session"}`

### Redux and RTK Query Setup
[Source: docs/prd.md - Technical Assumptions]

**Redux Store Configuration:**
```typescript
// store.ts
import { configureStore } from '@reduxjs/toolkit';
import { authApi } from './features/auth/authApi';
import authReducer from './features/auth/authSlice';

export const store = configureStore({
  reducer: {
    auth: authReducer,
    [authApi.reducerPath]: authApi.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(authApi.middleware),
});

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

**Auth Slice Example:**
```typescript
// features/auth/authSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';

interface UserResponse {
  id: string;
  username: string;
  email: string;
  role: string;
}

interface AuthState {
  user: UserResponse | null;
  isAuthenticated: boolean;
  isLoading: boolean;
}

const initialState: AuthState = {
  user: null,
  isAuthenticated: false,
  isLoading: true,
};

const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {
    setUser: (state, action: PayloadAction<UserResponse>) => {
      state.user = action.payload;
      state.isAuthenticated = true;
      state.isLoading = false;
    },
    clearUser: (state) => {
      state.user = null;
      state.isAuthenticated = false;
      state.isLoading = false;
    },
    setLoading: (state, action: PayloadAction<boolean>) => {
      state.isLoading = action.payload;
    },
  },
});

export const { setUser, clearUser, setLoading } = authSlice.actions;
export default authSlice.reducer;
```

**RTK Query Auth API Example:**
```typescript
// features/auth/authApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';

export const authApi = createApi({
  reducerPath: 'authApi',
  baseQuery: fetchBaseQuery({
    baseUrl: 'http://localhost:8080/api',
    credentials: 'include', // Important: sends session cookie
  }),
  endpoints: (builder) => ({
    login: builder.mutation({
      query: (credentials) => ({
        url: '/auth/login',
        method: 'POST',
        body: credentials,
      }),
    }),
    logout: builder.mutation({
      query: () => ({
        url: '/auth/logout',
        method: 'POST',
      }),
    }),
    checkSession: builder.query({
      query: () => '/auth/me',
    }),
  }),
});

export const { useLoginMutation, useLogoutMutation, useCheckSessionQuery } = authApi;
```

### React Router Protected Routes Pattern
[Source: docs/prd.md - Story 1.6 AC]

**ProtectedRoute Component Example:**
```typescript
// components/common/ProtectedRoute.tsx
import { Navigate } from 'react-router-dom';
import { useSelector } from 'react-redux';
import { RootState } from '../../store';

interface ProtectedRouteProps {
  children: React.ReactNode;
}

export const ProtectedRoute: React.FC<ProtectedRouteProps> = ({ children }) => {
  const { isAuthenticated, isLoading } = useSelector((state: RootState) => state.auth);

  if (isLoading) {
    return <div>Loading...</div>; // Or a proper loading component
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  return <>{children}</>;
};
```

### Material-UI Components to Use
[Source: docs/prd.md - UI Component Library]

**Login Page Components:**
- `Container` - Page wrapper with max-width
- `Paper` - Card-like surface for form
- `TextField` - Input fields with labels
- `Button` - Submit button
- `Alert` - Error message display
- `CircularProgress` - Loading spinner
- `Typography` - Text and headings

**AppLayout Components:**
- `AppBar` - Top navigation bar
- `Toolbar` - Container for header content
- `Typography` - App name display
- `Button` - Logout button
- `Box` - Layout container

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Frontend Standards:**
- Use ESLint + Prettier for code formatting
- TypeScript strict mode enabled
- Functional components with hooks (no class components)
- Use Redux Toolkit for state management (no legacy Redux)
- Use RTK Query for API calls (no axios or fetch directly)
- Component files use PascalCase (LoginPage.tsx)
- Feature slices use camelCase (authSlice.ts)

### Session Management
[Source: docs/prd.md - Story 1.4]

**Key Session Details:**
- Session-based authentication (not JWT)
- 15-minute inactivity timeout
- JSESSIONID cookie (HttpOnly, Secure in production)
- CSRF protection enabled on backend
- Must include `credentials: 'include'` in fetch requests to send session cookie

## Testing

### Testing Approach for This Story
[Source: docs/architecture/test-strategy.md, docs/prd.md - Story 1.8]

**Important Note:** Story 1.8 will set up the complete testing framework with Jest and React Testing Library. For Story 1.6, testing is **manual verification only** via browser:

**Manual Testing Steps:**

1. **Login Page Display:**
   - Navigate to http://localhost:3000/login
   - Verify login form displays with username and password fields
   - Verify Material-UI styling is applied correctly

2. **Successful Login:**
   - Enter valid credentials (admin user from Story 1.4)
   - Click "Login" button
   - Verify redirect to /dashboard
   - Verify navigation header displays with app name and Logout button
   - Verify no error messages displayed

3. **Failed Login:**
   - Navigate to /login
   - Enter invalid credentials
   - Click "Login" button
   - Verify error message displays: "Invalid credentials" or similar
   - Verify still on /login page

4. **Protected Route Access (Authenticated):**
   - While logged in, navigate to /dashboard
   - Verify page loads successfully
   - Navigate to /users (if route exists)
   - Verify page loads successfully

5. **Protected Route Access (Unauthenticated):**
   - Clear browser cookies or use incognito mode
   - Navigate to /dashboard
   - Verify automatic redirect to /login

6. **Logout Functionality:**
   - Log in successfully
   - Click Logout button in header
   - Verify redirect to /login
   - Verify session cleared (attempt to navigate to /dashboard should redirect to /login)

7. **Session Persistence:**
   - Log in successfully
   - Refresh page (F5 or Ctrl+R)
   - Verify still authenticated (stays on protected page)
   - Verify header displays correctly

8. **Session Expiry:**
   - Log in successfully
   - Wait 15 minutes (or adjust backend timeout for testing)
   - Attempt to navigate to protected route
   - Verify redirect to /login due to expired session

9. **Cross-browser Testing:**
   - Test on Chrome (latest)
   - Test on Firefox (latest)
   - Verify consistent behavior

**Automated Testing:** Will be added in Story 1.8 with Jest and React Testing Library for component and integration tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Story created from Epic 1 with streamlined architecture context for fast-track development | Bob (Scrum Master) |
| 2025-10-30 | 1.1 | Story validated and approved for implementation (Readiness Score: 9.5/10, HIGH confidence, zero hallucinations) | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
