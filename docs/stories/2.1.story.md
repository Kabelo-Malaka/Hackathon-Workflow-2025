# Story 2.1: Workflow Template Data Model

## Status
**Approved**

## Story

**As a** developer,
**I want** the database schema for workflow templates and tasks defined with Liquibase migrations,
**so that** templates can store task sequences, role assignments, and dependencies.

## Acceptance Criteria

1. workflow_templates table is created with columns: id (UUID), name, description, type (ONBOARDING/OFFBOARDING), is_active, created_at, created_by, updated_at, updated_by
2. template_tasks table is created with columns: id (UUID), template_id (FK), task_name, description, assigned_role, sequence_order, is_parallel, dependency_task_id (FK, nullable), created_at, updated_at
3. ~~template_custom_fields table is created~~ ðŸ”® **DEFERRED TO PHASE 2**
4. ~~template_conditional_rules table is created~~ ðŸ”® **DEFERRED TO PHASE 2**
5. Foreign key relationships are properly defined with ON DELETE CASCADE where appropriate
6. Indexes are created on template_id, assigned_role, sequence_order
7. Sample seed data includes at least one basic onboarding template for testing
8. Liquibase changelog documents the schema with rollback support

## Tasks / Subtasks

- [ ] **Task 1: Create Liquibase changeset for workflow_status and workflow_type enums** (AC: 1)
  - [ ] Create new changeset in `backend/src/main/resources/db/changelog/db.changelog-master.yaml`
  - [ ] Define `workflow_type` enum with values: ONBOARDING, OFFBOARDING
  - [ ] Define `workflow_status` enum with values: INITIATED, IN_PROGRESS, BLOCKED, COMPLETED (for future use in Epic 3)
  - [ ] Add rollback section to drop enum types
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Key Design Decisions]

- [ ] **Task 2: Create Liquibase changeset for workflow_templates table** (AC: 1, 5, 8)
  - [ ] Add changeset to `db.changelog-master.yaml` with id "create-workflow-templates-table"
  - [ ] Create table `workflow_templates` with columns:
    - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - name VARCHAR(255) NOT NULL
    - description TEXT NULL
    - type workflow_type NOT NULL
    - is_active BOOLEAN NOT NULL DEFAULT TRUE
    - created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    - created_by UUID NOT NULL (FK to users table)
    - updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    - updated_by UUID NULL (FK to users table)
  - [ ] Add UNIQUE constraint on (name, type) - template names must be unique per type
  - [ ] Add foreign key constraints: created_by â†’ users(id), updated_by â†’ users(id)
  - [ ] Add rollback section with dropTable
  - [ ] Reference: [Source: docs/architecture/data-models.md#WorkflowTemplate]

- [ ] **Task 3: Create Liquibase changeset for template_tasks table** (AC: 2, 5, 6, 8)
  - [ ] Add changeset to `db.changelog-master.yaml` with id "create-template-tasks-table"
  - [ ] Create table `template_tasks` with columns:
    - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - template_id UUID NOT NULL (FK to workflow_templates)
    - task_name VARCHAR(255) NOT NULL
    - description TEXT NULL
    - assigned_role user_role NOT NULL (reuse existing enum from Story 1.3)
    - sequence_order INTEGER NOT NULL
    - is_parallel BOOLEAN NOT NULL DEFAULT FALSE
    - dependency_task_id UUID NULL (FK to template_tasks, self-referential)
    - created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    - updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  - [ ] Add foreign key constraint: template_id â†’ workflow_templates(id) ON DELETE CASCADE
  - [ ] Add foreign key constraint: dependency_task_id â†’ template_tasks(id) ON DELETE SET NULL
  - [ ] Add CHECK constraint to prevent circular dependencies: dependency_task_id != id
  - [ ] Add rollback section with dropTable
  - [ ] Reference: [Source: docs/architecture/data-models.md#TemplateTask]

- [ ] **Task 4: Create Liquibase changeset for indexes** (AC: 6, 8)
  - [ ] Add changeset to `db.changelog-master.yaml` with id "create-template-indexes"
  - [ ] Create index on template_tasks(template_id) - for fetching all tasks for a template
  - [ ] Create index on template_tasks(assigned_role) - for filtering tasks by role
  - [ ] Create index on template_tasks(sequence_order) - for ordering tasks
  - [ ] Create composite index on template_tasks(template_id, sequence_order) - for ordered task queries
  - [ ] Add rollback section with dropIndex for each index
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Strategic Indexes]

- [ ] **Task 5: Create Liquibase changeset for seed data** (AC: 7, 8)
  - [ ] Add changeset to `db.changelog-master.yaml` with id "seed-workflow-template-data"
  - [ ] Add context="dev" attribute so seed data only runs in development environment
  - [ ] Insert sample onboarding template with name "Basic Onboarding Template", type ONBOARDING
  - [ ] Insert 3-5 sample tasks for the template:
    - Task 1: "HR Paperwork" assigned to HR_ADMIN, sequence_order 1
    - Task 2: "IT Setup" assigned to TECH_SUPPORT, sequence_order 2, depends on Task 1
    - Task 3: "Access Provisioning" assigned to ADMINISTRATOR, sequence_order 2 (parallel with Task 2)
  - [ ] Use appropriate created_by reference (existing admin user from Story 1.3 seed data)
  - [ ] Add rollback section with delete statements
  - [ ] Reference: [Source: docs/prd.md - Story 2.1 AC7]

- [ ] **Task 6: Create JPA entities for WorkflowTemplate and TemplateTask** (AC: 1, 2, 5)
  - [ ] Create `backend/src/main/java/com/magnab/employeelifecycle/entity/WorkflowTemplate.java`
  - [ ] Add annotations: @Entity, @Table(name = "workflow_templates")
  - [ ] Add fields matching database schema with proper JPA annotations
  - [ ] Use @Enumerated(EnumType.STRING) with @JdbcTypeCode(SqlTypes.NAMED_ENUM) for type field
  - [ ] Add Lombok annotations: @Getter, @Setter, @NoArgsConstructor, @AllArgsConstructor
  - [ ] Add @OneToMany relationship to TemplateTask (mappedBy = "workflowTemplate", cascade = CascadeType.ALL, orphanRemoval = true)
  - [ ] Create `backend/src/main/java/com/magnab/employeelifecycle/entity/TemplateTask.java`
  - [ ] Add fields matching database schema with proper JPA annotations
  - [ ] Use @Enumerated(EnumType.STRING) with @JdbcTypeCode(SqlTypes.NAMED_ENUM) for assigned_role field
  - [ ] Add @ManyToOne relationship to WorkflowTemplate (fetch = FetchType.LAZY)
  - [ ] Add @ManyToOne self-referential relationship for dependencyTask (optional, nullable)
  - [ ] Reference: [Source: docs/architecture/coding-standards.md - Critical Rules]

- [ ] **Task 7: Create enums for WorkflowType and WorkflowStatus** (AC: 1)
  - [ ] Create `backend/src/main/java/com/magnab/employeelifecycle/enums/WorkflowType.java` enum
  - [ ] Add values: ONBOARDING, OFFBOARDING
  - [ ] Create `backend/src/main/java/com/magnab/employeelifecycle/enums/WorkflowStatus.java` enum (for future use in Epic 3)
  - [ ] Add values: INITIATED, IN_PROGRESS, BLOCKED, COMPLETED
  - [ ] Reference: [Source: docs/architecture/data-models.md#WorkflowInstance]

- [ ] **Task 8: Create Spring Data JPA repositories** (AC: 1, 2)
  - [ ] Create `backend/src/main/java/com/magnab/employeelifecycle/repository/WorkflowTemplateRepository.java`
  - [ ] Extend JpaRepository<WorkflowTemplate, UUID>
  - [ ] Add custom query method: List<WorkflowTemplate> findByTypeAndIsActiveTrue(WorkflowType type)
  - [ ] Add custom query method: Optional<WorkflowTemplate> findByNameAndType(String name, WorkflowType type)
  - [ ] Create `backend/src/main/java/com/magnab/employeelifecycle/repository/TemplateTaskRepository.java`
  - [ ] Extend JpaRepository<TemplateTask, UUID>
  - [ ] Add custom query method: List<TemplateTask> findByTemplateIdOrderBySequenceOrder(UUID templateId)
  - [ ] Reference: [Source: docs/architecture/coding-standards.md - Naming Conventions]

- [ ] **Task 9: Test Liquibase migrations** (AC: 1-8)
  - [ ] Stop Docker Compose if running: `docker-compose down`
  - [ ] Delete PostgreSQL volume to start fresh: `docker volume rm hackathon-workflow-2025_postgres_data` (or similar)
  - [ ] Start Docker Compose: `docker-compose up -d postgres backend`
  - [ ] Check backend logs for successful Liquibase migration: `docker-compose logs backend | grep -i liquibase`
  - [ ] Verify all changesets applied successfully (no errors)
  - [ ] Connect to PostgreSQL: `docker exec -it <container> psql -U postgres -d employeelifecycle`
  - [ ] Verify enum types exist: `\dT+ workflow_type` and `\dT+ workflow_status`
  - [ ] Verify tables exist: `\dt` should show workflow_templates and template_tasks
  - [ ] Verify schema: `\d workflow_templates` and `\d template_tasks`
  - [ ] Verify foreign keys: Check constraint names in `\d template_tasks`
  - [ ] Verify indexes: `\di` should show all created indexes
  - [ ] Verify seed data: `SELECT * FROM workflow_templates;` and `SELECT * FROM template_tasks;`
  - [ ] Reference: [Source: docs/architecture/database-schema.md - Migration Workflow]

- [ ] **Task 10: Write unit tests for repository methods** (AC: 1, 2)
  - [ ] Create `backend/src/test/java/com/magnab/employeelifecycle/repository/WorkflowTemplateRepositoryTest.java`
  - [ ] Add @DataJpaTest annotation for repository testing
  - [ ] Add @AutoConfigureTestDatabase(replace = NONE) to use TestContainers PostgreSQL
  - [ ] Test findByTypeAndIsActiveTrue() returns active templates of specific type
  - [ ] Test findByNameAndType() returns correct template
  - [ ] Create `backend/src/test/java/com/magnab/employeelifecycle/repository/TemplateTaskRepositoryTest.java`
  - [ ] Test findByTemplateIdOrderBySequenceOrder() returns tasks in correct order
  - [ ] Test cascade delete: deleting template deletes associated tasks
  - [ ] Test self-referential dependency: creating task with dependencyTask works correctly
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Backend Testing]

## Dev Notes

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Backend Technologies for Story 2.1:**
- **Database:** PostgreSQL 17.2
- **Migration Tool:** Liquibase 4.25.1
- **ORM:** Hibernate 6.4.2 (via Spring Data JPA)
- **Framework:** Spring Boot 3.2.2 (Java 17)
- **Database Driver:** PostgreSQL JDBC 42.7.1
- **Testing:** JUnit 5, TestContainers 1.19.3

### Database Schema Design
[Source: docs/architecture/database-schema.md]

**Key Design Decisions:**
- **UUID Primary Keys:** gen_random_uuid() for globally unique identifiers
- **PostgreSQL ENUMs:** workflow_type, workflow_status for type safety at database level
- **Audit Columns:** created_at, created_by, updated_at, updated_by on all business tables
- **Soft Deletes:** is_active flag on workflow_templates (preserve template history)
- **Cascade Deletes:** ON DELETE CASCADE for templateâ†’tasks relationship (tasks cannot exist without template)
- **Foreign Key Constraints:** All relationships enforced at database level
- **Strategic Indexes:** PKs, FKs, sequence_order, composite indexes for query optimization

**Liquibase Changelog Location:** `backend/src/main/resources/db/changelog/db.changelog-master.yaml`

### Data Models
[Source: docs/architecture/data-models.md]

**WorkflowTemplate Entity:**
- Purpose: Reusable workflow blueprints for onboarding/offboarding processes
- Key Attributes:
  - id: UUID - Primary key
  - name: String (unique per type) - Template identifier
  - description: String (optional)
  - type: Enum (ONBOARDING, OFFBOARDING)
  - isActive: Boolean (default true)
  - createdAt, createdBy, updatedAt, updatedBy - Audit columns
- Relationships:
  - One-to-Many: WorkflowTemplate â†’ TemplateTask
  - One-to-Many: WorkflowTemplate â†’ WorkflowInstance (in Epic 3)

**TemplateTask Entity:**
- Purpose: Individual tasks within workflow templates with role assignments, sequencing, and dependencies
- Key Attributes:
  - id: UUID - Primary key
  - templateId: UUID (FK to WorkflowTemplate)
  - taskName: String
  - description: String (optional)
  - assignedRole: Enum (HR_ADMIN, LINE_MANAGER, TECH_SUPPORT, ADMINISTRATOR)
  - sequenceOrder: Integer (indexed) - determines execution order
  - isParallel: Boolean (default false) - parallel tasks have same sequenceOrder
  - dependencyTaskId: UUID (FK to TemplateTask, nullable) - task must complete before this one starts
  - createdAt, updatedAt
- Relationships:
  - Many-to-One: TemplateTask â†’ WorkflowTemplate
  - Self-referential: TemplateTask â†’ TemplateTask (dependencies)

### Source Tree Structure
[Source: docs/architecture/source-tree.md]

**File Locations for Story 2.1:**
```
backend/src/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ java/com/magnab/employeelifecycle/
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”œâ”€â”€ WorkflowTemplate.java      # CREATE - JPA entity
â”‚   â”‚   â”‚   â””â”€â”€ TemplateTask.java          # CREATE - JPA entity
â”‚   â”‚   â”œâ”€â”€ enums/
â”‚   â”‚   â”‚   â”œâ”€â”€ WorkflowType.java          # CREATE - Enum
â”‚   â”‚   â”‚   â””â”€â”€ WorkflowStatus.java        # CREATE - Enum (future use)
â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚       â”œâ”€â”€ WorkflowTemplateRepository.java  # CREATE - Spring Data JPA repo
â”‚   â”‚       â””â”€â”€ TemplateTaskRepository.java      # CREATE - Spring Data JPA repo
â”‚   â””â”€â”€ resources/
â”‚       â””â”€â”€ db/
â”‚           â””â”€â”€ changelog/
â”‚               â””â”€â”€ db.changelog-master.yaml     # MODIFY - Add new changesets
â””â”€â”€ test/
    â””â”€â”€ java/com/magnab/employeelifecycle/
        â””â”€â”€ repository/
            â”œâ”€â”€ WorkflowTemplateRepositoryTest.java  # CREATE - Repository tests
            â””â”€â”€ TemplateTaskRepositoryTest.java      # CREATE - Repository tests
```

### Liquibase Changeset Structure
[Source: docs/architecture/database-schema.md]

**Changeset Best Practices:**
- Each changeset should have unique ID (e.g., "create-workflow-templates-table")
- Include author attribute
- Add rollback section for every changeset
- Use contexts for seed data (context="dev")
- Changesets are executed in order within db.changelog-master.yaml

**Example Changeset Structure:**
```yaml
- changeSet:
    id: create-workflow-templates-table
    author: bob-scrum-master
    changes:
      - createTable:
          tableName: workflow_templates
          columns:
            - column:
                name: id
                type: UUID
                defaultValueComputed: gen_random_uuid()
                constraints:
                  primaryKey: true
                  nullable: false
            - column:
                name: name
                type: VARCHAR(255)
                constraints:
                  nullable: false
            # ... other columns
    rollback:
      - dropTable:
          tableName: workflow_templates
```

### JPA Entity Annotations
[Source: docs/architecture/coding-standards.md, docs/stories/1.7.story.md - User entity example]

**Critical Annotations for PostgreSQL ENUMs:**
```java
@Enumerated(EnumType.STRING)
@JdbcTypeCode(SqlTypes.NAMED_ENUM)
@Column(name = "type", columnDefinition = "workflow_type", nullable = false)
private WorkflowType type;
```

**Important:** The @JdbcTypeCode(SqlTypes.NAMED_ENUM) annotation is CRITICAL for PostgreSQL custom enum types. Without this, you will get "column is of type X but expression is of type character varying" errors. This was discovered and fixed in Story 1.7.

**Lombok Annotations for Entities:**
- @Entity - JPA entity marker
- @Table(name = "table_name") - Specify table name
- @Getter, @Setter - Generate getters/setters
- @NoArgsConstructor - Default constructor (required by JPA)
- @AllArgsConstructor - Constructor with all fields

**Relationship Annotations:**
- @OneToMany(mappedBy = "fieldName", cascade = CascadeType.ALL, orphanRemoval = true)
- @ManyToOne(fetch = FetchType.LAZY)
- @JoinColumn(name = "foreign_key_column")

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Critical Rules for AI Agents:**
1. **Always use DTOs at API boundaries** - Never expose entities in responses (for future API stories)
2. **All database queries via repositories** - No direct EntityManager use
3. **Use constructor injection** - Immutable dependencies (final fields)
4. **Return Optional for nullable queries** - Clear API contracts
5. **Lombok for entities only** - Don't overuse @Data on DTOs

**Naming Conventions:**
- Entities: Singular nouns (WorkflowTemplate, TemplateTask)
- Repositories: EntityRepository pattern (WorkflowTemplateRepository)
- Enums: Singular nouns, all caps values (WorkflowType.ONBOARDING)

### Previous Story Context
[Source: docs/stories/1.7.story.md, docs/stories/1.3.story.md]

**Key Context from Story 1.3:**
- Liquibase is already configured in Spring Boot (application.yml)
- db.changelog-master.yaml already exists with initial changesets
- user_role enum already exists (values: HR_ADMIN, LINE_MANAGER, TECH_SUPPORT, ADMINISTRATOR)
- users table already exists with audit columns
- DATABASECHANGELOG table tracks migration history

**Key Context from Story 1.7:**
- PostgreSQL enum type mapping issue discovered: Must use @JdbcTypeCode(SqlTypes.NAMED_ENUM) annotation
- User entity example of proper enum configuration available for reference

**Important Note:** This story builds on the database foundation from Story 1.3. The workflow_templates and template_tasks tables are the first tables for Epic 2's template management system.

### MVP Scope Notes
[Source: docs/prd.md - Story 2.1]

**Tables NOT Included in MVP:**
- ~~template_custom_fields~~ ðŸ”® **DEFERRED TO PHASE 2** (Story 2.6)
- ~~template_conditional_rules~~ ðŸ”® **DEFERRED TO PHASE 2** (Story 2.7)

**MVP Approach:** Use fixed employee data fields (employee_name, employee_email, employee_role, start_date, department) instead of custom fields, and multiple template variants instead of conditional logic.

## Testing

### Testing Approach for This Story
[Source: docs/architecture/test-strategy.md]

**Testing Strategy:** Unit tests for repository layer + Manual verification of database schema

**Repository Unit Tests (JUnit 5 + TestContainers):**
- Use @DataJpaTest for focused repository testing
- Use TestContainers with PostgreSQL 17.2-alpine for integration with real database
- Test custom query methods (findByTypeAndIsActiveTrue, findByNameAndType, etc.)
- Test cascade delete behavior (deleting template deletes tasks)
- Test self-referential dependency relationships
- Test foreign key constraints are enforced

**Manual Database Verification:**
- Run Liquibase migrations and verify schema creation
- Connect to PostgreSQL via psql and inspect tables, indexes, constraints
- Verify seed data was inserted correctly
- Confirm enum types are created and referenced correctly

**Test File Locations:**
```
backend/src/test/java/com/magnab/employeelifecycle/repository/
â”œâ”€â”€ WorkflowTemplateRepositoryTest.java
â””â”€â”€ TemplateTaskRepositoryTest.java
```

**Coverage Goal:** 80% coverage for repository methods (per test-strategy.md)

**No Frontend Testing:** This is a backend-only database schema story, no UI components

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 2 with complete database schema specifications, Liquibase migrations, JPA entities, and repository layer. MVP scope excludes custom fields and conditional rules tables (deferred to Phase 2). | Bob (Scrum Master) |
| 2025-10-31 | 1.1 | Story validated and approved for implementation (Readiness Score: 9.8/10, HIGH confidence, zero hallucinations detected, all 16 technical claims verified against source documents, exemplary anti-hallucination rigor demonstrated) | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
