# Story 2.5: Template Builder Form - Basic Info & Tasks

## Status
**Approved**

## Story

**As an** HR Administrator,
**I want** a form-based template builder where I can define template name, type, and add tasks with role assignments,
**so that** I can create structured workflow templates without drag-and-drop complexity.

## Acceptance Criteria

1. Template builder form includes fields: template name (required), description, type (dropdown: Onboarding/Offboarding)
2. "Add Task" button adds new task entry to form with fields: task name (required), description, assigned role (dropdown: HR_ADMIN/LINE_MANAGER/TECH_SUPPORT/ADMINISTRATOR)
3. Tasks are displayed in a list with sequence order automatically assigned based on position
4. Each task has "Move Up," "Move Down," and "Remove" buttons to reorder or delete
5. Tasks can be marked as "Run in Parallel" with checkbox (parallel tasks get same sequence_order)
6. Task dependency dropdown allows selecting a previous task as prerequisite (only tasks with lower sequence_order are options)
7. Form validates that template name is required and tasks list is not empty
8. "Save Template" button submits complete template structure to backend POST /api/templates
9. Successful save displays success notification and redirects to template library
10. Failed save displays validation errors inline on form fields
11. "Cancel" button confirms unsaved changes and navigates back to template library

## Tasks / Subtasks

- [ ] **Task 1: Create TemplateBuilderPage component structure** (AC: 1, 7, 11)
  - [ ] Create `frontend/src/components/templates/TemplateBuilderPage.tsx`
  - [ ] Add route `/templates/new` in `frontend/src/App.tsx` with ProtectedRoute wrapper
  - [ ] Add role guard: Only HR_ADMIN and ADMINISTRATOR can access (same as backend)
  - [ ] Use MUI Container, Paper, Typography for page layout
  - [ ] Add page title "Create Workflow Template"
  - [ ] Use React Hook Form for form state management
  - [ ] Define form interface: TemplateBuilderForm with fields name, description, type, tasks[]
  - [ ] Initialize form with useForm hook and default values
  - [ ] Reference: [Source: docs/stories/1.7.story.md - React Hook Form patterns]

- [ ] **Task 2: Create basic template info form fields** (AC: 1, 7, 10)
  - [ ] Add template name TextField with validation: required, max 255 characters
  - [ ] Add description TextField with multiline (4 rows) and optional validation
  - [ ] Add type Select dropdown with options: ONBOARDING, OFFBOARDING
  - [ ] Use React Hook Form Controller for each field
  - [ ] Add validation rules: name required, type required
  - [ ] Display validation errors with FormHelperText under each field
  - [ ] Use MUI Stack or Box for vertical layout with spacing
  - [ ] Reference: [Source: docs/architecture/tech-stack.md - React Hook Form 7.49.3]

- [ ] **Task 3: Create TaskListManager component for managing tasks** (AC: 2, 3, 4, 5, 6)
  - [ ] Create `frontend/src/components/templates/TaskListManager.tsx`
  - [ ] Accept props: tasks (array), onTasksChange (callback), errors (validation errors)
  - [ ] Display list of tasks with sequence_order calculated from array index + 1
  - [ ] Show "No tasks yet" empty state when tasks array is empty
  - [ ] Implement task state management: useState for tasks array in parent component
  - [ ] Pass tasks via React Hook Form useFieldArray for form integration
  - [ ] Reference: [Source: docs/stories/1.7.story.md - MUI component patterns]

- [ ] **Task 4: Create TaskFormItem component for individual task editing** (AC: 2, 3, 4, 5, 6)
  - [ ] Create `frontend/src/components/templates/TaskFormItem.tsx`
  - [ ] Accept props: task (object), index, onMoveUp, onMoveDown, onRemove, allTasks (for dependency dropdown)
  - [ ] Display task card with MUI Card component
  - [ ] Show sequence order: "Task {index + 1}"
  - [ ] Add task name TextField (required, max 255 characters)
  - [ ] Add task description TextField (multiline, optional)
  - [ ] Add assigned role Select with options: HR_ADMIN, LINE_MANAGER, TECH_SUPPORT, ADMINISTRATOR
  - [ ] Add "Run in Parallel" Checkbox (isParallel field)
  - [ ] Add dependency Select dropdown: "No Dependency" or previous tasks (only tasks with index < current task)
  - [ ] Add action buttons: Move Up IconButton, Move Down IconButton, Delete IconButton
  - [ ] Disable Move Up for first task, disable Move Down for last task
  - [ ] Use MUI CardContent and CardActions for layout
  - [ ] Reference: [Source: docs/stories/2.4.story.md - MUI Card patterns]

- [ ] **Task 5: Implement "Add Task" functionality** (AC: 2, 3)
  - [ ] Add "Add Task" Button (MUI Button, variant="outlined", startIcon with AddIcon)
  - [ ] Place button below task list
  - [ ] On click: Append new task to tasks array with default values (taskName: "", description: "", assignedRole: "HR_ADMIN", isParallel: false, dependencyTaskId: null)
  - [ ] Use React Hook Form useFieldArray append method
  - [ ] Automatically scroll to new task after adding
  - [ ] Show validation error if user tries to save without adding tasks (handled by form validation)
  - [ ] Reference: [Source: docs/architecture/tech-stack.md - React Hook Form useFieldArray]

- [ ] **Task 6: Implement task reordering (Move Up / Move Down)** (AC: 3, 4)
  - [ ] Implement handleMoveUp(index): Swap task at index with task at index-1
  - [ ] Implement handleMoveDown(index): Swap task at index with task at index+1
  - [ ] Use React Hook Form useFieldArray move method for swapping
  - [ ] Update sequence_order automatically based on new array positions (sequence_order = index + 1)
  - [ ] Disable Move Up button for first task (index === 0)
  - [ ] Disable Move Down button for last task (index === tasks.length - 1)
  - [ ] Reference: [Source: docs/stories/1.7.story.md - Array manipulation patterns]

- [ ] **Task 7: Implement task removal** (AC: 4)
  - [ ] Implement handleRemove(index): Remove task from tasks array at index
  - [ ] Use React Hook Form useFieldArray remove method
  - [ ] Show confirmation dialog before removal: "Are you sure you want to remove this task?"
  - [ ] Use ConfirmationDialog component from Story 2.4 (if exists) or create inline confirmation
  - [ ] After removal, recalculate sequence_order for remaining tasks
  - [ ] Clear any dependencies on removed task from other tasks
  - [ ] Reference: [Source: docs/stories/2.4.story.md - ConfirmationDialog component]

- [ ] **Task 8: Implement parallel tasks and dependencies** (AC: 5, 6)
  - [ ] Add isParallel checkbox to TaskFormItem
  - [ ] When isParallel is checked, show informational text: "This task will run in parallel with other tasks at the same sequence order"
  - [ ] Add dependency dropdown with options: "No Dependency" (null) or list of previous tasks (tasks with index < current task)
  - [ ] Dropdown shows task names: "Task {index + 1}: {taskName}"
  - [ ] On select, set dependencyTaskId to selected task's temporary ID or index reference
  - [ ] Validation: Cannot select parallel dependency (warn user if dependency is on parallel task)
  - [ ] Note: Backend will handle sequence_order calculation for parallel tasks (same sequence_order for parallel tasks)
  - [ ] Reference: [Source: docs/stories/2.2.story.md - Template task structure]

- [ ] **Task 9: Implement form validation** (AC: 7, 10)
  - [ ] Add validation rules via React Hook Form:
    - Template name: required, maxLength: 255
    - Type: required
    - Tasks array: minLength: 1 (at least one task required)
    - Each task: taskName required, assignedRole required
  - [ ] Display validation errors inline with FormHelperText
  - [ ] Disable "Save Template" button while form is invalid or submitting
  - [ ] Show validation error summary at top of form if user tries to submit invalid form
  - [ ] Highlight invalid fields with red border (MUI error prop)
  - [ ] Reference: [Source: docs/stories/1.7.story.md - Form validation patterns]

- [ ] **Task 10: Implement "Save Template" submission** (AC: 8, 9, 10)
  - [ ] Add "Save Template" Button (MUI Button, variant="contained") at bottom of form
  - [ ] On click: Trigger form submission via handleSubmit
  - [ ] Transform form data to CreateTemplateRequest DTO format:
    - Map tasks array to include sequenceOrder (index + 1)
    - Handle parallel tasks: If isParallel=true, use previous task's sequenceOrder
    - Map dependencyTaskId from index reference to actual task UUID (will be null for new templates)
  - [ ] Call useCreateTemplateMutation from templatesApi (created in Story 2.4)
  - [ ] Show loading spinner on button while mutation is in progress
  - [ ] On success: Show success Snackbar "Template created successfully", navigate to /templates
  - [ ] On error: Display error Alert at top of form with error message
  - [ ] Handle 400 Bad Request: Show field-specific validation errors
  - [ ] Reference: [Source: docs/stories/2.2.story.md - CreateTemplateRequest DTO structure]

- [ ] **Task 11: Create createTemplate mutation in templatesApi** (AC: 8)
  - [ ] Verify `frontend/src/features/templates/templatesApi.ts` exists from Story 2.4
  - [ ] Add createTemplate mutation: POST /api/templates with CreateTemplateRequest body
  - [ ] Define CreateTemplateRequest interface:
    ```typescript
    interface CreateTemplateRequest {
      name: string;
      description?: string;
      type: 'ONBOARDING' | 'OFFBOARDING';
      tasks: CreateTemplateTaskRequest[];
    }
    interface CreateTemplateTaskRequest {
      taskName: string;
      description?: string;
      assignedRole: 'HR_ADMIN' | 'LINE_MANAGER' | 'TECH_SUPPORT' | 'ADMINISTRATOR';
      sequenceOrder: number;
      isParallel: boolean;
      dependencyTaskId?: string | null;
    }
    ```
  - [ ] Mutation invalidates 'Templates' tag to refetch template list
  - [ ] Export useCreateTemplateMutation hook
  - [ ] Reference: [Source: docs/stories/2.2.story.md - Backend API endpoint specifications]

- [ ] **Task 12: Implement "Cancel" button with unsaved changes warning** (AC: 11)
  - [ ] Add "Cancel" Button (MUI Button, variant="text") next to "Save Template" button
  - [ ] On click: Check if form has unsaved changes (form.formState.isDirty)
  - [ ] If unsaved changes: Show confirmation dialog "You have unsaved changes. Are you sure you want to leave?"
  - [ ] If confirmed or no changes: Navigate back to /templates
  - [ ] Use React Router useNavigate hook for navigation
  - [ ] Reference: [Source: docs/stories/2.4.story.md - Confirmation dialog patterns]

- [ ] **Task 13: Add route for edit mode (bonus - not required for AC)** (AC: N/A)
  - [ ] Add route `/templates/edit/:id` in App.tsx
  - [ ] Use same TemplateBuilderPage component with mode prop or URL param check
  - [ ] If editing: Fetch template via GET /api/templates/{id} on mount
  - [ ] Pre-populate form fields with existing template data
  - [ ] Change page title to "Edit Workflow Template"
  - [ ] Change button text to "Update Template"
  - [ ] Use PUT /api/templates/{id} instead of POST for submission
  - [ ] Note: This is preparation for Story 2.4 AC7 ("Edit" button functionality)
  - [ ] Reference: [Source: docs/stories/2.4.story.md - AC7 Edit action]

- [ ] **Task 14: Write component tests** (AC: 1-11)
  - [ ] Create `frontend/src/components/templates/TemplateBuilderPage.test.tsx`
  - [ ] Test: Page renders with template info fields and empty task list
  - [ ] Test: "Add Task" button adds new task to list
  - [ ] Test: Task "Move Up" button reorders tasks correctly
  - [ ] Test: Task "Move Down" button reorders tasks correctly
  - [ ] Test: Task "Remove" button removes task after confirmation
  - [ ] Test: Form validation shows errors for empty template name
  - [ ] Test: Form validation shows error for templates with no tasks
  - [ ] Test: "Save Template" submits correct CreateTemplateRequest structure
  - [ ] Test: Successful save shows success notification and navigates to /templates
  - [ ] Test: Failed save shows error message
  - [ ] Test: "Cancel" button shows confirmation dialog if form is dirty
  - [ ] Mock RTK Query hooks using MSW or jest.mock
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Frontend component testing]

## Dev Notes

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Frontend Technologies for Story 2.5:**
- **Framework:** React 18.2.0 with TypeScript 5.3.3
- **State Management:** Redux Toolkit 2.1.0
- **API Client:** RTK Query 2.1.0
- **Form Management:** React Hook Form 7.49.3 (critical for complex form with dynamic fields)
- **UI Components:** Material-UI (MUI) 5.15.7
- **Routing:** React Router v6
- **Testing:** Jest 29.7.0, React Testing Library 14.1.2

### Backend API Endpoints
[Source: docs/stories/2.2.story.md - REST API]

**Template Endpoints (implemented in Story 2.2):**

**POST /api/templates**
- Request Body: CreateTemplateRequest
```json
{
  "name": "Basic Onboarding Template",
  "description": "Standard onboarding workflow",
  "type": "ONBOARDING",
  "tasks": [
    {
      "taskName": "HR Paperwork",
      "description": "Complete new hire paperwork",
      "assignedRole": "HR_ADMIN",
      "sequenceOrder": 1,
      "isParallel": false,
      "dependencyTaskId": null
    },
    {
      "taskName": "IT Setup",
      "description": "Provision accounts and equipment",
      "assignedRole": "TECH_SUPPORT",
      "sequenceOrder": 2,
      "isParallel": false,
      "dependencyTaskId": null
    }
  ]
}
```
- Response 201: TemplateDetailResponse (same structure as GET /api/templates/{id})
- Response 400: Validation errors
- Response 403: Forbidden (user not HR_ADMIN or ADMINISTRATOR)

**Authorization:**
- Only HR_ADMIN and ADMINISTRATOR roles can create templates
- Backend enforces with @PreAuthorize("hasAnyRole('HR_ADMIN', 'ADMINISTRATOR')")

### React Hook Form with Dynamic Fields
[Source: docs/architecture/tech-stack.md, docs/stories/1.7.story.md]

**useFieldArray Pattern for Dynamic Task List:**

```typescript
import { useForm, useFieldArray, Controller } from 'react-hook-form';

interface TemplateBuilderForm {
  name: string;
  description: string;
  type: 'ONBOARDING' | 'OFFBOARDING';
  tasks: TaskForm[];
}

interface TaskForm {
  taskName: string;
  description: string;
  assignedRole: 'HR_ADMIN' | 'LINE_MANAGER' | 'TECH_SUPPORT' | 'ADMINISTRATOR';
  isParallel: boolean;
  dependencyTaskId: string | null;
}

const { control, handleSubmit, formState: { errors, isDirty }, watch } = useForm<TemplateBuilderForm>({
  defaultValues: {
    name: '',
    description: '',
    type: 'ONBOARDING',
    tasks: [],
  },
});

const { fields, append, remove, move } = useFieldArray({
  control,
  name: 'tasks',
});

// Add task
const handleAddTask = () => {
  append({
    taskName: '',
    description: '',
    assignedRole: 'HR_ADMIN',
    isParallel: false,
    dependencyTaskId: null,
  });
};

// Move task up
const handleMoveUp = (index: number) => {
  if (index > 0) {
    move(index, index - 1);
  }
};

// Move task down
const handleMoveDown = (index: number) => {
  if (index < fields.length - 1) {
    move(index, index + 1);
  }
};

// Remove task
const handleRemove = (index: number) => {
  if (window.confirm('Are you sure you want to remove this task?')) {
    remove(index);
  }
};
```

**Form Validation:**
```typescript
const { control, handleSubmit, formState: { errors } } = useForm<TemplateBuilderForm>({
  defaultValues: { ... },
});

// In template name field
<Controller
  name="name"
  control={control}
  rules={{
    required: 'Template name is required',
    maxLength: {
      value: 255,
      message: 'Template name must not exceed 255 characters',
    },
  }}
  render={({ field }) => (
    <TextField
      {...field}
      label="Template Name"
      required
      error={!!errors.name}
      helperText={errors.name?.message}
    />
  )}
/>

// Validate tasks array not empty
<Controller
  name="tasks"
  control={control}
  rules={{
    validate: (tasks) => tasks.length > 0 || 'Template must have at least one task',
  }}
  render={() => (
    <TaskListManager tasks={fields} ... />
  )}
/>
```

### Redux API Setup
[Source: docs/stories/2.4.story.md, docs/stories/2.2.story.md]

**Templates API (already exists from Story 2.4):**

```typescript
// features/templates/templatesApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';

export const templatesApi = createApi({
  reducerPath: 'templatesApi',
  baseQuery: fetchBaseQuery({
    baseUrl: 'http://localhost:8080/api',
    credentials: 'include',
  }),
  tagTypes: ['Templates'],
  endpoints: (builder) => ({
    getTemplates: builder.query({
      query: () => '/templates',
      providesTags: ['Templates'],
    }),
    getTemplateById: builder.query({
      query: (id) => `/templates/${id}`,
      providesTags: (result, error, id) => [{ type: 'Templates', id }],
    }),
    createTemplate: builder.mutation({
      query: (newTemplate) => ({
        url: '/templates',
        method: 'POST',
        body: newTemplate,
      }),
      invalidatesTags: ['Templates'],
    }),
    updateTemplate: builder.mutation({
      query: ({ id, ...body }) => ({
        url: `/templates/${id}`,
        method: 'PUT',
        body,
      }),
      invalidatesTags: ['Templates'],
    }),
  }),
});

export const {
  useGetTemplatesQuery,
  useGetTemplateByIdQuery,
  useCreateTemplateMutation,
  useUpdateTemplateMutation,
} = templatesApi;
```

**Note:** The createTemplate mutation should already exist from Story 2.4. If missing, add it in this story.

### Material-UI Component Patterns
[Source: docs/architecture/tech-stack.md, docs/stories/1.7.story.md, docs/stories/2.4.story.md]

**Page Layout Pattern:**
```typescript
<Container maxWidth="md">
  <Box sx={{ mt: 4, mb: 4 }}>
    <Typography variant="h4" gutterBottom>
      Create Workflow Template
    </Typography>

    {/* Template Info Section */}
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        Template Information
      </Typography>
      <Stack spacing={2}>
        {/* Name TextField */}
        {/* Description TextField */}
        {/* Type Select */}
      </Stack>
    </Paper>

    {/* Tasks Section */}
    <Paper sx={{ p: 3, mb: 3 }}>
      <Typography variant="h6" gutterBottom>
        Tasks
      </Typography>
      {/* Task list */}
      <Button onClick={handleAddTask}>Add Task</Button>
    </Paper>

    {/* Action Buttons */}
    <Stack direction="row" spacing={2} justifyContent="flex-end">
      <Button variant="text" onClick={handleCancel}>Cancel</Button>
      <Button variant="contained" onClick={handleSubmit(onSubmit)}>Save Template</Button>
    </Stack>
  </Box>
</Container>
```

**Task Card Pattern:**
```typescript
<Card sx={{ mb: 2 }}>
  <CardContent>
    <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 2 }}>
      <Typography variant="subtitle1">Task {index + 1}</Typography>
      <Box>
        <IconButton onClick={() => handleMoveUp(index)} disabled={index === 0}>
          <ArrowUpwardIcon />
        </IconButton>
        <IconButton onClick={() => handleMoveDown(index)} disabled={index === fields.length - 1}>
          <ArrowDownwardIcon />
        </IconButton>
        <IconButton onClick={() => handleRemove(index)} color="error">
          <DeleteIcon />
        </IconButton>
      </Box>
    </Box>

    <Stack spacing={2}>
      {/* Task Name TextField */}
      {/* Task Description TextField */}
      {/* Assigned Role Select */}
      {/* Is Parallel Checkbox */}
      {/* Dependency Select */}
    </Stack>
  </CardContent>
</Card>
```

### Source Tree Structure
[Source: docs/architecture/source-tree.md]

**File Locations for Story 2.5:**
```
frontend/src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ TemplateLibraryPage.tsx         # EXISTS from Story 2.4
â”‚       â”œâ”€â”€ TemplateCard.tsx                # EXISTS from Story 2.4
â”‚       â”œâ”€â”€ TemplateDetailModal.tsx         # EXISTS from Story 2.4
â”‚       â”œâ”€â”€ TemplateBuilderPage.tsx         # CREATE - Main template builder page
â”‚       â”œâ”€â”€ TaskListManager.tsx             # CREATE - Task list container (optional)
â”‚       â””â”€â”€ TaskFormItem.tsx                # CREATE - Individual task form card
â”œâ”€â”€ features/
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ templatesSlice.ts               # EXISTS from Story 2.4
â”‚       â””â”€â”€ templatesApi.ts                 # MODIFY - Add createTemplate mutation if missing
â”œâ”€â”€ App.tsx                                 # MODIFY - Add /templates/new and /templates/edit/:id routes
â””â”€â”€ store.ts                                # EXISTS from Story 2.4 (no changes needed)
```

### Sequence Order and Parallel Tasks Logic
[Source: docs/stories/2.2.story.md, docs/prd.md - Story 2.5 AC5]

**Sequence Order Calculation:**
- By default, sequence_order = array index + 1 (Task 1 = 1, Task 2 = 2, etc.)
- If task has isParallel = true, it should share the same sequence_order as the previous task
- Backend will handle sequence_order normalization (Story 2.3), but frontend should send reasonable values

**Frontend Logic:**
```typescript
const transformToCreateRequest = (formData: TemplateBuilderForm): CreateTemplateRequest => {
  let currentSequenceOrder = 1;

  const tasks = formData.tasks.map((task, index) => {
    // If parallel and not first task, use previous task's sequence order
    if (task.isParallel && index > 0) {
      // Keep same sequence order as previous task
    } else {
      // New sequence order
      currentSequenceOrder = index + 1;
    }

    return {
      taskName: task.taskName,
      description: task.description || null,
      assignedRole: task.assignedRole,
      sequenceOrder: currentSequenceOrder,
      isParallel: task.isParallel,
      dependencyTaskId: task.dependencyTaskId || null,
    };
  });

  return {
    name: formData.name,
    description: formData.description || null,
    type: formData.type,
    tasks,
  };
};
```

**Important Note:** For new templates, dependencyTaskId will be null or empty string (tasks don't have IDs until saved). Backend will handle dependency relationships based on sequence_order for initial creation.

### Dependency Dropdown Logic
[Source: docs/prd.md - Story 2.5 AC6]

**AC6:** "Task dependency dropdown allows selecting a previous task as prerequisite (only tasks with lower sequence_order are options)"

**Implementation:**
```typescript
const getDependencyOptions = (currentIndex: number, allTasks: TaskForm[]) => {
  return allTasks
    .slice(0, currentIndex) // Only tasks before current task
    .map((task, index) => ({
      value: index.toString(), // Use index as reference for new templates
      label: `Task ${index + 1}: ${task.taskName || 'Untitled'}`,
    }));
};

<Select
  value={field.value || ''}
  onChange={(e) => field.onChange(e.target.value || null)}
>
  <MenuItem value="">No Dependency</MenuItem>
  {getDependencyOptions(index, fields).map((option) => (
    <MenuItem key={option.value} value={option.value}>
      {option.label}
    </MenuItem>
  ))}
</Select>
```

### Confirmation Dialog for Cancel
[Source: docs/stories/2.4.story.md - ConfirmationDialog component]

**If ConfirmationDialog component exists from Story 2.4:**
```typescript
import ConfirmationDialog from '../common/ConfirmationDialog';

const [cancelDialogOpen, setCancelDialogOpen] = useState(false);

const handleCancel = () => {
  if (isDirty) {
    setCancelDialogOpen(true);
  } else {
    navigate('/templates');
  }
};

const handleConfirmCancel = () => {
  setCancelDialogOpen(false);
  navigate('/templates');
};

<ConfirmationDialog
  open={cancelDialogOpen}
  onClose={() => setCancelDialogOpen(false)}
  onConfirm={handleConfirmCancel}
  title="Unsaved Changes"
  message="You have unsaved changes. Are you sure you want to leave?"
/>
```

**If ConfirmationDialog doesn't exist, use inline MUI Dialog or window.confirm:**
```typescript
const handleCancel = () => {
  if (isDirty && !window.confirm('You have unsaved changes. Are you sure you want to leave?')) {
    return;
  }
  navigate('/templates');
};
```

### Previous Story Context
[Source: docs/stories/2.4.story.md, docs/stories/2.2.story.md]

**Key Context from Story 2.4 (Template Library UI):**
- Template library page displays all templates with filtering
- "Create New Template" button navigates to /templates/new (this story)
- "Edit" button navigates to /templates/edit/:id (edit mode for this story)
- templatesApi.ts already created with getTemplates and getTemplateById queries
- templatesApi.ts may or may not have createTemplate mutation (add if missing)
- ConfirmationDialog component may exist in src/components/common/

**Key Context from Story 2.2 (Backend Template CRUD API):**
- POST /api/templates endpoint exists and is fully functional
- Endpoint accepts CreateTemplateRequest DTO with name, description, type, tasks[]
- Each task requires: taskName, assignedRole, sequenceOrder, isParallel, dependencyTaskId (nullable)
- Backend validates: template name required, tasks array not empty, circular dependencies detected
- Backend returns 201 Created with TemplateDetailResponse on success
- Backend returns 400 Bad Request with validation errors
- Only HR_ADMIN and ADMINISTRATOR roles can create templates (403 Forbidden otherwise)

**Important Note:** This is the first story building the template builder UI. It completes the template management flow: Library (Story 2.4) â†’ Builder (Story 2.5) â†’ Backend API (Story 2.2, 2.3).

### MVP Scope Notes
[Source: docs/prd.md - Story 2.5]

**Features NOT Included in This Story:**
- ~~Custom fields~~ ðŸ”® **DEFERRED TO PHASE 2** (Story 2.6)
- ~~Conditional logic~~ ðŸ”® **DEFERRED TO PHASE 2** (Story 2.7)

**MVP Approach:** Template builder only includes name, description, type, and tasks with basic properties (name, description, role, sequence, parallel flag, dependencies). Custom fields and conditional logic are deferred to Phase 2.

### Error Handling
[Source: docs/stories/1.7.story.md, docs/stories/2.4.story.md]

**Common Error Scenarios:**
- 400 Bad Request: Validation errors (empty name, no tasks, invalid task data)
- 403 Forbidden: User not authorized (not HR_ADMIN or ADMINISTRATOR)
- 500 Internal Server Error: Backend issue

**Error Display:**
- Form validation errors: Display under each field with FormHelperText
- API errors: Display in Alert component at top of form
- Success notifications: Display with Snackbar component

**Error Handling Example:**
```typescript
const [createTemplate, { isLoading, error }] = useCreateTemplateMutation();

const onSubmit = async (data: TemplateBuilderForm) => {
  try {
    const request = transformToCreateRequest(data);
    await createTemplate(request).unwrap();
    setSnackbar({ open: true, message: 'Template created successfully', severity: 'success' });
    navigate('/templates');
  } catch (err: any) {
    if (err.status === 400) {
      setErrorMessage('Validation error: Please check all fields');
    } else if (err.status === 403) {
      setErrorMessage('Access denied: You do not have permission to create templates');
    } else {
      setErrorMessage('Failed to create template. Please try again.');
    }
  }
};
```

## Testing

### Testing Approach for This Story
[Source: docs/architecture/test-strategy.md]

**Testing Strategy:** Component tests with React Testing Library + Manual browser testing

**Component Tests (Jest + React Testing Library):**
- Test TemplateBuilderPage renders with all form fields
- Test "Add Task" button adds task to list
- Test task reordering (Move Up / Move Down) updates sequence correctly
- Test task removal with confirmation
- Test form validation (template name required, tasks list not empty)
- Test "Save Template" submits correct CreateTemplateRequest structure
- Test successful save shows success notification and navigates to /templates
- Test failed save shows error message
- Test "Cancel" button shows confirmation if form has unsaved changes
- Mock RTK Query hooks for predictable test data

**Manual Testing:**
- Run frontend: `npm run dev`
- Login as HR_ADMIN user
- Navigate to /templates, click "Create New Template"
- Fill template name, description, type
- Add multiple tasks, test reordering, parallel flag, dependencies
- Test form validation by leaving fields empty
- Test successful template creation
- Verify template appears in library after creation
- Test authorization (non-admin cannot access)

**Test File Locations:**
```
frontend/src/components/templates/
â”œâ”€â”€ TemplateBuilderPage.test.tsx
â”œâ”€â”€ TaskFormItem.test.tsx
â””â”€â”€ TaskListManager.test.tsx (if created as separate component)
```

**Coverage Goal:** 80% coverage for components (per test-strategy.md)

**No Backend Testing:** Backend API already tested in Story 2.2

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 2 with complete template builder UI specification, including form-based template creation with dynamic task management (add, reorder, remove), parallel tasks, dependencies, React Hook Form with useFieldArray, Material-UI components, and integration with backend POST /api/templates. First frontend story for template creation. | Bob (Scrum Master) |
| 2025-10-31 | 1.1 | Story validated and approved for implementation. Validation Score: 9.8/10 (Very High confidence). Perfect template compliance, zero hallucinations detected, 100% AC coverage, comprehensive code examples. PO Assessment: Exemplary story - ready for immediate development. | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
