# Story 1.7: Basic User Management UI (HR Admin)

## Status
**Approved**

## Story

**As an** HR Administrator,
**I want** a user management page where I can view all users and create new user accounts,
**so that** I can onboard new system users before they can access the application.

## Acceptance Criteria

1. User management page is accessible only to HR_ADMIN role (route guard enforced)
2. Page displays table of all users showing: username, email, role, active status
3. "Create User" button opens modal dialog with form fields: username, email, password, role dropdown
4. Form validation ensures all required fields are filled and email format is valid
5. Successful user creation closes modal, refreshes user list, and displays success notification
6. Failed user creation displays error message in modal
7. User list supports basic search/filter by username or email
8. Active/Inactive status is visually indicated (badge or icon)
9. Edit and deactivate actions are visible in table rows but need not be functional yet (can be completed in later story or iteration)
10. Material-UI components (Table, Modal, Form) are used for consistent styling

## Tasks / Subtasks

- [ ] **Task 1: Create Redux users slice and API** (AC: 2, 3, 5, 6)
  - [ ] Create frontend/src/features/users/usersSlice.ts with Redux Toolkit
  - [ ] Create frontend/src/features/users/usersApi.ts using RTK Query
  - [ ] Define getUsers query: GET /api/users
  - [ ] Define createUser mutation: POST /api/users with CreateUserRequest body
  - [ ] Register usersApi in store.ts

- [ ] **Task 2: Create UserManagement page component** (AC: 1, 2, 7, 8, 10)
  - [ ] Create frontend/src/components/users/UserManagementPage.tsx
  - [ ] Add route /users in App.tsx with ProtectedRoute wrapper
  - [ ] Add role guard that checks user.role === 'HR_ADMIN', redirect if unauthorized
  - [ ] Use MUI Container, Paper, Typography for page layout
  - [ ] Fetch users list using useGetUsersQuery hook on component mount
  - [ ] Implement search/filter state with TextField for username/email filtering
  - [ ] Filter users client-side based on search input

- [ ] **Task 3: Create users table component** (AC: 2, 8, 9, 10)
  - [ ] Use MUI TableContainer, Table, TableHead, TableBody, TableRow, TableCell
  - [ ] Display columns: Username, Email, Role, Status, Actions
  - [ ] Render Active/Inactive status with MUI Chip component (green for active, gray for inactive)
  - [ ] Add placeholder action buttons in Actions column: Edit (IconButton), Deactivate (IconButton)
  - [ ] Add onClick handlers that show "Not implemented yet" Snackbar message
  - [ ] Show loading spinner (MUI CircularProgress) while fetching users
  - [ ] Show empty state message if no users exist

- [ ] **Task 4: Create CreateUserModal component** (AC: 3, 4, 5, 6, 10)
  - [ ] Create frontend/src/components/users/CreateUserModal.tsx
  - [ ] Use MUI Dialog, DialogTitle, DialogContent, DialogActions for modal structure
  - [ ] Add form fields: TextField for username, TextField for email, TextField for password (type="password"), Select for role
  - [ ] Role dropdown options: HR_ADMIN, LINE_MANAGER, TECH_SUPPORT, ADMINISTRATOR
  - [ ] Use React Hook Form for form state management and validation
  - [ ] Add validation rules: all fields required, email must be valid format
  - [ ] Display validation errors with MUI FormHelperText under each field
  - [ ] Add "Cancel" button that closes modal and "Create User" button that submits form
  - [ ] Disable submit button while mutation is in progress

- [ ] **Task 5: Integrate CreateUserModal with UserManagementPage** (AC: 3, 5, 6)
  - [ ] Add "Create User" button (MUI Button with variant="contained") at top of UserManagementPage
  - [ ] Manage modal open/close state with useState
  - [ ] Pass useCreateUserMutation hook to modal for form submission
  - [ ] On successful creation: close modal, show success Snackbar, refetch users list
  - [ ] On failed creation: show error Alert inside modal with error message
  - [ ] Handle 409 Conflict error (duplicate username) with specific message

- [ ] **Task 6: Manual testing of User Management UI** (AC: 1-10)
  - [ ] Start frontend with npm run dev and backend with docker-compose up
  - [ ] Test: Login as HR_ADMIN user, verify /users route is accessible
  - [ ] Test: Login as non-HR_ADMIN user (LINE_MANAGER), verify /users route redirects or shows unauthorized message
  - [ ] Test: Verify users table displays with all columns and existing users
  - [ ] Test: Click "Create User" button, verify modal opens with form
  - [ ] Test: Submit empty form, verify validation errors display
  - [ ] Test: Submit form with invalid email, verify email validation error
  - [ ] Test: Submit valid user data, verify success notification and user appears in table
  - [ ] Test: Try to create duplicate username, verify error message displays
  - [ ] Test: Use search field to filter by username, verify table updates
  - [ ] Test: Use search field to filter by email, verify table updates
  - [ ] Test: Verify Active/Inactive badges display correctly with color coding
  - [ ] Test: Click Edit or Deactivate action buttons, verify "Not implemented yet" message

## Dev Notes

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Frontend Technologies for Story 1.7:**
- **Framework:** React 18.2.0 with TypeScript 5.3.3
- **State Management:** Redux Toolkit 2.1.0
- **API Client:** RTK Query 2.1.0
- **Form Management:** React Hook Form 7.49.3
- **UI Components:** Material-UI (MUI) 5.15.7
- **Routing:** React Router v6 (already installed in Story 1.6)

### Source Tree Structure
[Source: docs/architecture/source-tree.md]

**File Locations for Story 1.7:**
```
frontend/src/
├── components/
│   └── users/
│       ├── UserManagementPage.tsx    # CREATE - Main page component
│       └── CreateUserModal.tsx       # CREATE - Modal for creating users
├── features/
│   └── users/
│       ├── usersSlice.ts             # CREATE - Redux users state
│       └── usersApi.ts               # CREATE - RTK Query users API
├── App.tsx                           # MODIFY - Add /users route
└── store.ts                          # MODIFY - Register usersApi
```

### Backend API Endpoints
[Source: docs/stories/1.5.story.md, docs/architecture/rest-api-spec.md]

**User Management Endpoints (implemented in Story 1.5):**

**GET /api/users**
- Response 200: Array of UserResponse objects
```json
[
  {
    "id": "uuid",
    "username": "string",
    "email": "string",
    "role": "HR_ADMIN|LINE_MANAGER|TECH_SUPPORT|ADMINISTRATOR",
    "isActive": true,
    "createdAt": "2025-10-30T10:00:00Z",
    "updatedAt": "2025-10-30T10:00:00Z"
  }
]
```
- Response 403: Forbidden (if not HR_ADMIN role)

**POST /api/users**
- Request Body:
```json
{
  "username": "string",
  "email": "string",
  "password": "string",
  "role": "HR_ADMIN|LINE_MANAGER|TECH_SUPPORT|ADMINISTRATOR"
}
```
- Response 201: Created UserResponse
- Response 400: Bad Request (validation errors)
- Response 409: Conflict (duplicate username or email)
```json
{
  "timestamp": "ISO8601",
  "status": 409,
  "error": "Conflict",
  "message": "Username already exists",
  "path": "/api/users"
}
```

### Redux and RTK Query Setup
[Source: docs/prd.md, Story 1.6 implementation]

**Users API Example:**
```typescript
// features/users/usersApi.ts
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';

export const usersApi = createApi({
  reducerPath: 'usersApi',
  baseQuery: fetchBaseQuery({
    baseUrl: 'http://localhost:8080/api',
    credentials: 'include',
  }),
  tagTypes: ['Users'],
  endpoints: (builder) => ({
    getUsers: builder.query({
      query: () => '/users',
      providesTags: ['Users'],
    }),
    createUser: builder.mutation({
      query: (newUser) => ({
        url: '/users',
        method: 'POST',
        body: newUser,
      }),
      invalidatesTags: ['Users'],
    }),
  }),
});

export const { useGetUsersQuery, useCreateUserMutation } = usersApi;
```

**Store Configuration Update:**
```typescript
// store.ts
import { configureStore } from '@reduxjs/toolkit';
import { authApi } from './features/auth/authApi';
import { usersApi } from './features/users/usersApi';
import authReducer from './features/auth/authSlice';

export const store = configureStore({
  reducer: {
    auth: authReducer,
    [authApi.reducerPath]: authApi.reducer,
    [usersApi.reducerPath]: usersApi.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware()
      .concat(authApi.middleware)
      .concat(usersApi.middleware),
});
```

### Material-UI Components to Use
[Source: docs/prd.md - UI Component Library]

**UserManagementPage Components:**
- `Container` - Page wrapper
- `Paper` - Card surface for table
- `Typography` - Page title "User Management"
- `Button` - "Create User" button
- `TextField` - Search/filter input
- `TableContainer`, `Table`, `TableHead`, `TableBody`, `TableRow`, `TableCell` - Users table
- `Chip` - Active/Inactive status badges
- `IconButton` - Edit and Deactivate action buttons
- `CircularProgress` - Loading spinner
- `Snackbar` / `Alert` - Success/error notifications

**CreateUserModal Components:**
- `Dialog` - Modal container
- `DialogTitle` - "Create New User"
- `DialogContent` - Form fields container
- `DialogActions` - Cancel and Create buttons
- `TextField` - Username, email, password inputs
- `Select`, `MenuItem` - Role dropdown
- `FormControl`, `FormLabel`, `FormHelperText` - Form field wrappers and validation messages
- `Button` - Cancel and Create buttons
- `Alert` - Error message display

### React Hook Form Integration
[Source: docs/prd.md - Form Management]

**CreateUserModal Form Example:**
```typescript
import { useForm, Controller } from 'react-hook-form';

interface CreateUserForm {
  username: string;
  email: string;
  password: string;
  role: string;
}

const { control, handleSubmit, formState: { errors }, reset } = useForm<CreateUserForm>({
  defaultValues: {
    username: '',
    email: '',
    password: '',
    role: 'LINE_MANAGER',
  },
});

const onSubmit = async (data: CreateUserForm) => {
  try {
    await createUser(data).unwrap();
    reset();
    onClose();
    // Show success notification
  } catch (error) {
    // Show error message
  }
};
```

**Validation Rules:**
```typescript
<Controller
  name="email"
  control={control}
  rules={{
    required: 'Email is required',
    pattern: {
      value: /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,
      message: 'Invalid email address',
    },
  }}
  render={({ field }) => (
    <TextField
      {...field}
      label="Email"
      error={!!errors.email}
      helperText={errors.email?.message}
    />
  )}
/>
```

### Role-Based Access Control
[Source: docs/prd.md - Story 1.7 AC, docs/architecture/security.md]

**Route Guard Pattern:**
```typescript
// In UserManagementPage.tsx
const { user } = useSelector((state: RootState) => state.auth);

useEffect(() => {
  if (user && user.role !== 'HR_ADMIN') {
    // Redirect to dashboard or show unauthorized message
    navigate('/dashboard');
    // Or show error: setError('Access denied: HR Admin role required');
  }
}, [user, navigate]);
```

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Frontend Standards:**
- Functional components with hooks (no class components)
- TypeScript interfaces for all data structures
- React Hook Form for form validation
- RTK Query for API calls with automatic cache invalidation
- Material-UI components for consistent styling
- Client-side filtering for search (no backend pagination for MVP)

### Error Handling
[Source: docs/stories/1.5.story.md]

**Common Error Scenarios:**
- 403 Forbidden: User not authorized (not HR_ADMIN)
- 400 Bad Request: Validation errors (empty fields, invalid email)
- 409 Conflict: Username or email already exists
- 500 Internal Server Error: Backend issue

**Error Display:**
- Form validation errors: Display under each field with FormHelperText
- API errors: Display in Alert component within modal
- Success notifications: Display with Snackbar component

### Previous Story Context
[Source: docs/stories/1.6.story.md]

**Key Context from Story 1.6:**
- Redux store already configured with authApi
- ProtectedRoute component exists for route guarding
- AppLayout component exists with navigation header
- Authentication state available in Redux: `state.auth.user` contains role
- Material-UI theme already configured

## Testing

### Testing Approach for This Story
[Source: docs/architecture/test-strategy.md, docs/prd.md - Story 1.8]

**Important Note:** Story 1.8 will set up the complete testing framework with Jest and React Testing Library. For Story 1.7, testing is **manual verification only** via browser:

**Manual Testing Steps:**

1. **Access Control (HR_ADMIN Only):**
   - Login as HR_ADMIN user
   - Navigate to /users
   - Verify page loads with users table
   - Logout and login as LINE_MANAGER
   - Navigate to /users
   - Verify redirect to /dashboard or unauthorized message

2. **Users Table Display:**
   - Login as HR_ADMIN
   - Navigate to /users
   - Verify table displays with columns: Username, Email, Role, Status, Actions
   - Verify existing users from database are displayed
   - Verify Active status shows green Chip, Inactive shows gray Chip

3. **Create User Modal:**
   - Click "Create User" button
   - Verify modal opens with form fields
   - Verify form has: username, email, password, role dropdown
   - Verify role dropdown has all 4 options

4. **Form Validation:**
   - Leave all fields empty, click "Create User"
   - Verify validation errors appear under each field
   - Enter invalid email format (e.g., "notanemail")
   - Verify email validation error appears
   - Enter valid email, verify error clears

5. **Successful User Creation:**
   - Fill all fields with valid data:
     - Username: testuser
     - Email: testuser@magnab.com
     - Password: Test123!
     - Role: LINE_MANAGER
   - Click "Create User"
   - Verify modal closes
   - Verify success Snackbar appears
   - Verify new user appears in users table

6. **Duplicate Username Error:**
   - Click "Create User" button again
   - Enter same username as existing user
   - Fill other fields with valid data
   - Click "Create User"
   - Verify error message displays: "Username already exists"
   - Verify modal remains open

7. **Search/Filter Functionality:**
   - In search field, type existing username
   - Verify table filters to show only matching users
   - Clear search field, verify all users display again
   - Type existing email in search field
   - Verify table filters to show matching user

8. **Placeholder Action Buttons:**
   - Click "Edit" icon button on a user row
   - Verify Snackbar appears with "Not implemented yet" message
   - Click "Deactivate" icon button on a user row
   - Verify Snackbar appears with "Not implemented yet" message

9. **Loading and Empty States:**
   - Observe loading spinner while users are being fetched
   - If testing with empty database, verify empty state message displays

**Automated Testing:** Will be added in Story 1.8 with Jest and React Testing Library

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Story created from Epic 1 with streamlined architecture context for fast-track development | Bob (Scrum Master) |
| 2025-10-30 | 1.1 | Story validated and approved for implementation (Readiness Score: 9.7/10, HIGH confidence, zero hallucinations) | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
