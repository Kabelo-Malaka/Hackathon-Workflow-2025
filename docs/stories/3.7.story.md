# Story 3.7: Initiate Workflow UI (HR Admin)

## Status
**Approved**

## Story

**As an** HR Administrator,
**I want** a page where I can initiate new onboarding/offboarding workflows by selecting a template and entering employee details,
**so that** I can start the automated employee transition process.

## Acceptance Criteria

1. "Initiate Workflow" page includes template selection dropdown (filtered by active templates only)
2. Once template is selected, form dynamically renders custom fields defined in that template
3. Static fields are displayed: Employee Name (required), Employee Email (required), Employee Role (dropdown)
4. All custom fields render with appropriate input types (text, number, date picker, checkbox, dropdown)
5. Required custom fields are marked with asterisk and validated on submit
6. Conditional field logic is evaluated client-side (fields appear/disappear based on other field values)
7. "Initiate Workflow" button submits form to POST /api/workflows
8. Successful initiation displays success notification with workflow ID and redirects to workflow detail view
9. Failed initiation displays validation errors inline
10. Form includes "Cancel" button to return to dashboard
11. Material-UI form components provide consistent styling

## Tasks / Subtasks

- [ ] **Task 1: Create InitiateWorkflowPage component** (AC: 1, 3, 10, 11)
  - [ ] Create InitiateWorkflowPage.tsx in src/features/workflows/
  - [ ] Use Material-UI Container, Paper, Typography for page layout
  - [ ] Add PageHeader component with title "Initiate Workflow"
  - [ ] Include navigation breadcrumbs (Dashboard > Workflows > Initiate)
  - [ ] Render form using React Hook Form
  - [ ] Add Cancel button that navigates to /dashboard
  - [ ] Reference: [Source: docs/ui-architecture/3-project-structure.md - Feature-based structure]

- [ ] **Task 2: Add template selection dropdown** (AC: 1)
  - [ ] Fetch active templates using RTK Query (GET /api/templates?active=true)
  - [ ] Render Material-UI Select component with template options
  - [ ] Display template name and workflow type (ONBOARDING/OFFBOARDING)
  - [ ] Set required validation on template selection
  - [ ] Store selected template in React Hook Form state
  - [ ] Reference: [Source: docs/ui-architecture/6-api-integration.md - RTK Query for data fetching]

- [ ] **Task 3: Implement dynamic custom field rendering** (AC: 2, 4)
  - [ ] When template is selected, fetch template details including custom fields
  - [ ] Use React Hook Form useFieldArray for dynamic fields
  - [ ] Map custom field types to Material-UI components: TEXT→TextField, NUMBER→TextField(type=number), DATE→DatePicker, BOOLEAN→Checkbox, SELECT→Select
  - [ ] Render fields in order defined by template
  - [ ] Apply field labels and help text from template
  - [ ] Reference: [Source: docs/ui-architecture/2-frontend-tech-stack.md - React Hook Form + Yup]

- [ ] **Task 4: Add static employee fields** (AC: 3)
  - [ ] Add TextField for Employee Name (required, @NotBlank validation)
  - [ ] Add TextField for Employee Email (required, @Email validation)
  - [ ] Add Select for Employee Role with options: Software Engineer, Manager, HR Admin, Tech Support
  - [ ] Use React Hook Form register() for form binding
  - [ ] Apply Yup schema validation
  - [ ] Reference: [Source: docs/ui-architecture/4-component-standards.md - Form components]

- [ ] **Task 5: Implement required field validation** (AC: 5)
  - [ ] Mark required custom fields with asterisk using Material-UI InputLabel
  - [ ] Use Yup schema to validate required fields on submit
  - [ ] Display inline error messages using Material-UI FormHelperText
  - [ ] Prevent form submission if validation fails
  - [ ] Reference: [Source: docs/ui-architecture/2-frontend-tech-stack.md - Yup validation]

- [ ] **Task 6: Implement client-side conditional logic preview** (AC: 6)
  - [ ] Use React Hook Form watch() API to monitor custom field values
  - [ ] Evaluate conditional rules client-side (e.g., if remote=true, hide officeSetup field)
  - [ ] Show/hide fields dynamically based on rule evaluation
  - [ ] Display "(Conditional)" label next to conditional fields
  - [ ] NOTE: Client-side evaluation is preview only; server evaluates authoritatively
  - [ ] Reference: [Source: docs/ui-architecture/5-state-management.md - Conditional logic evaluation strategy]

- [ ] **Task 7: Add initiateWorkflow mutation to workflowsApi** (AC: 7)
  - [ ] In src/features/workflows/workflowsApi.ts, add RTK Query mutation
  - [ ] Define mutation: initiateWorkflow with endpoint POST /api/workflows
  - [ ] Map form data to InitiateWorkflowRequest DTO: { templateId, employeeName, employeeEmail, employeeRole, customFieldValues }
  - [ ] Configure mutation to invalidate workflows list cache on success
  - [ ] Reference: [Source: docs/ui-architecture/6-api-integration.md - RTK Query mutations]

- [ ] **Task 8: Handle form submission** (AC: 7, 8)
  - [ ] Create handleSubmit function using React Hook Form
  - [ ] On submit, call initiateWorkflow mutation with form data
  - [ ] Show loading spinner while mutation is pending
  - [ ] On success, display Material-UI Snackbar with success message including workflow ID
  - [ ] On success, navigate to workflow detail page (/workflows/{id})
  - [ ] Use React Router useNavigate() hook for navigation
  - [ ] Reference: [Source: docs/ui-architecture/7-routing.md - React Router navigation]

- [ ] **Task 9: Handle validation errors** (AC: 9)
  - [ ] If mutation returns 400 Bad Request, extract validation errors from response
  - [ ] Display errors inline using React Hook Form setError()
  - [ ] Show field-level errors next to corresponding inputs
  - [ ] Display general errors in Material-UI Alert component at top of form
  - [ ] Reference: [Source: docs/ui-architecture/6-api-integration.md - Error handling]

- [ ] **Task 10: Add TypeScript types** (AC: 1-11)
  - [ ] Define InitiateWorkflowFormData interface with all form fields
  - [ ] Define TemplateCustomField interface for dynamic fields
  - [ ] Define ConditionalRule interface for client-side evaluation
  - [ ] Export types from src/features/workflows/types.ts
  - [ ] Reference: [Source: docs/ui-architecture/4-component-standards.md - TypeScript interfaces]

- [ ] **Task 11: Add routing for Initiate Workflow page** (AC: 10)
  - [ ] In src/App.tsx, add protected route /workflows/initiate
  - [ ] Protect route with HR_ADMIN role check
  - [ ] Redirect non-HR_ADMIN users to dashboard with error message
  - [ ] Reference: [Source: docs/ui-architecture/7-routing.md - Protected routes]

- [ ] **Task 12: Write unit tests for InitiateWorkflowPage** (AC: 1-11)
  - [ ] Create InitiateWorkflowPage.test.tsx in src/features/workflows/__tests__/
  - [ ] Use React Testing Library and Jest
  - [ ] Test: Renders template dropdown with active templates
  - [ ] Test: Dynamic fields render when template is selected
  - [ ] Test: Required field validation works
  - [ ] Test: Conditional fields show/hide based on values
  - [ ] Test: Form submission calls initiateWorkflow mutation
  - [ ] Test: Success shows notification and redirects
  - [ ] Test: Validation errors display inline
  - [ ] Test: Cancel button navigates to dashboard
  - [ ] Reference: [Source: docs/ui-architecture/9-testing-requirements.md - Component testing]

- [ ] **Task 13: Write integration test for workflow initiation flow** (AC: 1-11)
  - [ ] Create workflowInitiation.e2e.test.ts using Playwright
  - [ ] Test: HR Admin can select template, fill form, and initiate workflow
  - [ ] Test: Dynamic fields appear when template is selected
  - [ ] Test: Conditional logic hides/shows fields correctly
  - [ ] Test: Form validation prevents submission with missing required fields
  - [ ] Test: Successful initiation redirects to workflow detail page
  - [ ] Reference: [Source: docs/ui-architecture/9-testing-requirements.md - E2E testing with Playwright]

## Dev Notes

### Previous Story Context

**Story 3.5: Workflow Initiation API (Approved)**

Story 3.5 created the backend API endpoint that Story 3.7 will call:
- POST /api/workflows accepts InitiateWorkflowRequest DTO
- Returns 201 Created with WorkflowInitiationResponse DTO
- Validates template exists and is active
- Validates required custom fields are provided
- Only HR_ADMIN role can initiate workflows (403 Forbidden for others)
- Story 3.7 builds the frontend UI that calls this API

**Integration Pattern:**
Story 3.7 creates the user-facing form that:
1. Fetches active templates from GET /api/templates
2. Dynamically renders custom fields based on selected template
3. Validates input client-side with React Hook Form + Yup
4. Submits to POST /api/workflows (from Story 3.5)
5. Displays success/error feedback and navigates to workflow detail

### Frontend Technology Stack
[Source: docs/ui-architecture/2-frontend-tech-stack.md]

**Core Technologies:**
- React 18.2.0 - UI framework with concurrent rendering
- TypeScript 5.3.3 - Type safety and excellent tooling
- Vite 5.0.12 - Fast build tool with HMR
- Material-UI 5.15.7 - Component library (Magna BC branding)

**Form Management:**
- React Hook Form 7.49.3 - Minimal re-renders, easy validation
- Yup 1.3.3 - Schema-based validation with TypeScript support

**State Management:**
- Redux Toolkit 2.1.0 - Global state management
- RTK Query 2.1.0 - Data fetching with automatic caching

**Routing:**
- React Router 6.21.3 - Client-side routing with protected routes

**HTTP Client:**
- Axios 1.6.5 - HTTP requests with interceptors

**Date Handling:**
- date-fns 3.2.0 - Date formatting and manipulation

**Testing:**
- Jest 29.7.0 + React Testing Library 14.1.2 - Unit/component tests
- Playwright 1.41.2 - End-to-end tests

### Project Structure
[Source: docs/ui-architecture/3-project-structure.md]

**Feature-Based Architecture:**
```
src/features/workflows/
├── workflowsSlice.ts           # Redux slice for workflow state
├── workflowsApi.ts             # RTK Query API (EXTEND - add initiateWorkflow mutation)
├── WorkflowListPage.tsx        # Existing list view
├── WorkflowDetailPage.tsx      # Existing detail view
├── InitiateWorkflowPage.tsx    # CREATE - New workflow initiation form
└── types.ts                    # TypeScript types (EXTEND)
```

**Component Structure:**
```
src/components/
├── common/
│   ├── Button.tsx              # Reusable button component
│   ├── PageHeader.tsx          # Page header with breadcrumbs
│   └── LoadingSpinner.tsx      # Loading indicator
└── forms/
    ├── FormInput.tsx           # React Hook Form text input wrapper
    ├── FormSelect.tsx          # React Hook Form select wrapper
    ├── FormDatePicker.tsx      # React Hook Form date picker wrapper
    └── FormCheckbox.tsx        # React Hook Form checkbox wrapper
```

### Component Standards
[Source: docs/ui-architecture/4-component-standards.md]

**Component Template Pattern:**
```typescript
import React from 'react';
import { Box, Typography } from '@mui/material';

interface InitiateWorkflowPageProps {
  // Props if needed
}

const InitiateWorkflowPage: React.FC<InitiateWorkflowPageProps> = () => {
  // Component implementation
};

export default InitiateWorkflowPage;
```

**Key Standards:**
- Use TypeScript interfaces for all props
- Include JSDoc comments for complex components
- Use Material-UI components for consistent styling
- Add data-testid attributes for testing
- Follow accessibility standards (WCAG 2.1 AA)

### State Management Strategy
[Source: docs/ui-architecture/5-state-management.md]

**State Types:**
1. **Form State (React Hook Form):** Template selection, employee details, custom field values
2. **Server State (RTK Query):** Active templates, workflow creation mutation
3. **UI State (useState):** Loading spinners, success/error notifications

**Conditional Logic Evaluation:**
- **Client-Side:** Preview only - show/hide fields based on current form values
- **Server-Side:** Authoritative - backend evaluates rules when creating workflow
- **Important:** Client evaluation is for UX only; server is source of truth

**Example:**
```typescript
// Client-side preview (non-authoritative)
const { watch } = useForm();
const isRemote = watch('remote');
const showOfficeSetup = !isRemote; // Preview which tasks will be created

// Server-side authority
// POST /api/workflows → backend evaluates all rules → sets is_visible flags
```

### API Integration
[Source: docs/ui-architecture/6-api-integration.md]

**RTK Query Mutation Pattern:**
```typescript
// In src/features/workflows/workflowsApi.ts
import { api } from '@/services/api.service';

export const workflowsApi = api.injectEndpoints({
  endpoints: (builder) => ({
    initiateWorkflow: builder.mutation<
      WorkflowInitiationResponse,
      InitiateWorkflowRequest
    >({
      query: (request) => ({
        url: '/workflows',
        method: 'POST',
        body: request,
      }),
      invalidatesTags: ['Workflows'],
    }),
  }),
});

export const { useInitiateWorkflowMutation } = workflowsApi;
```

**Form Submission Pattern:**
```typescript
const [initiateWorkflow, { isLoading }] = useInitiateWorkflowMutation();

const handleSubmit = async (data: InitiateWorkflowFormData) => {
  try {
    const response = await initiateWorkflow({
      templateId: data.templateId,
      employeeName: data.employeeName,
      employeeEmail: data.employeeEmail,
      employeeRole: data.employeeRole,
      customFieldValues: data.customFieldValues,
    }).unwrap();

    // Show success notification
    enqueueSnackbar(`Workflow ${response.workflowInstanceId} created successfully`, {
      variant: 'success',
    });

    // Navigate to workflow detail page
    navigate(`/workflows/${response.workflowInstanceId}`);
  } catch (error) {
    // Handle validation errors
    if (error.status === 400) {
      // Display inline errors
    }
  }
};
```

### Form Management with React Hook Form
[Source: docs/ui-architecture/2-frontend-tech-stack.md]

**Dynamic Field Rendering:**
```typescript
import { useForm, useFieldArray } from 'react-hook-form';
import { yupResolver } from '@hookform/resolvers/yup';

const validationSchema = yup.object({
  templateId: yup.string().required('Template is required'),
  employeeName: yup.string().required('Employee name is required'),
  employeeEmail: yup.string().email().required('Employee email is required'),
  employeeRole: yup.string().required('Employee role is required'),
  customFieldValues: yup.object(),
});

const { register, handleSubmit, watch, formState: { errors } } = useForm({
  resolver: yupResolver(validationSchema),
});

// Watch template selection to load custom fields
const selectedTemplateId = watch('templateId');

// Render dynamic fields based on template
{template.customFields.map(field => (
  <FormInput
    key={field.id}
    label={field.label}
    required={field.required}
    type={field.fieldType === 'NUMBER' ? 'number' : 'text'}
    {...register(`customFieldValues.${field.name}`)}
    error={errors.customFieldValues?.[field.name]}
  />
))}
```

### Material-UI Styling
[Source: docs/ui-architecture/8-styling-guidelines.md]

**Magna BC Branding:**
- Primary Color: #1976d2 (Blue)
- Spacing: 8px grid system
- Typography: Roboto font family
- Accessibility: WCAG 2.1 AA compliant

**Form Layout Pattern:**
```typescript
<Container maxWidth="md">
  <Paper sx={{ p: 4, mt: 4 }}>
    <PageHeader title="Initiate Workflow" />
    <Box component="form" onSubmit={handleSubmit(onSubmit)}>
      <FormControl fullWidth margin="normal">
        <InputLabel required>Template</InputLabel>
        <Select {...register('templateId')}>
          {templates.map(t => (
            <MenuItem key={t.id} value={t.id}>{t.name}</MenuItem>
          ))}
        </Select>
      </FormControl>

      {/* Dynamic fields render here */}

      <Box sx={{ mt: 3, display: 'flex', gap: 2 }}>
        <Button variant="contained" type="submit" disabled={isLoading}>
          Initiate Workflow
        </Button>
        <Button variant="outlined" onClick={() => navigate('/dashboard')}>
          Cancel
        </Button>
      </Box>
    </Box>
  </Paper>
</Container>
```

### Error Handling
[Source: docs/ui-architecture/6-api-integration.md]

**Validation Error Display:**
```typescript
// Field-level errors
<TextField
  {...register('employeeName')}
  error={!!errors.employeeName}
  helperText={errors.employeeName?.message}
/>

// Form-level errors from API
{mutationError && (
  <Alert severity="error" sx={{ mb: 2 }}>
    {mutationError.data?.message || 'Failed to initiate workflow'}
  </Alert>
)}
```

**Success Notification:**
```typescript
import { useSnackbar } from 'notistack';

const { enqueueSnackbar } = useSnackbar();

enqueueSnackbar(`Workflow ${workflowId} created successfully`, {
  variant: 'success',
  autoHideDuration: 5000,
});
```

### Routing and Navigation
[Source: docs/ui-architecture/7-routing.md]

**Protected Route Pattern:**
```typescript
// In App.tsx
import RoleBasedRoute from '@/routes/RoleBasedRoute';

<Route element={<RoleBasedRoute allowedRoles={['HR_ADMIN']} />}>
  <Route path="/workflows/initiate" element={<InitiateWorkflowPage />} />
</Route>
```

**Navigation After Success:**
```typescript
import { useNavigate } from 'react-router-dom';

const navigate = useNavigate();

// Navigate to workflow detail page
navigate(`/workflows/${workflowId}`);

// Navigate back to dashboard
navigate('/dashboard');
```

### TypeScript Types
[Source: docs/ui-architecture/4-component-standards.md]

**Form Data Interface:**
```typescript
interface InitiateWorkflowFormData {
  templateId: string;
  employeeName: string;
  employeeEmail: string;
  employeeRole: string;
  customFieldValues: Record<string, any>;
}

interface TemplateCustomField {
  id: string;
  name: string;
  label: string;
  fieldType: 'TEXT' | 'NUMBER' | 'DATE' | 'BOOLEAN' | 'SELECT';
  required: boolean;
  defaultValue?: string;
  selectOptions?: string[];
}

interface ConditionalRule {
  id: string;
  targetFieldName: string;
  operator: 'EQUALS' | 'NOT_EQUALS' | 'CONTAINS';
  value: string;
}
```

### Accessibility Requirements
[Source: docs/ui-architecture/4-component-standards.md]

**WCAG 2.1 AA Compliance:**
- All form inputs have associated labels (Material-UI InputLabel)
- Required fields marked with asterisk and aria-required
- Error messages linked to inputs via aria-describedby
- Keyboard navigation supported (Tab, Enter, Escape)
- Focus indicators visible for all interactive elements
- Color contrast meets AA standards (4.5:1 for normal text)

## Testing

### Testing Approach for This Story
[Source: docs/ui-architecture/9-testing-requirements.md]

**Unit/Component Tests (Jest + React Testing Library):**
- Test file: src/features/workflows/__tests__/InitiateWorkflowPage.test.tsx
- Focus on component behavior, form validation, API interactions
- Mock RTK Query hooks and React Router navigation

**Test Scenarios:**
1. Template dropdown renders with active templates
2. Dynamic custom fields render when template is selected
3. Required field validation prevents submission
4. Conditional fields show/hide based on form values
5. Form submission calls initiateWorkflow mutation with correct data
6. Success shows notification with workflow ID
7. Success navigates to workflow detail page
8. Validation errors display inline
9. API errors display in Alert component
10. Cancel button navigates to dashboard

**E2E Tests (Playwright):**
- Test file: e2e/workflowInitiation.test.ts
- Test complete user flow from template selection to workflow creation
- Verify dynamic field rendering and conditional logic
- Test form validation and error handling
- Verify navigation after success

**Example Component Test:**
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { InitiateWorkflowPage } from './InitiateWorkflowPage';

describe('InitiateWorkflowPage', () => {
  it('renders template dropdown with active templates', async () => {
    render(<InitiateWorkflowPage />);

    const dropdown = screen.getByLabelText(/template/i);
    expect(dropdown).toBeInTheDocument();

    await waitFor(() => {
      expect(screen.getByText('Onboarding Template')).toBeInTheDocument();
    });
  });

  it('shows dynamic fields when template is selected', async () => {
    const user = userEvent.setup();
    render(<InitiateWorkflowPage />);

    const dropdown = screen.getByLabelText(/template/i);
    await user.click(dropdown);
    await user.click(screen.getByText('Onboarding Template'));

    await waitFor(() => {
      expect(screen.getByLabelText(/start date/i)).toBeInTheDocument();
    });
  });

  it('submits form with correct data', async () => {
    const mockInitiate = jest.fn().mockResolvedValue({ workflowInstanceId: '123' });
    jest.mock('./workflowsApi', () => ({
      useInitiateWorkflowMutation: () => [mockInitiate, { isLoading: false }],
    }));

    const user = userEvent.setup();
    render(<InitiateWorkflowPage />);

    // Fill form
    await user.type(screen.getByLabelText(/employee name/i), 'John Doe');
    await user.type(screen.getByLabelText(/employee email/i), 'john@example.com');

    // Submit
    await user.click(screen.getByRole('button', { name: /initiate workflow/i }));

    await waitFor(() => {
      expect(mockInitiate).toHaveBeenCalledWith(
        expect.objectContaining({
          employeeName: 'John Doe',
          employeeEmail: 'john@example.com',
        })
      );
    });
  });
});
```

**Coverage Goal:**
- Component coverage: 80%+ for InitiateWorkflowPage
- Run: `npm test -- --coverage`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 3 with complete workflow initiation UI specification. Includes React component with Material-UI, dynamic form rendering with React Hook Form, client-side conditional logic preview, RTK Query API integration with POST /api/workflows, comprehensive validation with Yup, and full unit and E2E testing requirements. Builds on Story 3.5 backend API. | Bob (Scrum Master) |
| 2025-10-31 | 1.1 | **PO Validation & Approval**: Comprehensive validation completed with 10/10 implementation readiness score. All 11 ACs covered by 13 tasks (118% coverage). All technical claims verified against architecture docs. One component name hallucination corrected (RequireRole → RoleBasedRoute). External dependencies satisfied (Story 3.5 Approved, Story 2.2 Done). Security patterns verified. Testing strategy comprehensive. Status updated: Draft → Approved. | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
