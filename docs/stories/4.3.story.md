# Story 4.3: Task Completion API

## Status
**Approved**

## Story

**As a** user (assigned task owner),
**I want** API endpoint to complete my assigned tasks with checklist verification,
**so that** I can mark my work complete once I've verified all items.

## Acceptance Criteria

1. API endpoint POST /api/tasks/{id}/complete accepts: checklist_items array (each with item_description, category, item_identifier, is_checked)
2. Only the assigned user or HR_ADMIN can complete a task (403 Forbidden for others)
3. Task must be in IN_PROGRESS status (400 Bad Request if NOT_STARTED or already COMPLETED)
4. Endpoint calls TaskService.completeTask() for business logic and validation
5. Successful completion returns 200 OK with updated task details and notification that dependent tasks were triggered
6. Failed validation (incomplete checklist) returns 400 Bad Request with specific error message
7. Endpoint supports partial save (POST /api/tasks/{id}/checklist to save progress without completing) allowing users to pause and resume
8. Partial save does not change task status (remains IN_PROGRESS)
9. Swagger documentation with example request showing checklist structure
10. API logs completion event for audit trail

## Tasks / Subtasks

- [ ] **Task 1: Create CompleteTaskRequest DTO** (AC: 1)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/dto/request/CompleteTaskRequest.java`
  - [ ] Add field: `private List<ChecklistItemDTO> checklistItems` (required)
  - [ ] Add Jakarta Bean Validation: `@NotNull @NotEmpty @Valid` on checklistItems list
  - [ ] ChecklistItemDTO already exists from Story 4.2 - reuse it
  - [ ] Use explicit getters/setters or Java record (no Lombok @Data on DTOs per coding standards)
  - [ ] Reference: [Source: docs/architecture/coding-standards.md - DTOs at API boundaries]

- [ ] **Task 2: Update or verify TaskCompletionResponse DTO exists** (AC: 5)
  - [ ] TaskCompletionResponse already created in Story 4.2
  - [ ] Verify it includes fields: taskInstanceId, taskName, status, completedAt, completedBy, checklistItemsVerified, offboardingMirrorCreated
  - [ ] No changes needed if Story 4.2 implemented correctly
  - [ ] Reference: [Source: Story 4.2 - TaskCompletionResponse DTO]

- [ ] **Task 3: Create SaveChecklistRequest DTO** (AC: 7)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/dto/request/SaveChecklistRequest.java`
  - [ ] Add field: `private List<ChecklistItemDTO> checklistItems` (required)
  - [ ] Add validation: `@NotNull @Valid` on list
  - [ ] This DTO used for partial save endpoint (AC #7)
  - [ ] Reference: [Source: docs/architecture/coding-standards.md - Validate all inputs]

- [ ] **Task 4: Create ChecklistSaveResponse DTO** (AC: 7, 8)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/dto/response/ChecklistSaveResponse.java`
  - [ ] Add fields:
    - `private UUID taskInstanceId`
    - `private Integer itemsSaved`
    - `private TaskStatus status` (should remain IN_PROGRESS)
    - `private String message` (e.g., "Checklist progress saved successfully")
  - [ ] Use explicit getters/setters or Java record
  - [ ] Reference: [Source: docs/architecture/coding-standards.md - Return DTO not entity]

- [ ] **Task 5: Add completeTask endpoint to TaskController** (AC: 1, 4, 5, 6)
  - [ ] Open/create file: `backend/src/main/java/com/magnab/employeelifecycle/controller/TaskController.java`
  - [ ] Add `@RestController` and `@RequestMapping("/api/tasks")` annotations
  - [ ] Inject TaskService via constructor: `private final TaskService taskService`
  - [ ] Add SLF4J logger: `private static final Logger log = LoggerFactory.getLogger(TaskController.class);`
  - [ ] Add endpoint method:
    ```java
    @PostMapping("/{id}/complete")
    @Operation(summary = "Complete a task with checklist verification",
               description = "Completes a task after validating all checklist items are checked. Only the assigned user or HR_ADMIN can complete tasks.")
    @ApiResponses(value = {
        @ApiResponse(responseCode = "200", description = "Task completed successfully"),
        @ApiResponse(responseCode = "400", description = "Validation failed - checklist incomplete or invalid task status"),
        @ApiResponse(responseCode = "403", description = "Forbidden - user not authorized to complete this task"),
        @ApiResponse(responseCode = "404", description = "Task not found")
    })
    public ResponseEntity<TaskCompletionResponse> completeTask(
        @PathVariable UUID id,
        @Valid @RequestBody CompleteTaskRequest request,
        @AuthenticationPrincipal User currentUser
    ) {
        log.info("Task completion request for task {} by user {}", id, currentUser.getId());
        // Implementation in subsequent tasks
    }
    ```
  - [ ] Reference: [Source: docs/architecture/source-tree.md - controller/ package]

- [ ] **Task 6: Implement authorization check in completeTask** (AC: 2)
  - [ ] Retrieve task to verify assignment:
    ```java
    TaskInstance task = taskService.getTaskById(id); // Assumes this method exists or use repository
    ```
  - [ ] Check authorization - Only assigned user OR HR_ADMIN can complete:
    ```java
    boolean isAssignedUser = task.getAssignedUserId().equals(currentUser.getId());
    boolean isHrAdmin = currentUser.getRole() == UserRole.HR_ADMIN;

    if (!isAssignedUser && !isHrAdmin) {
        log.warn("User {} attempted to complete task {} without authorization", currentUser.getId(), id);
        throw new ForbiddenException("Only the assigned user or HR Admin can complete this task");
    }
    ```
  - [ ] ForbiddenException should be caught by GlobalExceptionHandler and return 403
  - [ ] Reference: [Source: docs/architecture/error-handling-strategy.md - ForbiddenException 403]

- [ ] **Task 7: Call TaskService.completeTask and handle response** (AC: 4, 5, 6)
  - [ ] Call service method:
    ```java
    TaskCompletionResponse response = taskService.completeTask(
        id,
        request.getChecklistItems(),
        currentUser.getId()
    );
    ```
  - [ ] Return 200 OK with response:
    ```java
    log.info("Task {} completed successfully by user {}", id, currentUser.getId());
    return ResponseEntity.ok(response);
    ```
  - [ ] Service will throw ValidationException if checklist incomplete (AC #6) - GlobalExceptionHandler returns 400
  - [ ] Service will throw ValidationException if task status invalid (AC #3) - GlobalExceptionHandler returns 400
  - [ ] Service will throw ResourceNotFoundException if task not found - GlobalExceptionHandler returns 404
  - [ ] Reference: [Source: Story 4.2 - TaskService.completeTask method]

- [ ] **Task 8: Add saveChecklistProgress endpoint to TaskController** (AC: 7, 8)
  - [ ] Add endpoint method:
    ```java
    @PostMapping("/{id}/checklist")
    @Operation(summary = "Save checklist progress without completing task",
               description = "Allows users to save their checklist progress and resume later. Task status remains IN_PROGRESS.")
    @ApiResponses(value = {
        @ApiResponse(responseCode = "200", description = "Checklist progress saved successfully"),
        @ApiResponse(responseCode = "403", description = "Forbidden - user not authorized"),
        @ApiResponse(responseCode = "404", description = "Task not found")
    })
    public ResponseEntity<ChecklistSaveResponse> saveChecklistProgress(
        @PathVariable UUID id,
        @Valid @RequestBody SaveChecklistRequest request,
        @AuthenticationPrincipal User currentUser
    ) {
        log.info("Checklist save request for task {} by user {}", id, currentUser.getId());
        // Implementation in subsequent tasks
    }
    ```
  - [ ] Reference: [Source: docs/architecture/coding-standards.md - Validate all inputs]

- [ ] **Task 9: Implement authorization check in saveChecklistProgress** (AC: 7)
  - [ ] Retrieve task and verify authorization (same logic as completeTask):
    ```java
    TaskInstance task = taskService.getTaskById(id);
    boolean isAssignedUser = task.getAssignedUserId().equals(currentUser.getId());
    boolean isHrAdmin = currentUser.getRole() == UserRole.HR_ADMIN;

    if (!isAssignedUser && !isHrAdmin) {
        throw new ForbiddenException("Only the assigned user or HR Admin can save checklist progress");
    }
    ```
  - [ ] Reference: [Source: docs/architecture/error-handling-strategy.md - Consistent authorization pattern]

- [ ] **Task 10: Implement saveChecklistProgress logic** (AC: 7, 8)
  - [ ] Update task's checklistData field (JSONB) with progress:
    ```java
    task.setChecklistData(convertChecklistToJson(request.getChecklistItems()));
    taskService.saveTask(task); // Assumes this method exists or use repository
    ```
  - [ ] Build and return response:
    ```java
    ChecklistSaveResponse response = new ChecklistSaveResponse();
    response.setTaskInstanceId(id);
    response.setItemsSaved(request.getChecklistItems().size());
    response.setStatus(task.getStatus()); // Should remain IN_PROGRESS
    response.setMessage("Checklist progress saved successfully");

    log.info("Saved {} checklist items for task {}", request.getChecklistItems().size(), id);
    return ResponseEntity.ok(response);
    ```
  - [ ] Task status remains IN_PROGRESS (AC #8) - no status change
  - [ ] Reference: [Source: docs/architecture/data-models.md - TaskInstance.checklistData JSONB field]

- [ ] **Task 11: Add Swagger/OpenAPI annotations to DTOs** (AC: 9)
  - [ ] Add to CompleteTaskRequest:
    ```java
    @Schema(description = "Request to complete a task with checklist verification")
    public class CompleteTaskRequest {
        @Schema(description = "List of checklist items to verify", required = true, example = "[{\"itemDescription\":\"Laptop Dell XPS\",\"category\":\"HARDWARE\",\"itemIdentifier\":\"SN123456\",\"isChecked\":true}]")
        private List<ChecklistItemDTO> checklistItems;
    }
    ```
  - [ ] Add to ChecklistItemDTO (from Story 4.2):
    ```java
    @Schema(description = "Individual checklist item")
    public class ChecklistItemDTO {
        @Schema(description = "Description of the item", example = "Laptop Dell XPS")
        private String itemDescription;

        @Schema(description = "Category of the item", example = "HARDWARE")
        private ItemCategory category;

        @Schema(description = "Identifier like serial number or license key", example = "SN123456", nullable = true)
        private String itemIdentifier;

        @Schema(description = "Whether the item has been verified", example = "true")
        private Boolean isChecked;
    }
    ```
  - [ ] Reference: [Source: docs/architecture/tech-stack.md - SpringDoc OpenAPI 2.3.0]

- [ ] **Task 12: Add audit logging to completeTask endpoint** (AC: 10)
  - [ ] After successful completion, log audit event:
    ```java
    log.info("AUDIT: User {} completed task {} for workflow {}",
             currentUser.getId(), id, task.getWorkflowInstanceId());
    ```
  - [ ] Use structured logging (INFO level for audit trail)
  - [ ] Include: user ID, task ID, workflow ID
  - [ ] Reference: [Source: docs/architecture/error-handling-strategy.md - Logging standards]

- [ ] **Task 13: Write unit test for completeTask endpoint - success case** (AC: 5)
  - [ ] Create test file: `backend/src/test/java/com/magnab/employeelifecycle/controller/TaskControllerTest.java`
  - [ ] Use `@WebMvcTest(TaskController.class)`
  - [ ] Mock TaskService with `@MockBean`
  - [ ] Test: `completeTask_ValidRequest_Returns200()`
    - Arrange: Mock taskService.completeTask() to return TaskCompletionResponse
    - Arrange: Mock authorized user (assigned user or HR_ADMIN)
    - Act: POST /api/tasks/{id}/complete with valid checklist
    - Assert: 200 OK status, response body matches expected TaskCompletionResponse
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Controller integration tests]

- [ ] **Task 14: Write unit test for completeTask - authorization failure** (AC: 2)
  - [ ] Test: `completeTask_UnauthorizedUser_Returns403()`
    - Arrange: Mock task assigned to different user
    - Arrange: Mock current user is NOT assigned and NOT HR_ADMIN
    - Act: POST /api/tasks/{id}/complete
    - Assert: 403 Forbidden status
    - Assert: Error message "Only the assigned user or HR Admin can complete this task"
  - [ ] Reference: [Source: docs/architecture/error-handling-strategy.md - ForbiddenException]

- [ ] **Task 15: Write unit test for completeTask - incomplete checklist** (AC: 6)
  - [ ] Test: `completeTask_IncompleteChecklist_Returns400()`
    - Arrange: Mock taskService.completeTask() to throw ValidationException("All checklist items must be verified before completion")
    - Act: POST /api/tasks/{id}/complete with incomplete checklist
    - Assert: 400 Bad Request status
    - Assert: Error message contains "All checklist items must be verified"
  - [ ] Reference: [Source: Story 4.2 - ValidationException from service]

- [ ] **Task 16: Write unit test for completeTask - invalid task status** (AC: 3)
  - [ ] Test: `completeTask_TaskNotInProgress_Returns400()`
    - Arrange: Mock taskService.completeTask() to throw ValidationException("Task must be IN_PROGRESS to be completed")
    - Act: POST /api/tasks/{id}/complete
    - Assert: 400 Bad Request status
    - Assert: Error message contains validation failure reason
  - [ ] Reference: [Source: Story 4.2 - Task status validation]

- [ ] **Task 17: Write unit test for completeTask - task not found** (AC: 1)
  - [ ] Test: `completeTask_TaskNotFound_Returns404()`
    - Arrange: Mock taskService.getTaskById() to throw ResourceNotFoundException
    - Act: POST /api/tasks/{id}/complete
    - Assert: 404 Not Found status
  - [ ] Reference: [Source: docs/architecture/error-handling-strategy.md - ResourceNotFoundException]

- [ ] **Task 18: Write unit test for saveChecklistProgress - success** (AC: 7, 8)
  - [ ] Test: `saveChecklistProgress_ValidRequest_Returns200()`
    - Arrange: Mock authorized user
    - Arrange: Mock task status IN_PROGRESS
    - Act: POST /api/tasks/{id}/checklist with checklist items
    - Assert: 200 OK status
    - Assert: Response shows itemsSaved count, status remains IN_PROGRESS
    - Assert: Message "Checklist progress saved successfully"
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Controller tests]

- [ ] **Task 19: Write integration test for complete workflow** (AC: 1-10)
  - [ ] Create test file: `backend/src/test/java/com/magnab/employeelifecycle/controller/TaskControllerIntegrationTest.java`
  - [ ] Use `@SpringBootTest` and `@Testcontainers` with PostgreSQL
  - [ ] Use `@Autowired WebTestClient` or `MockMvc` for HTTP testing
  - [ ] Test: `completeTask_FullIntegration_CompletesTaskAndTriggersWorkflow()`
    - Arrange: Create real workflow, task, user in test database
    - Arrange: Authenticate as assigned user
    - Act: POST /api/tasks/{id}/complete with valid checklist
    - Assert: 200 OK response
    - Assert: Database shows task status COMPLETED
    - Assert: TaskChecklistItem records created
    - Assert: ProvisionedItem records created (if ONBOARDING)
    - Assert: Workflow state progressed if all tasks done
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - TestContainers integration tests]

- [ ] **Task 20: Verify Swagger UI documentation** (AC: 9)
  - [ ] Start application: `mvn spring-boot:run`
  - [ ] Navigate to Swagger UI: `http://localhost:8080/swagger-ui.html`
  - [ ] Verify POST /api/tasks/{id}/complete endpoint appears
  - [ ] Verify POST /api/tasks/{id}/checklist endpoint appears
  - [ ] Check example request shows checklist structure with all fields
  - [ ] Verify response codes documented: 200, 400, 403, 404
  - [ ] Test "Try it out" functionality with example payload
  - [ ] Reference: [Source: docs/architecture/tech-stack.md - SpringDoc OpenAPI 2.3.0]

- [ ] **Task 21: Manual API testing with Postman** (AC: 1-10)
  - [ ] Create Postman collection "Task Completion API Tests"
  - [ ] Test 1: Complete task with valid checklist (200 OK)
  - [ ] Test 2: Complete task with incomplete checklist (400 Bad Request)
  - [ ] Test 3: Unauthorized user attempts completion (403 Forbidden)
  - [ ] Test 4: Complete already completed task (400 Bad Request)
  - [ ] Test 5: Save checklist progress (200 OK, status remains IN_PROGRESS)
  - [ ] Test 6: Verify dependent tasks triggered after completion
  - [ ] Test 7: Verify offboarding mirror created for ONBOARDING workflow
  - [ ] Export Postman collection for team use
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Manual API testing with Postman]

## Dev Notes

### Previous Story Context

**Story 4.1: Task Checklist Data Model (Approved)**
- Created `task_checklist_items` and `provisioned_items` tables
- Created `TaskChecklistItem` and `ProvisionedItem` JPA entities
- Created `ItemCategory` enum (HARDWARE, SOFTWARE, ACCESS, OTHER)
- All repositories ready for use

**Story 4.2: Task Completion Service with Checklist Validation (Approved)**
- Created `TaskService.completeTask(taskInstanceId, checklistItems, userId)` method
- Validates all checklist items checked, persists to database
- Creates provisioned items for offboarding mirror (ONBOARDING workflows)
- Updates task status to COMPLETED, triggers workflow progression
- Created `ChecklistItemDTO` request DTO
- Created `TaskCompletionResponse` response DTO
- All service logic ready - this story adds REST API layer

**Epic 3 Stories Completed:**
- Story 3.1: Workflow Instance Data Model - TaskInstance entity available
- Story 3.3: Task Assignment & Routing Logic - assignTasksForWorkflow() method
- Story 3.4: Workflow State Management - checkAndCompleteWorkflow() method

**Key Dependencies Available:**
- `TaskService.completeTask()` - Complete service logic (Story 4.2)
- `TaskInstance` entity with assignedUserId, status fields
- `User` entity with role field (HR_ADMIN, etc.)
- `ChecklistItemDTO` - Request DTO for checklist items (Story 4.2)
- `TaskCompletionResponse` - Response DTO (Story 4.2)
- `GlobalExceptionHandler` - Centralized error handling

**Integration Points:**
- This story exposes TaskService.completeTask() via REST API
- Story 4.5 (Frontend Task Completion Form) will call these endpoints
- Story 4.4 (Email Notifications) will be triggered by task completion

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Backend Framework:**
- Spring Boot 3.2.2
- Java 17 LTS
- Spring Web (REST controllers)
- Spring Security 6.2.1 (authentication/authorization)

**API Documentation:**
- SpringDoc OpenAPI 2.3.0 for Swagger UI
- Automatic API spec generation
- Access at http://localhost:8080/swagger-ui.html

**Testing:**
- JUnit 5 (5.10.1) for unit tests
- MockMvc / WebTestClient for controller tests
- `@WebMvcTest` for controller-focused tests
- TestContainers 1.19.3 for integration tests
- Postman for manual API testing

**Key Dependencies:**
- Jakarta Bean Validation 3.0.2 for request validation (`@Valid`, `@NotNull`, `@NotEmpty`)
- SLF4J + Logback for logging

### Controller Layer Patterns
[Source: docs/architecture/coding-standards.md]

**Critical Controller Rules:**
1. **DTOs at API Boundaries:** Never expose entities in request/response (use DTOs)
2. **Validate All Inputs:** Use `@Valid` annotation on request bodies
3. **No Business Logic:** Controllers delegate to services (thin controller pattern)
4. **Constructor Injection:** Inject services via constructor (immutable, final fields)
5. **@RestControllerAdvice:** Exceptions caught by GlobalExceptionHandler
6. **Swagger Annotations:** Document all endpoints with `@Operation`, `@ApiResponses`

**Naming Conventions:**
- Controller class: `TaskController`
- Endpoint methods: `completeTask`, `saveChecklistProgress`
- DTOs: `CompleteTaskRequest`, `TaskCompletionResponse`, `SaveChecklistRequest`, `ChecklistSaveResponse`

**Authorization Pattern:**
- Use `@AuthenticationPrincipal User currentUser` to get authenticated user
- Check `task.getAssignedUserId().equals(currentUser.getId())` for task ownership
- Check `currentUser.getRole() == UserRole.HR_ADMIN` for admin access
- Throw `ForbiddenException` if unauthorized (403)

### API Endpoint Design
[Source: PRD Story 4.3]

**POST /api/tasks/{id}/complete**
- Purpose: Complete a task with mandatory checklist verification
- Request Body: `CompleteTaskRequest` with `checklistItems` array
- Authorization: Assigned user OR HR_ADMIN only
- Success Response: 200 OK with `TaskCompletionResponse`
- Error Responses:
  - 400 Bad Request: Incomplete checklist, invalid task status
  - 403 Forbidden: Unauthorized user
  - 404 Not Found: Task doesn't exist

**POST /api/tasks/{id}/checklist**
- Purpose: Save checklist progress without completing (partial save)
- Request Body: `SaveChecklistRequest` with `checklistItems` array
- Authorization: Assigned user OR HR_ADMIN only
- Success Response: 200 OK with `ChecklistSaveResponse`
- Task status: Remains IN_PROGRESS (no status change)
- Use case: User partially completes checklist, saves progress, comes back later to finish

### Error Handling
[Source: docs/architecture/error-handling-strategy.md]

**GlobalExceptionHandler:**
- Catches all exceptions from controller methods
- Returns consistent `ErrorResponse` structure
- Maps exceptions to HTTP status codes:
  - `ValidationException` → 400 Bad Request
  - `ForbiddenException` → 403 Forbidden
  - `ResourceNotFoundException` → 404 Not Found
  - `Exception` → 500 Internal Server Error

**Controller Error Strategy:**
- Controllers throw domain exceptions (ValidationException, ForbiddenException)
- GlobalExceptionHandler catches and converts to HTTP responses
- No try-catch blocks in controller methods (let exceptions bubble up)

**Error Response Structure:**
```java
{
  "timestamp": "2025-10-31T12:00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "All checklist items must be verified before completion",
  "path": "/api/tasks/123e4567-e89b-12d3-a456-426614174000/complete"
}
```

### Swagger/OpenAPI Documentation
[Source: docs/architecture/tech-stack.md - SpringDoc OpenAPI 2.3.0]

**Annotations to Use:**
- `@Operation(summary = "...", description = "...")` - Describes endpoint purpose
- `@ApiResponses` - Documents all possible response codes
- `@ApiResponse(responseCode = "200", description = "...")` - Documents specific response
- `@Schema(description = "...", example = "...")` - Documents DTO fields

**Example Request in Swagger:**
```json
{
  "checklistItems": [
    {
      "itemDescription": "Laptop Dell XPS",
      "category": "HARDWARE",
      "itemIdentifier": "SN123456",
      "isChecked": true
    },
    {
      "itemDescription": "MS 365 License",
      "category": "SOFTWARE",
      "itemIdentifier": "LIC789",
      "isChecked": true
    }
  ]
}
```

### File Locations
[Source: docs/architecture/source-tree.md]

**New Files to Create:**
```
backend/src/
├── main/java/com/magnab/employeelifecycle/
│   ├── controller/
│   │   └── TaskController.java                       # CREATE or MODIFY - REST controller
│   ├── dto/
│   │   ├── request/
│   │   │   ├── CompleteTaskRequest.java              # CREATE - Request DTO
│   │   │   └── SaveChecklistRequest.java             # CREATE - Request DTO
│   │   └── response/
│   │       └── ChecklistSaveResponse.java            # CREATE - Response DTO
└── test/java/com/magnab/employeelifecycle/
    └── controller/
        ├── TaskControllerTest.java                   # CREATE - Unit tests
        └── TaskControllerIntegrationTest.java        # CREATE - Integration tests
```

**Existing Files to Reference (DO NOT MODIFY unless needed):**
- DTOs from Story 4.2: ChecklistItemDTO, TaskCompletionResponse
- Service from Story 4.2: TaskService with completeTask() method
- Entities: TaskInstance, User
- Exception classes: ValidationException, ForbiddenException, ResourceNotFoundException
- GlobalExceptionHandler

### Authorization Logic
[Source: PRD AC #2, docs/architecture/error-handling-strategy.md]

**Who Can Complete Tasks:**
1. **Assigned User:** User with `task.getAssignedUserId() == currentUser.getId()`
2. **HR Admin:** User with `currentUser.getRole() == UserRole.HR_ADMIN`

**Authorization Check Pattern:**
```java
TaskInstance task = taskService.getTaskById(id);
boolean isAssignedUser = task.getAssignedUserId().equals(currentUser.getId());
boolean isHrAdmin = currentUser.getRole() == UserRole.HR_ADMIN;

if (!isAssignedUser && !isHrAdmin) {
    throw new ForbiddenException("Only the assigned user or HR Admin can complete this task");
}
```

**Why HR Admin Access:**
- HR admins can unblock workflows if assigned user is unavailable
- HR admins have oversight responsibility for all employee lifecycle workflows
- Audit trail still records actual user who performed completion

### Partial Save Feature
[Source: PRD AC #7, #8]

**Purpose:**
Allow users to save checklist progress without completing the task. Users can:
1. Start filling out checklist
2. Save progress (POST /api/tasks/{id}/checklist)
3. Close browser or switch tasks
4. Return later to continue where they left off
5. Complete task when all items verified

**Implementation:**
- Save checklist items to `TaskInstance.checklistData` JSONB field
- Task status remains IN_PROGRESS (AC #8)
- No validation that items are checked (user can save partial progress)
- No offboarding mirror creation (only happens on full completion)
- No workflow state changes

**Data Storage:**
- Use TaskInstance.checklistData JSONB column
- Convert List<ChecklistItemDTO> to JSON string
- Store as intermediate state until full completion

### Audit Logging
[Source: PRD AC #10, docs/architecture/error-handling-strategy.md]

**Logging Requirements:**
- INFO level: Successful task completion (audit trail)
- WARN level: Authorization failures
- Structured logging with key fields: userId, taskId, workflowId
- Example: `log.info("AUDIT: User {} completed task {} for workflow {}", userId, taskId, workflowId)`

**Audit Event Tracking:**
- Task completion logged at controller level (this story)
- Service layer logs business logic events (Story 4.2)
- Future: AuditService may persist to audit_events table (out of scope for this story)

### Project Structure Alignment
[Source: docs/architecture/source-tree.md]

All file paths align with the defined source tree structure:
- Controller in `backend/src/main/java/com/magnab/employeelifecycle/controller/`
- Request DTOs in `backend/src/main/java/com/magnab/employeelifecycle/dto/request/`
- Response DTOs in `backend/src/main/java/com/magnab/employeelifecycle/dto/response/`
- Controller tests in `backend/src/test/java/com/magnab/employeelifecycle/controller/`

TaskController already specified in architecture source tree (Line 49).

No structural conflicts or deviations from architecture guidelines.

## Testing

### Testing Approach for This Story
[Source: docs/architecture/test-strategy.md]

**Unit Tests (JUnit 5 + MockMvc):**
- Test file: `backend/src/test/java/com/magnab/employeelifecycle/controller/TaskControllerTest.java`
- Use `@WebMvcTest(TaskController.class)` for controller-focused testing
- Mock TaskService with `@MockBean`
- Use MockMvc for HTTP request simulation
- Coverage goal: All endpoints with success and error cases

**Test Scenarios (AC #1-10 requires these tests):**
1. ✅ Complete task success (200 OK)
2. ✅ Complete task - unauthorized user (403 Forbidden)
3. ✅ Complete task - incomplete checklist (400 Bad Request)
4. ✅ Complete task - invalid task status (400 Bad Request)
5. ✅ Complete task - task not found (404 Not Found)
6. ✅ Save checklist progress success (200 OK)

**Integration Tests (TestContainers):**
- Test file: `backend/src/test/java/com/magnab/employeelifecycle/controller/TaskControllerIntegrationTest.java`
- Use `@SpringBootTest` with `@Testcontainers`
- Real PostgreSQL 17.2-alpine container
- Real Spring Security context
- Verify end-to-end flow: HTTP request → controller → service → database

**Manual Testing (Postman):**
- Create Postman collection with all test scenarios
- Test happy paths and error cases
- Verify Swagger UI documentation accuracy
- Export collection for team use

**Example Unit Test Structure:**
```java
@WebMvcTest(TaskController.class)
class TaskControllerTest {
    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private TaskService taskService;

    @Test
    void completeTask_ValidRequest_Returns200() throws Exception {
        // Arrange
        UUID taskId = UUID.randomUUID();
        CompleteTaskRequest request = new CompleteTaskRequest();
        request.setChecklistItems(List.of(
            new ChecklistItemDTO("Laptop", ItemCategory.HARDWARE, "SN123", true)
        ));

        TaskCompletionResponse response = new TaskCompletionResponse();
        response.setTaskInstanceId(taskId);
        response.setStatus(TaskStatus.COMPLETED);

        when(taskService.completeTask(eq(taskId), anyList(), any(UUID.class)))
            .thenReturn(response);

        // Act & Assert
        mockMvc.perform(post("/api/tasks/" + taskId + "/complete")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request))
                .with(user("testuser")))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.taskInstanceId").value(taskId.toString()))
            .andExpect(jsonPath("$.status").value("COMPLETED"));
    }
}
```

**Coverage Verification:**
- Run: `mvn test jacoco:report`
- Check: `backend/target/site/jacoco/index.html`
- Goal: 80% coverage for controller layer

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.1 | Story validated and approved. Comprehensive validation completed: template compliance verified, all 10 ACs covered with 100% task mapping, complete REST API implementation with authorization pattern, Swagger documentation, comprehensive testing (6 unit + 1 integration + 7 Postman tests). Zero critical issues found. Implementation readiness score 10/10. Status updated from Draft to Approved. | Sarah (Product Owner) |
| 2025-10-31 | 1.0 | Story created from Epic 4 with complete REST API specification for task completion endpoints. Exposes TaskService.completeTask() via POST /api/tasks/{id}/complete with authorization checks (assigned user or HR_ADMIN). Includes partial save endpoint for checklist progress. Comprehensive Swagger documentation, unit tests, integration tests, and Postman collection. Foundation for Frontend Task Completion Form (Story 4.5). | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
