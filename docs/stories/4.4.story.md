# Story 4.4: Email Notification Service & Templates

## Status
**Approved**

## Story

**As a** backend developer,
**I want** email notification service that sends task assignment and completion emails via Gmail SMTP,
**so that** users are notified when they have tasks to complete and when tasks are completed by others.

## Acceptance Criteria

1. NotificationService class implements email sending via Spring Mail and JavaMail
2. SMTP configuration uses environment variables: SMTP_HOST (smtp.gmail.com), SMTP_PORT (587), SMTP_USERNAME (ctrlalteliteg@gmail.com), SMTP_PASSWORD (app-specific password)
3. Service includes method sendTaskAssignmentEmail(taskInstance, assignedUser) that sends HTML email to assigned user
4. Task assignment email includes: employee name, workflow type, task name/description, direct link to task completion form (deep link), due date
5. Service includes method sendTaskCompletionEmail(taskInstance, stakeholders) that notifies relevant users when task is complete
6. Email templates are stored in src/main/resources/templates/ as HTML with Thymeleaf placeholders
7. Emails include text-only fallback for clients that don't support HTML
8. Email sending is asynchronous (uses @Async) to avoid blocking API requests
9. Failed email sends are logged but don't fail the transaction (retry logic: max 3 retries with exponential backoff)
10. Service logs all email attempts (recipient, subject, timestamp, success/failure) for audit and debugging
11. Unit tests use test SMTP server or mocking to validate email generation without actual sending

## Tasks / Subtasks

- [ ] **Task 1: Create NotificationService class** (AC: 1)
  - [ ] Create new file: `backend/src/main/java/com/magnab/employeelifecycle/service/NotificationService.java`
  - [ ] Add `@Service` annotation
  - [ ] Use constructor injection for dependencies:
    - `private final JavaMailSender mailSender`
    - `private final TemplateEngine templateEngine` (Thymeleaf for HTML templates)
  - [ ] Add SLF4J logger: `private static final Logger log = LoggerFactory.getLogger(NotificationService.class);`
  - [ ] Add `@Value("${app.frontend.url}")` for deep link base URL
  - [ ] Reference: [Source: docs/architecture/source-tree.md - service/ package]

- [ ] **Task 2: Configure SMTP settings in application.yml** (AC: 2)
  - [ ] Open file: `backend/src/main/resources/application.yml`
  - [ ] Add Spring Mail configuration:
    ```yaml
    spring:
      mail:
        host: ${SMTP_HOST:smtp.gmail.com}
        port: ${SMTP_PORT:587}
        username: ${SMTP_USERNAME:ctrlalteliteg@gmail.com}
        password: ${SMTP_PASSWORD}
        properties:
          mail:
            smtp:
              auth: true
              starttls:
                enable: true
                required: true
            debug: false

    app:
      frontend:
        url: ${FRONTEND_URL:http://localhost:3000}
    ```
  - [ ] Environment variables: SMTP_PASSWORD must be set in .env or environment
  - [ ] Reference: [Source: docs/architecture/tech-stack.md - Spring Mail + JavaMail 2.1.0]

- [ ] **Task 3: Create task-assignment-email.html Thymeleaf template** (AC: 3, 4, 6, 7)
  - [ ] Create new file: `backend/src/main/resources/templates/task-assignment-email.html`
  - [ ] Add Thymeleaf HTML template with placeholders:
    ```html
    <!DOCTYPE html>
    <html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>New Task Assigned</title>
    </head>
    <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
        <div style="max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f4;">
            <div style="background-color: white; padding: 20px; border-radius: 8px;">
                <h2 style="color: #2563eb;">New Task Assigned: <span th:text="${taskName}"></span></h2>

                <p>Hello <span th:text="${assignedUserName}"></span>,</p>

                <p>You have been assigned a new task for <strong th:text="${employeeName}"></strong>'s <span th:text="${workflowType}"></span> workflow.</p>

                <div style="background-color: #f9fafb; padding: 15px; border-left: 4px solid #2563eb; margin: 20px 0;">
                    <p><strong>Task:</strong> <span th:text="${taskName}"></span></p>
                    <p><strong>Description:</strong> <span th:text="${taskDescription}"></span></p>
                    <p th:if="${dueDate}"><strong>Due Date:</strong> <span th:text="${dueDate}"></span></p>
                </div>

                <p>
                    <a th:href="${taskLink}" style="display: inline-block; padding: 12px 24px; background-color: #2563eb; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
                        Complete Task
                    </a>
                </p>

                <p style="font-size: 12px; color: #6b7280; margin-top: 30px;">
                    This is an automated notification from the Employee Lifecycle Management System.
                </p>
            </div>
        </div>
    </body>
    </html>
    ```
  - [ ] Add text-only fallback in email (AC #7) - handled in sendEmail method
  - [ ] Reference: [Source: docs/architecture/source-tree.md - templates/ directory Line 95-97]

- [ ] **Task 4: Create task-completion-email.html Thymeleaf template** (AC: 5, 6, 7)
  - [ ] Create new file: `backend/src/main/resources/templates/task-completion-email.html`
  - [ ] Add Thymeleaf HTML template:
    ```html
    <!DOCTYPE html>
    <html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Task Completed</title>
    </head>
    <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
        <div style="max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f4;">
            <div style="background-color: white; padding: 20px; border-radius: 8px;">
                <h2 style="color: #16a34a;">Task Completed: <span th:text="${taskName}"></span></h2>

                <p>Hello,</p>

                <p>A task for <strong th:text="${employeeName}"></strong>'s <span th:text="${workflowType}"></span> workflow has been completed.</p>

                <div style="background-color: #f0fdf4; padding: 15px; border-left: 4px solid #16a34a; margin: 20px 0;">
                    <p><strong>Task:</strong> <span th:text="${taskName}"></span></p>
                    <p><strong>Completed By:</strong> <span th:text="${completedByName}"></span></p>
                    <p><strong>Completed At:</strong> <span th:text="${completedAt}"></span></p>
                    <p th:if="${checklistItemsVerified}"><strong>Items Verified:</strong> <span th:text="${checklistItemsVerified}"></span></p>
                </div>

                <p>
                    <a th:href="${workflowLink}" style="display: inline-block; padding: 12px 24px; background-color: #16a34a; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
                        View Workflow
                    </a>
                </p>

                <p style="font-size: 12px; color: #6b7280; margin-top: 30px;">
                    This is an automated notification from the Employee Lifecycle Management System.
                </p>
            </div>
        </div>
    </body>
    </html>
    ```
  - [ ] Reference: [Source: docs/architecture/source-tree.md - templates/ directory]

- [ ] **Task 5: Implement sendTaskAssignmentEmail method** (AC: 3, 4, 8, 9, 10)
  - [ ] Add method to NotificationService:
    ```java
    @Async
    @Retryable(
        value = {MailException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public void sendTaskAssignmentEmail(TaskInstance taskInstance, User assignedUser) {
        try {
            log.info("Sending task assignment email for task {} to user {}",
                     taskInstance.getId(), assignedUser.getEmail());

            // Prepare template context
            Context context = new Context();
            context.setVariable("taskName", taskInstance.getTaskName());
            context.setVariable("assignedUserName", assignedUser.getUsername());
            context.setVariable("employeeName", taskInstance.getWorkflowInstance().getEmployeeName());
            context.setVariable("workflowType", taskInstance.getWorkflowInstance().getWorkflowType());
            context.setVariable("taskDescription", taskInstance.getDescription());
            context.setVariable("dueDate", taskInstance.getDueDate() != null ?
                                formatDate(taskInstance.getDueDate()) : null);
            context.setVariable("taskLink", frontendUrl + "/tasks/" + taskInstance.getId() + "/complete");

            // Render HTML email
            String htmlContent = templateEngine.process("task-assignment-email", context);

            // Create email message
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
            helper.setTo(assignedUser.getEmail());
            helper.setSubject("New Task Assigned: " + taskInstance.getTaskName());
            helper.setText(htmlContent, true); // true = HTML

            // Send email
            mailSender.send(message);

            log.info("AUDIT: Task assignment email sent successfully to {}", assignedUser.getEmail());
        } catch (MailException e) {
            log.error("Failed to send task assignment email to {}: {}",
                      assignedUser.getEmail(), e.getMessage());
            throw e; // Rethrow for @Retryable
        } catch (Exception e) {
            log.error("Unexpected error sending email: {}", e.getMessage(), e);
            // Don't throw - failed email shouldn't break workflow
        }
    }
    ```
  - [ ] Add @Async annotation for asynchronous execution (AC #8)
  - [ ] Add @Retryable for retry logic with exponential backoff (AC #9)
  - [ ] Log all email attempts (AC #10)
  - [ ] Reference: [Source: docs/architecture/error-handling-strategy.md - Email retry logic Lines 57-69]

- [ ] **Task 6: Implement sendTaskCompletionEmail method** (AC: 5, 8, 9, 10)
  - [ ] Add method to NotificationService:
    ```java
    @Async
    @Retryable(
        value = {MailException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public void sendTaskCompletionEmail(TaskInstance taskInstance, List<User> stakeholders) {
        try {
            log.info("Sending task completion email for task {} to {} stakeholders",
                     taskInstance.getId(), stakeholders.size());

            // Prepare template context
            Context context = new Context();
            context.setVariable("taskName", taskInstance.getTaskName());
            context.setVariable("employeeName", taskInstance.getWorkflowInstance().getEmployeeName());
            context.setVariable("workflowType", taskInstance.getWorkflowInstance().getWorkflowType());
            context.setVariable("completedByName", taskInstance.getCompletedBy().getUsername());
            context.setVariable("completedAt", formatDate(taskInstance.getCompletedAt()));
            context.setVariable("checklistItemsVerified", taskInstance.getChecklistData());
            context.setVariable("workflowLink", frontendUrl + "/workflows/" +
                                taskInstance.getWorkflowInstanceId());

            // Render HTML email
            String htmlContent = templateEngine.process("task-completion-email", context);

            // Create and send email to each stakeholder
            for (User stakeholder : stakeholders) {
                try {
                    MimeMessage message = mailSender.createMimeMessage();
                    MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
                    helper.setTo(stakeholder.getEmail());
                    helper.setSubject("Task Completed: " + taskInstance.getTaskName());
                    helper.setText(htmlContent, true);

                    mailSender.send(message);
                    log.info("AUDIT: Task completion email sent to {}", stakeholder.getEmail());
                } catch (MailException e) {
                    log.error("Failed to send completion email to {}: {}",
                              stakeholder.getEmail(), e.getMessage());
                    // Continue sending to other stakeholders
                }
            }
        } catch (Exception e) {
            log.error("Unexpected error in sendTaskCompletionEmail: {}", e.getMessage(), e);
        }
    }
    ```
  - [ ] Send to multiple stakeholders (workflow initiator, task assigners, HR admins)
  - [ ] Reference: [Source: PRD AC #5]

- [ ] **Task 7: Enable async execution with @EnableAsync** (AC: 8)
  - [ ] Open/create file: `backend/src/main/java/com/magnab/employeelifecycle/config/AsyncConfig.java`
  - [ ] Add configuration:
    ```java
    @Configuration
    @EnableAsync
    public class AsyncConfig {
        @Bean(name = "taskExecutor")
        public Executor taskExecutor() {
            ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
            executor.setCorePoolSize(2);
            executor.setMaxPoolSize(5);
            executor.setQueueCapacity(100);
            executor.setThreadNamePrefix("async-email-");
            executor.initialize();
            return executor;
        }
    }
    ```
  - [ ] This enables @Async methods to run in background thread pool
  - [ ] Reference: [Source: docs/architecture/tech-stack.md - Spring @Async Line 38]

- [ ] **Task 8: Add text-only email fallback** (AC: 7)
  - [ ] Update sendTaskAssignmentEmail to include plain text:
    ```java
    String plainTextContent = "New Task Assigned: " + taskInstance.getTaskName() + "\n\n" +
                              "Employee: " + taskInstance.getWorkflowInstance().getEmployeeName() + "\n" +
                              "Task: " + taskInstance.getTaskName() + "\n" +
                              "Link: " + frontendUrl + "/tasks/" + taskInstance.getId() + "/complete";

    helper.setText(plainTextContent, htmlContent); // plainText, htmlText
    ```
  - [ ] Update sendTaskCompletionEmail similarly
  - [ ] Text fallback for email clients that don't support HTML
  - [ ] Reference: [Source: PRD AC #7]

- [ ] **Task 9: Add utility method for date formatting** (AC: 4, 5)
  - [ ] Add private method to NotificationService:
    ```java
    private String formatDate(LocalDateTime dateTime) {
        if (dateTime == null) return null;
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("MMM dd, yyyy 'at' hh:mm a");
        return dateTime.format(formatter);
    }
    ```
  - [ ] Format: "Oct 31, 2025 at 02:30 PM"
  - [ ] Reference: [Source: PRD AC #4 - due date formatting]

- [ ] **Task 10: Write unit test for sendTaskAssignmentEmail** (AC: 11)
  - [ ] Create test file: `backend/src/test/java/com/magnab/employeelifecycle/service/NotificationServiceTest.java`
  - [ ] Use `@ExtendWith(MockitoExtension.class)`
  - [ ] Mock dependencies: `@Mock JavaMailSender mailSender`, `@Mock TemplateEngine templateEngine`
  - [ ] Use `@InjectMocks NotificationService notificationService`
  - [ ] Test: `sendTaskAssignmentEmail_ValidInput_SendsEmail()`
    - Arrange: Create mock TaskInstance, User
    - Arrange: Mock templateEngine.process() to return HTML string
    - Arrange: Mock mailSender.createMimeMessage() and send()
    - Act: Call notificationService.sendTaskAssignmentEmail()
    - Assert: Verify mailSender.send() called
    - Assert: Verify email contains correct recipient, subject, task link
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Unit tests with mocking]

- [ ] **Task 11: Write unit test for sendTaskCompletionEmail** (AC: 11)
  - [ ] Test: `sendTaskCompletionEmail_MultipleStakeholders_SendsToAll()`
    - Arrange: Create mock TaskInstance, List<User> with 3 stakeholders
    - Arrange: Mock template rendering and mail sending
    - Act: Call notificationService.sendTaskCompletionEmail()
    - Assert: Verify mailSender.send() called 3 times (once per stakeholder)
    - Assert: Verify each email has correct recipient
  - [ ] Reference: [Source: PRD AC #5 - multiple stakeholders]

- [ ] **Task 12: Write unit test for email retry logic** (AC: 9)
  - [ ] Test: `sendTaskAssignmentEmail_MailException_RetriesThreeTimes()`
    - Arrange: Mock mailSender.send() to throw MailException
    - Act: Call sendTaskAssignmentEmail()
    - Assert: Verify send() called 3 times (1 original + 2 retries)
    - Assert: Verify exponential backoff delays (1s, 2s)
  - [ ] Use @Retryable test utilities or manual verification
  - [ ] Reference: [Source: docs/architecture/error-handling-strategy.md - Retry logic Lines 57-69]

- [ ] **Task 13: Write unit test for email failure logging** (AC: 9, 10)
  - [ ] Test: `sendTaskAssignmentEmail_PermanentFailure_LogsError()`
    - Arrange: Mock mailSender to throw exception after retries exhausted
    - Act: Call sendTaskAssignmentEmail()
    - Assert: Verify error log message contains recipient email and error
    - Assert: Verify no exception thrown (failed email doesn't break workflow)
  - [ ] Use LogCaptor or verify log statements
  - [ ] Reference: [Source: PRD AC #9 - failed email logs but doesn't fail transaction]

- [ ] **Task 14: Write integration test with test SMTP server** (AC: 11)
  - [ ] Create test file: `backend/src/test/java/com/magnab/employeelifecycle/service/NotificationServiceIntegrationTest.java`
  - [ ] Use `@SpringBootTest` with test SMTP configuration
  - [ ] Option 1: Use GreenMail test SMTP server:
    ```java
    @TestInstance(TestInstance.Lifecycle.PER_CLASS)
    @SpringBootTest
    class NotificationServiceIntegrationTest {
        @Autowired
        private NotificationService notificationService;

        private GreenMail greenMail;

        @BeforeAll
        void setupSMTP() {
            greenMail = new GreenMail(ServerSetupTest.SMTP);
            greenMail.start();
            greenMail.setUser("test@test.com", "password");
        }

        @AfterAll
        void tearDownSMTP() {
            greenMail.stop();
        }

        @Test
        void sendTaskAssignmentEmail_Integration_DeliversEmail() throws Exception {
            // Arrange: Create real TaskInstance, User
            // Act: Call notificationService.sendTaskAssignmentEmail()
            // Assert: Verify email received in GreenMail inbox
            assertTrue(greenMail.waitForIncomingEmail(5000, 1));
            MimeMessage[] messages = greenMail.getReceivedMessages();
            assertEquals(1, messages.length);
            assertTrue(messages[0].getContent().toString().contains("New Task Assigned"));
        }
    }
    ```
  - [ ] Add GreenMail dependency to pom.xml for testing
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Integration tests]

- [ ] **Task 15: Update application-test.yml for test SMTP** (AC: 11)
  - [ ] Open file: `backend/src/test/resources/application-test.yml`
  - [ ] Add test SMTP configuration:
    ```yaml
    spring:
      mail:
        host: localhost
        port: 3025
        username: test@test.com
        password: password
        properties:
          mail:
            smtp:
              auth: false
              starttls:
                enable: false
    ```
  - [ ] Test configuration points to GreenMail test server
  - [ ] Reference: [Source: PRD AC #11 - test SMTP server]

- [ ] **Task 16: Add .env.example with SMTP configuration** (AC: 2)
  - [ ] Open/create file: `.env.example` in project root
  - [ ] Add SMTP environment variables:
    ```
    # SMTP Configuration for Gmail
    SMTP_HOST=smtp.gmail.com
    SMTP_PORT=587
    SMTP_USERNAME=ctrlalteliteg@gmail.com
    SMTP_PASSWORD=your-app-specific-password-here

    # Frontend URL for email deep links
    FRONTEND_URL=http://localhost:3000
    ```
  - [ ] Document how to generate Gmail app-specific password in README
  - [ ] Reference: [Source: docs/architecture/tech-stack.md - Gmail SMTP Lines 53-54]

- [ ] **Task 17: Manual testing with Gmail SMTP** (AC: 1-10)
  - [ ] Set up Gmail app-specific password (not regular password)
  - [ ] Configure .env with real credentials
  - [ ] Start application: `mvn spring-boot:run`
  - [ ] Trigger task assignment (via workflow instantiation or manual service call)
  - [ ] Verify email received in recipient's Gmail inbox
  - [ ] Check email formatting: HTML renders correctly, links work
  - [ ] Test text-only fallback: Disable HTML in email client, verify plain text shows
  - [ ] Test retry logic: Temporarily break SMTP credentials, verify retries logged
  - [ ] Check spam folder if email not in inbox
  - [ ] Reference: [Source: docs/architecture/test-strategy.md - Manual testing Lines 57-59]

## Dev Notes

### Previous Story Context

**Story 4.1: Task Checklist Data Model (Approved)**
- Created task_checklist_items and provisioned_items tables
- All data model ready for task completion tracking

**Story 4.2: Task Completion Service (Approved)**
- Created TaskService.completeTask() method
- Validates checklists, updates task status, triggers workflow progression
- This story's email service will be called when tasks are assigned/completed

**Story 4.3: Task Completion API (Approved)**
- Created REST endpoints: POST /api/tasks/{id}/complete
- Calls TaskService.completeTask()
- This story's email service will be triggered by API completion events

**Epic 3 Stories Completed:**
- Story 3.1: Workflow Instance Data Model - TaskInstance entity available
- Story 3.2: Workflow Instantiation Service - triggers task assignment
- Story 3.3: Task Assignment & Routing Logic - assigns tasks to users

**Integration Points:**
- Story 4.5 (Task Assignment Email Triggers) will call sendTaskAssignmentEmail()
- Story 4.6 (Email Sending on Task Events) will call sendTaskCompletionEmail()
- This story provides the foundation email service for Stories 4.5 and 4.6

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Email Framework:**
- Spring Mail + JavaMail 2.1.0
- Gmail SMTP server: smtp.gmail.com:587
- Gmail account: ctrlalteliteg@gmail.com
- App-specific password required (not regular Gmail password)

**Template Engine:**
- Thymeleaf (included with Spring Boot)
- HTML templates with placeholders
- Server-side rendering for email content

**Async Execution:**
- Spring @Async (via Spring Boot)
- Thread pool for background email sending
- Prevents blocking of API requests

**Testing:**
- JUnit 5 (5.10.1) for unit tests
- Mockito 5.8.0 for mocking JavaMailSender
- GreenMail or similar for integration tests with test SMTP server

**Key Dependencies:**
- Spring Boot 3.2.2
- Jakarta Mail API (via Spring Mail)
- Lombok 1.18.30 (optional for service)

### Service Layer Patterns
[Source: docs/architecture/coding-standards.md]

**Critical Service Rules:**
1. **Constructor Injection:** Inject JavaMailSender and TemplateEngine
2. **@Async Annotation:** Place on email methods for asynchronous execution
3. **@Retryable:** Add retry logic with exponential backoff
4. **Error Handling:** Failed emails log errors but don't throw exceptions to caller
5. **Audit Logging:** Log all email attempts (success/failure) at INFO level

**Naming Conventions:**
- Service class: `NotificationService`
- Methods: `sendTaskAssignmentEmail`, `sendTaskCompletionEmail`
- Configuration: `AsyncConfig` for @EnableAsync

### Email Design Patterns
[Source: PRD AC #3-7]

**Task Assignment Email Structure:**
- Subject: "New Task Assigned: {Task Name}"
- Recipient: Assigned user
- Content:
  - Greeting with user name
  - Employee name and workflow type
  - Task name and description
  - Due date (if set)
  - Direct link to task completion form (deep link)
  - Call-to-action button: "Complete Task"

**Task Completion Email Structure:**
- Subject: "Task Completed: {Task Name}"
- Recipients: Stakeholders (workflow initiator, HR admins)
- Content:
  - Employee name and workflow type
  - Task name
  - Completed by user name
  - Completed timestamp
  - Number of checklist items verified
  - Link to view workflow

**Deep Links:**
- Task completion form: `{frontendUrl}/tasks/{taskId}/complete`
- Workflow detail: `{frontendUrl}/workflows/{workflowId}`
- Frontend URL configured via environment variable

### SMTP Configuration
[Source: docs/architecture/tech-stack.md, PRD AC #2]

**Gmail SMTP Settings:**
- Host: smtp.gmail.com
- Port: 587 (TLS/STARTTLS)
- Authentication: Required
- STARTTLS: Required
- Account: ctrlalteliteg@gmail.com
- Password: App-specific password (NOT regular Gmail password)

**How to Generate App-Specific Password:**
1. Go to Google Account settings → Security
2. Enable 2-Step Verification if not already enabled
3. Go to "App passwords"
4. Generate new app password for "Mail" / "Other"
5. Copy 16-character password
6. Set as SMTP_PASSWORD environment variable

**Environment Variables:**
- SMTP_HOST (default: smtp.gmail.com)
- SMTP_PORT (default: 587)
- SMTP_USERNAME (default: ctrlalteliteg@gmail.com)
- SMTP_PASSWORD (required - no default)
- FRONTEND_URL (default: http://localhost:3000)

### Async and Retry Configuration
[Source: docs/architecture/error-handling-strategy.md, PRD AC #8, #9]

**@Async Configuration:**
- Enables background email sending
- Prevents blocking API requests
- Thread pool: 2-5 threads, queue capacity 100
- Thread name prefix: "async-email-"

**@Retryable Configuration:**
- Max attempts: 3 (1 original + 2 retries)
- Backoff: Exponential (1000ms, 2000ms)
- Retry on: MailException only
- Other exceptions: Log and skip (don't retry)

**Error Handling Strategy:**
- Email failures logged at ERROR level
- Failed emails don't throw exceptions to caller
- Transaction continues even if email fails
- Audit log records all attempts (success/failure)

**Why This Matters:**
- Email is supplementary, not critical
- Workflow shouldn't fail if email doesn't send
- Users can still complete tasks without email notification
- Audit trail for debugging email issues

### File Locations
[Source: docs/architecture/source-tree.md]

**New Files to Create:**
```
backend/src/
├── main/
│   ├── java/com/magnab/employeelifecycle/
│   │   ├── service/
│   │   │   └── NotificationService.java              # CREATE - Email service
│   │   └── config/
│   │       └── AsyncConfig.java                      # CREATE - Async configuration
│   └── resources/
│       ├── templates/                                # Email templates directory
│       │   ├── task-assignment-email.html            # CREATE - Assignment email
│       │   └── task-completion-email.html            # CREATE - Completion email
│       └── application.yml                           # MODIFY - Add SMTP config
└── test/
    ├── java/com/magnab/employeelifecycle/
    │   └── service/
    │       ├── NotificationServiceTest.java          # CREATE - Unit tests
    │       └── NotificationServiceIntegrationTest.java # CREATE - Integration tests
    └── resources/
        └── application-test.yml                      # MODIFY - Test SMTP config
```

**Existing Files to Reference:**
- Entity classes: TaskInstance, User, WorkflowInstance
- Service classes: TaskService, WorkflowService

### Project Structure Alignment
[Source: docs/architecture/source-tree.md]

All file paths align with the defined source tree structure:
- Service in `backend/src/main/java/com/magnab/employeelifecycle/service/`
- Config in `backend/src/main/java/com/magnab/employeelifecycle/config/`
- Email templates in `backend/src/main/resources/templates/` (Lines 95-97)
- Service tests in `backend/src/test/java/com/magnab/employeelifecycle/service/`

Templates directory already specified in architecture (Lines 95-97): task-assignment-email.html and task-completion-email.html.

No structural conflicts or deviations from architecture guidelines.

## Testing

### Testing Approach for This Story
[Source: docs/architecture/test-strategy.md]

**Unit Tests (JUnit 5 + Mockito):**
- Test file: `backend/src/test/java/com/magnab/employeelifecycle/service/NotificationServiceTest.java`
- Use `@ExtendWith(MockitoExtension.class)`
- Mock JavaMailSender and TemplateEngine
- Test email generation without actual SMTP sending
- Coverage goal: 80% for service layer

**Test Scenarios (AC #11 requires these tests):**
1. ✅ Send task assignment email successfully
2. ✅ Send task completion email to multiple stakeholders
3. ✅ Retry logic on MailException (3 attempts)
4. ✅ Email failure logging (doesn't throw exception)
5. ✅ Template rendering with correct placeholders

**Integration Tests (GreenMail Test SMTP):**
- Test file: `backend/src/test/java/com/magnab/employeelifecycle/service/NotificationServiceIntegrationTest.java`
- Use `@SpringBootTest` with GreenMail test SMTP server
- Verify actual email delivery to test inbox
- Test HTML rendering, links, formatting

**Manual Testing:**
- Use real Gmail SMTP with test email address
- Verify email received in Gmail inbox
- Test HTML rendering in Outlook, Gmail web, mobile
- Verify deep links work (click "Complete Task" button)
- Test text-only fallback

**Example Unit Test Structure:**
```java
@ExtendWith(MockitoExtension.class)
class NotificationServiceTest {
    @Mock
    private JavaMailSender mailSender;

    @Mock
    private TemplateEngine templateEngine;

    @InjectMocks
    private NotificationService notificationService;

    @Test
    void sendTaskAssignmentEmail_ValidInput_SendsEmail() throws Exception {
        // Arrange
        TaskInstance task = createMockTask();
        User user = createMockUser();
        MimeMessage mimeMessage = mock(MimeMessage.class);

        when(mailSender.createMimeMessage()).thenReturn(mimeMessage);
        when(templateEngine.process(eq("task-assignment-email"), any(Context.class)))
            .thenReturn("<html>Mock HTML</html>");

        // Act
        notificationService.sendTaskAssignmentEmail(task, user);

        // Assert
        verify(mailSender).send(mimeMessage);
        // Additional assertions for email content
    }
}
```

**Coverage Verification:**
- Run: `mvn test jacoco:report`
- Check: `backend/target/site/jacoco/index.html`
- Goal: 80% coverage for NotificationService

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | 1.0 | Story created from Epic 4 with complete email notification service specification. Implements NotificationService with sendTaskAssignmentEmail() and sendTaskCompletionEmail() methods using Spring Mail + JavaMail with Gmail SMTP. Includes Thymeleaf HTML email templates with text fallback, async execution with @Async, retry logic with exponential backoff, comprehensive unit and integration testing with test SMTP server. Foundation for Stories 4.5 and 4.6 email triggers. | Bob (Scrum Master) |
| 2025-10-31 | 1.1 | Story validated and approved. All 11 acceptance criteria verified with 100% task mapping. Implementation Readiness Score: 10/10. Zero hallucinations detected. 17 detailed tasks covering email service implementation with complete SMTP configuration, HTML templates, async execution, retry logic, and comprehensive testing strategy. Ready for development. | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
