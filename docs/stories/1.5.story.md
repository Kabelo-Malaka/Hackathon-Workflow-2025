# Story 1.5: User Management CRUD

## Status
**Approved**

## Story

**As an** HR Administrator,
**I want** to create, view, update, and deactivate user accounts with role assignments,
**so that** I can manage access for all system users (HR, managers, tech support, administrators).

## Acceptance Criteria

1. API endpoints exist for user CRUD: POST /api/users, GET /api/users, GET /api/users/{id}, PUT /api/users/{id}, DELETE /api/users/{id} (soft delete)
2. Only HR_ADMIN role can access user management endpoints (403 Forbidden for others)
3. User creation requires: username, email, initial password, role
4. Email validation ensures proper email format
5. Username must be unique (enforced at database and API level)
6. Update operation allows changing email, role, and active status (not password via this endpoint)
7. Delete operation sets is_active=false (soft delete) rather than removing record
8. Password change endpoint (POST /api/users/{id}/change-password) is separate and requires current password verification
9. All CRUD operations update audit columns (created_by, created_at, updated_by, updated_at)
10. API returns appropriate DTOs (not exposing password_hash)

## Tasks / Subtasks

- [ ] **Task 1: Create UserService business logic layer** (AC: 1, 3, 4, 5, 6, 7, 8, 9)
  - [ ] Create UserService.java in backend/src/main/java/com/magnab/employeelifecycle/service/
  - [ ] Implement createUser(CreateUserRequest) method with username uniqueness check and BCrypt password hashing
  - [ ] Implement getAllUsers() method returning list of users with active/inactive status
  - [ ] Implement getUserById(UUID id) method returning Optional<User> with ResourceNotFoundException if not found
  - [ ] Implement updateUser(UUID id, UpdateUserRequest) method for email, role, and isActive changes
  - [ ] Implement deactivateUser(UUID id) method setting is_active=false (soft delete)
  - [ ] Implement changePassword(UUID id, ChangePasswordRequest) method with current password verification using BCrypt
  - [ ] Add @Transactional annotation on all service methods
  - [ ] Use constructor injection for UserRepository and PasswordEncoder dependencies
  - [ ] Update audit columns (created_by, created_at, updated_by, updated_at) on all operations

- [ ] **Task 2: Create User DTOs for request/response** (AC: 3, 6, 8, 10)
  - [ ] Create CreateUserRequest.java in backend/src/main/java/com/magnab/employeelifecycle/dto/request/
  - [ ] Add fields: username, email, password, role with @NotBlank/@NotNull validation
  - [ ] Create UpdateUserRequest.java in backend/src/main/java/com/magnab/employeelifecycle/dto/request/
  - [ ] Add fields: email, role, isActive with appropriate validation
  - [ ] Create ChangePasswordRequest.java in backend/src/main/java/com/magnab/employeelifecycle/dto/request/
  - [ ] Add fields: currentPassword, newPassword with @NotBlank validation
  - [ ] Create UserResponse.java in backend/src/main/java/com/magnab/employeelifecycle/dto/response/
  - [ ] Add fields: id, username, email, role, isActive, createdAt, updatedAt (NO password_hash)
  - [ ] Use Lombok @Data on all DTOs

- [ ] **Task 3: Create UserController REST endpoints** (AC: 1, 2)
  - [ ] Create UserController.java in backend/src/main/java/com/magnab/employeelifecycle/controller/
  - [ ] Add @RestController and @RequestMapping("/api/users") annotations
  - [ ] Add @PreAuthorize("hasRole('HR_ADMIN')") on class level for role-based access control
  - [ ] Implement POST /api/users endpoint calling userService.createUser()
  - [ ] Implement GET /api/users endpoint calling userService.getAllUsers()
  - [ ] Implement GET /api/users/{id} endpoint calling userService.getUserById()
  - [ ] Implement PUT /api/users/{id} endpoint calling userService.updateUser()
  - [ ] Implement DELETE /api/users/{id} endpoint calling userService.deactivateUser()
  - [ ] Implement POST /api/users/{id}/change-password endpoint calling userService.changePassword()
  - [ ] Use @Valid annotation on request body parameters for validation
  - [ ] Use constructor injection for UserService dependency
  - [ ] Return appropriate HTTP status codes (200 OK, 201 Created, 204 No Content, 404 Not Found, 409 Conflict)

- [ ] **Task 4: Create custom exceptions for error handling** (AC: 5, 8)
  - [ ] Create ResourceNotFoundException.java in backend/src/main/java/com/magnab/employeelifecycle/exception/
  - [ ] Extend RuntimeException and include message constructor
  - [ ] Create ValidationException.java in backend/src/main/java/com/magnab/employeelifecycle/exception/
  - [ ] Extend RuntimeException with field-level error details support
  - [ ] Create ConflictException.java in backend/src/main/java/com/magnab/employeelifecycle/exception/
  - [ ] Extend RuntimeException for unique constraint violations (duplicate username/email)

- [ ] **Task 5: Implement audit logging for user operations** (AC: 9)
  - [ ] Add audit logging calls in UserService for createUser action (actionType: USER_CREATED)
  - [ ] Add audit logging calls in UserService for updateUser action (actionType: USER_UPDATED)
  - [ ] Add audit logging calls in UserService for deactivateUser action (actionType: USER_DEACTIVATED)
  - [ ] Add audit logging calls in UserService for changePassword action (actionType: USER_PASSWORD_CHANGED)
  - [ ] Use existing AuditService.logUserAction(userId, actionType, description, metadata) method
  - [ ] Include relevant metadata in audit logs (changed fields, initiating user)

- [ ] **Task 6: Manual testing of User Management API** (AC: 1-10)
  - [ ] Start backend with docker-compose up or mvn spring-boot:run
  - [ ] Test POST /api/users with valid data: verify 201 Created response with UserResponse DTO
  - [ ] Test POST /api/users with duplicate username: verify 409 Conflict response
  - [ ] Test POST /api/users with invalid email format: verify 400 Bad Request response
  - [ ] Test GET /api/users: verify 200 OK with list of users
  - [ ] Test GET /api/users/{id} with valid ID: verify 200 OK with UserResponse
  - [ ] Test GET /api/users/{id} with invalid ID: verify 404 Not Found
  - [ ] Test PUT /api/users/{id} updating email and role: verify 200 OK
  - [ ] Test DELETE /api/users/{id}: verify 204 No Content and is_active=false in database
  - [ ] Test POST /api/users/{id}/change-password with correct current password: verify 200 OK
  - [ ] Test POST /api/users/{id}/change-password with incorrect current password: verify 401 Unauthorized
  - [ ] Test all endpoints as non-HR_ADMIN user: verify 403 Forbidden responses
  - [ ] Verify audit_events table contains records for all user operations
  - [ ] Verify password_hash is never exposed in API responses
  - [ ] Test via Swagger UI at http://localhost:8080/swagger-ui.html

## Dev Notes

### Previous Story Insights (Story 1.4)
[Source: docs/stories/1.4.story.md - Dev Agent Record]

**Key Context from Story 1.4:**
- UserRepository already exists at `backend/src/main/java/com/magnab/employeelifecycle/repository/UserRepository.java` with methods:
  - `Optional<User> findByUsername(String username)`
  - `Optional<User> findByEmail(String email)`
  - `List<User> findByIsActive(Boolean isActive)`
- User entity already exists at `backend/src/main/java/com/magnab/employeelifecycle/entity/User.java` with fields:
  - id (UUID), username, email, passwordHash, role, isActive, createdAt, createdBy, updatedAt, updatedBy
- AuditService already exists with async logging methods:
  - `logAuthenticationAttempt(String username, boolean success, String ipAddress, UUID userId)`
  - `logLogout(String username, UUID userId)`
  - Need to add new method: `logUserAction(UUID userId, String actionType, String description, String metadata)`
- SecurityConfig already configured with BCryptPasswordEncoder(12) bean
- Spring Security configured with role-based access control (@PreAuthorize annotations working)
- CSRF protection enabled for non-GET requests
- Error response format standardized with timestamp, status, error, message, path fields

**Files from Story 1.4 that Story 1.5 will use:**
- `backend/src/main/java/com/magnab/employeelifecycle/entity/User.java` - User entity
- `backend/src/main/java/com/magnab/employeelifecycle/repository/UserRepository.java` - User repository
- `backend/src/main/java/com/magnab/employeelifecycle/enums/UserRole.java` - Role enum
- `backend/src/main/java/com/magnab/employeelifecycle/service/AuditService.java` - Extend with logUserAction method
- `backend/src/main/java/com/magnab/employeelifecycle/config/SecurityConfig.java` - PasswordEncoder bean

### Technology Stack
[Source: docs/architecture/tech-stack.md]

**Relevant Technologies for Story 1.5:**
- **Backend Framework:** Spring Boot 3.2.2 with Spring Security 6.2.1
- **Data Access:** Spring Data JPA 3.2.2 with Hibernate 6.4.2
- **Database:** PostgreSQL 17.2 (already configured)
- **Password Hashing:** BCrypt via Spring Security (work factor 12)
- **Validation:** Jakarta Bean Validation 3.0.2 (@Valid, @NotBlank, @NotNull, @Email)
- **Boilerplate Reduction:** Lombok 1.18.30 (@Data, @Service, @RestController)
- **API Documentation:** SpringDoc OpenAPI 2.3.0 (Swagger UI auto-generation)
- **Logging:** SLF4J 2.0.11 + Logback 1.4.14

### Data Models
[Source: docs/architecture/data-models.md]

**User Entity (already exists):**
- `id`: UUID - Primary key
- `username`: String (unique, indexed) - Login credential
- `email`: String (unique, indexed) - Contact and notification address
- `passwordHash`: String - BCrypt-hashed password (VARCHAR 255)
- `role`: UserRole enum (HR_ADMIN, LINE_MANAGER, TECH_SUPPORT, ADMINISTRATOR)
- `isActive`: Boolean (default true) - Soft delete flag
- `createdAt`, `createdBy`, `updatedAt`, `updatedBy` - Audit columns

**UserRole Enum Values:**
- HR_ADMIN - Can manage users and initiate workflows
- LINE_MANAGER - Can complete manager-assigned tasks
- TECH_SUPPORT - Can complete tech-assigned tasks
- ADMINISTRATOR - System administrator with full access

**Relationships:**
- One-to-Many: User → WorkflowInstance (as initiator)
- One-to-Many: User → TaskInstance (as assigned user)
- One-to-Many: User → AuditEvent (as actor)

### REST API Specification
[Source: docs/architecture/rest-api-spec.md]

**Base URL:** http://localhost:8080/api

**User Management Endpoints:**

**POST /api/users** (Create User)
- Request Body: `{"username": "string", "email": "string", "password": "string", "role": "HR_ADMIN|LINE_MANAGER|TECH_SUPPORT|ADMINISTRATOR"}`
- Response 201: `{"id": "uuid", "username": "string", "email": "string", "role": "string", "isActive": true, "createdAt": "timestamp", "updatedAt": "timestamp"}`
- Response 400: `{"timestamp": "ISO8601", "status": 400, "error": "Bad Request", "message": "Validation failed", "path": "/api/users"}`
- Response 409: `{"timestamp": "ISO8601", "status": 409, "error": "Conflict", "message": "Username already exists", "path": "/api/users"}`

**GET /api/users** (List All Users)
- Response 200: Array of UserResponse objects
- Includes both active and inactive users

**GET /api/users/{id}** (Get User by ID)
- Response 200: UserResponse object
- Response 404: `{"timestamp": "ISO8601", "status": 404, "error": "Not Found", "message": "User not found", "path": "/api/users/{id}"}`

**PUT /api/users/{id}** (Update User)
- Request Body: `{"email": "string", "role": "string", "isActive": boolean}`
- Response 200: Updated UserResponse object
- Response 404: User not found error

**DELETE /api/users/{id}** (Soft Delete User)
- Response 204: No Content (successful soft delete)
- Response 404: User not found error
- Sets is_active=false without removing database record

**POST /api/users/{id}/change-password** (Change Password)
- Request Body: `{"currentPassword": "string", "newPassword": "string"}`
- Response 200: `{"message": "Password changed successfully"}`
- Response 401: `{"timestamp": "ISO8601", "status": 401, "error": "Unauthorized", "message": "Current password is incorrect", "path": "/api/users/{id}/change-password"}`
- Response 404: User not found error

**Authorization:** All endpoints require HR_ADMIN role (enforced via @PreAuthorize annotation)

### File Locations and Naming
[Source: docs/architecture/source-tree.md]

**Backend Structure for Story 1.5:**
```
backend/src/main/java/com/magnab/employeelifecycle/
├── config/
│   └── SecurityConfig.java             # EXISTS from Story 1.4 (use PasswordEncoder bean)
├── controller/
│   ├── AuthController.java             # EXISTS from Story 1.4
│   └── UserController.java             # CREATE - User management REST endpoints
├── service/
│   ├── CustomUserDetailsService.java   # EXISTS from Story 1.4
│   ├── AuditService.java               # MODIFY - Add logUserAction method
│   └── UserService.java                # CREATE - User CRUD business logic
├── repository/
│   └── UserRepository.java             # EXISTS from Story 1.4
├── entity/
│   ├── User.java                       # EXISTS from Story 1.3
│   └── AuditEvent.java                 # EXISTS from Story 1.4
├── dto/
│   ├── request/
│   │   ├── LoginRequest.java           # EXISTS from Story 1.4
│   │   ├── CreateUserRequest.java      # CREATE - User creation DTO
│   │   ├── UpdateUserRequest.java      # CREATE - User update DTO
│   │   └── ChangePasswordRequest.java  # CREATE - Password change DTO
│   └── response/
│       ├── AuthResponse.java           # EXISTS from Story 1.4
│       └── UserResponse.java           # CREATE - User response DTO
├── exception/
│   ├── ResourceNotFoundException.java  # CREATE - 404 exception
│   ├── ValidationException.java        # CREATE - 400 validation exception
│   └── ConflictException.java          # CREATE - 409 conflict exception
└── enums/
    └── UserRole.java                   # EXISTS from Story 1.3
```

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Critical Rules:**
1. **Never log sensitive data** - No passwords or tokens in logs
2. **DTOs at API boundaries** - Never expose User entity in responses (use UserResponse DTO)
3. **Constructor injection** - All @Service and @RestController use final fields with constructor injection
4. **@Transactional at service layer** - Not on controllers
5. **Validate all inputs** - Use @Valid on CreateUserRequest, UpdateUserRequest, ChangePasswordRequest
6. **Specific exceptions** - Throw ResourceNotFoundException (404), ValidationException (400), ConflictException (409)
7. **Optional for nullable results** - UserRepository methods return Optional<User>
8. **Lombok for entities/DTOs** - Use @Data, @NoArgsConstructor, @AllArgsConstructor

**Naming Conventions:**
- Controllers: EntityController (UserController)
- Services: EntityService (UserService)
- Repositories: EntityRepository (UserRepository)
- DTOs: ActionEntityRequest/Response (CreateUserRequest, UserResponse)
- Exceptions: PurposeException (ResourceNotFoundException)

### Error Handling
[Source: docs/architecture/error-handling-strategy.md]

**Error Response Model:**
```java
@Data
@AllArgsConstructor
public class ErrorResponse {
    private LocalDateTime timestamp;
    private int status;
    private String error;
    private String message;
    private String path;
}
```

**Custom Exceptions to Create:**
```java
public class ResourceNotFoundException extends RuntimeException {
    public ResourceNotFoundException(String message) {
        super(message);
    }
}

public class ValidationException extends RuntimeException {
    public ValidationException(String message) {
        super(message);
    }
}

public class ConflictException extends RuntimeException {
    public ConflictException(String message) {
        super(message);
    }
}
```

**Note:** Global exception handler (@RestControllerAdvice) will be created in Story 1.4b. For Story 1.5, custom exceptions should be thrown and will return default Spring error responses. Full centralized error handling will be added in future story.

**User Service Error Scenarios:**
- Username already exists: Throw ConflictException("Username already exists")
- Email already exists: Throw ConflictException("Email already exists")
- User not found: Throw ResourceNotFoundException("User not found with id: " + id)
- Invalid current password: Throw ValidationException("Current password is incorrect")

### Security Configuration
[Source: docs/architecture/tech-stack.md, docs/stories/1.4.story.md]

**Role-Based Access Control:**
```java
@RestController
@RequestMapping("/api/users")
@PreAuthorize("hasRole('HR_ADMIN')")
public class UserController {
    // All methods automatically protected
    // Non-HR_ADMIN users get 403 Forbidden
}
```

**Password Hashing (BCrypt):**
```java
@Service
public class UserService {
    private final PasswordEncoder passwordEncoder;

    public UserResponse createUser(CreateUserRequest request) {
        String hashedPassword = passwordEncoder.encode(request.getPassword());
        user.setPasswordHash(hashedPassword);
        // ...
    }

    public void changePassword(UUID id, ChangePasswordRequest request) {
        boolean passwordMatches = passwordEncoder.matches(
            request.getCurrentPassword(),
            user.getPasswordHash()
        );
        if (!passwordMatches) {
            throw new ValidationException("Current password is incorrect");
        }
        // ...
    }
}
```

**Audit Column Population:**
```java
// Get current authenticated user
Authentication auth = SecurityContextHolder.getContext().getAuthentication();
String currentUsername = auth.getName();
User currentUser = userRepository.findByUsername(currentUsername).orElseThrow();

// Set audit fields
user.setCreatedBy(currentUser.getId());
user.setCreatedAt(LocalDateTime.now());
// For updates:
user.setUpdatedBy(currentUser.getId());
user.setUpdatedAt(LocalDateTime.now());
```

### Audit Logging
[Source: docs/stories/1.4.story.md - Dev Agent Record]

**Extend AuditService with User Action Logging:**

The existing AuditService needs a new method for user management operations:

```java
@Async
@Transactional
public void logUserAction(UUID userId, String actionType, String description, String metadata) {
    try {
        AuditEvent event = new AuditEvent();
        event.setUserId(userId);
        event.setActionType(actionType);
        event.setEntityType("USER");
        event.setDescription(description);
        event.setMetadata(metadata);
        event.setTimestamp(LocalDateTime.now());

        auditEventRepository.save(event);
        log.info("User action logged: {} for user {}", actionType, userId);
    } catch (Exception e) {
        log.error("Failed to log user action", e);
    }
}
```

**Action Types for User Operations:**
- USER_CREATED - When HR creates new user
- USER_UPDATED - When HR updates user details
- USER_DEACTIVATED - When HR deactivates user
- USER_PASSWORD_CHANGED - When user password is changed

## Testing

### Testing Approach for This Story
[Source: docs/architecture/test-strategy.md]

**Important Note:** Story 1.8 will set up the complete testing framework with JUnit 5, Mockito, and TestContainers. For Story 1.5, testing is **manual verification only** via Swagger UI and Postman:

**Manual Testing Steps:**

1. **Create User (POST /api/users):**
   - Login as HR_ADMIN user (use admin account from Story 1.4)
   - Use Postman or Swagger UI to POST /api/users
   - Request: `{"username":"testuser","email":"test@magnab.com","password":"Test123!","role":"LINE_MANAGER"}`
   - Verify response status 201 with UserResponse DTO (no password_hash exposed)
   - Verify audit_events table has USER_CREATED record

2. **Duplicate Username Test:**
   - Attempt to create user with same username
   - Verify response status 409 Conflict
   - Verify error message: "Username already exists"

3. **Invalid Email Test:**
   - POST /api/users with invalid email format
   - Request: `{"username":"testuser2","email":"notanemail","password":"Test123!","role":"TECH_SUPPORT"}`
   - Verify response status 400 Bad Request
   - Verify validation error message about email format

4. **Get All Users (GET /api/users):**
   - GET /api/users with HR_ADMIN credentials
   - Verify response status 200 with array of UserResponse objects
   - Verify both active and inactive users are included

5. **Get User by ID (GET /api/users/{id}):**
   - GET /api/users/{valid-uuid} with HR_ADMIN credentials
   - Verify response status 200 with UserResponse object
   - GET /api/users/{invalid-uuid}
   - Verify response status 404 Not Found

6. **Update User (PUT /api/users/{id}):**
   - PUT /api/users/{id} with updated email and role
   - Request: `{"email":"updated@magnab.com","role":"TECH_SUPPORT","isActive":true}`
   - Verify response status 200 with updated UserResponse
   - Verify audit_events table has USER_UPDATED record

7. **Soft Delete User (DELETE /api/users/{id}):**
   - DELETE /api/users/{id} with HR_ADMIN credentials
   - Verify response status 204 No Content
   - Query database: `SELECT * FROM users WHERE id = '{id}';`
   - Verify is_active=false (record still exists)
   - Verify audit_events table has USER_DEACTIVATED record

8. **Change Password (POST /api/users/{id}/change-password):**
   - POST /api/users/{id}/change-password with correct current password
   - Request: `{"currentPassword":"Test123!","newPassword":"NewPass456!"}`
   - Verify response status 200
   - Attempt login with new password to confirm change worked
   - POST with incorrect current password
   - Verify response status 401 Unauthorized

9. **Role-Based Access Control:**
   - Logout HR_ADMIN user
   - Login as LINE_MANAGER user
   - Attempt GET /api/users
   - Verify response status 403 Forbidden
   - Repeat for TECH_SUPPORT and verify 403 Forbidden

10. **Password Hash Not Exposed:**
   - For all GET operations (list users, get by ID)
   - Verify password_hash field is never present in JSON responses
   - Only UserResponse fields should be returned

**Swagger UI Testing:**
- Navigate to http://localhost:8080/swagger-ui.html
- Authenticate using /api/auth/login endpoint
- Use "Try it out" feature to test all /api/users endpoints
- Verify Swagger documentation matches expected request/response formats

**Automated Testing:** Will be added in Story 1.8 with JUnit 5, Mockito, and TestContainers for comprehensive integration tests

**Test Coverage Goals for Future (Story 1.8):**
- Unit tests: UserService (mock UserRepository, PasswordEncoder)
- Integration tests: UserController endpoints with TestContainers PostgreSQL
- Security tests: Role-based access control, password validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Story created from Epic 1 with comprehensive architecture context and detailed tasks | Bob (Scrum Master) |
| 2025-10-30 | 1.1 | Story validated and approved for implementation (Readiness Score: 9.5/10, HIGH confidence, no blockers identified) | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent after story completion_
